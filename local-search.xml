<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>MIT6.S081 OS Labå®Œç»“ğŸ‰</title>
    <link href="/2021/07/11/MIT6-S081-OS-Lab%E5%AE%8C%E7%BB%93/"/>
    <url>/2021/07/11/MIT6-S081-OS-Lab%E5%AE%8C%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©ç»ˆäºæ­£å¼å®Œæˆäº†MIT6.S081æ“ä½œç³»ç»Ÿçš„å…¨éƒ¨å®éªŒï¼Œæ–­æ–­ç»­ç»­èŠ±äº†åŠå¹´ä¹‹ä¹…ã€‚</p><p>è™½ç„¶è¯¾ç¨‹ååŠéƒ¨åˆ†çš„è®ºæ–‡è¯¾è¿˜éƒ½æ²¡çœ‹ğŸ¤£ï¼Œä¹‹åè¡¥ä¸Šã€‚</p><p>å­¦è¿‡è¿™é—¨è¯¾ç¨‹åå¯¹OSç»ˆäºä¸å†æ˜¯é™Œç”Ÿå’Œé›¶æ˜Ÿçš„æ¦‚å¿µäº†ï¼Œæœç„¶è¿˜æ˜¯åªæœ‰äº²è‡ªå®è·µæ‰èƒ½å­¦ä¼šï¼Œè¿™æ ·çœ‹æ¥æœ¬ç§‘å­¦çš„OSå…¶å®æ ¹æœ¬å°±æ²¡å­¦æ‡‚ï¼Œæ¦‚å¿µè®°äº†ä¸€å †ï¼Œä½†æ˜¯å®é™…çš„å®ç°å´æ ¹æœ¬ä¸æ‡‚ã€‚åœ¨åšè¿™äº›Labè¿‡ç¨‹ä¸­éœ€è¦ä¸æ–­åœ°é˜…è¯»æºç ï¼Œå¯¹æ•´ä¸ªxv6æœ‰ä¸€ä¸ªæ¸…æ™°çš„è®¤è¯†ï¼Œèƒ½å¤ŸæŠŠç†è®ºä¸å®è·µç›¸å…³è”è¿˜æ˜¯éå¸¸çˆ½çš„ã€‚</p><p>å›æƒ³è¿™äº›å®éªŒå…¶å®è¿˜æ˜¯æœ‰äº›éš¾åº¦çš„ï¼Œæœ‰çš„å®éªŒè¦æ‰£å¥½ä¹…ï¼Œæ¯”å¦‚è¯´é¡µè¡¨å®éªŒã€é”å®éªŒï¼Œç»å¸¸å‡ºç°panicï¼Œåªèƒ½æ·»åŠ å¾ˆå¤šæ¡è°ƒè¯•è¯­å¥æ…¢æ…¢debugï¼Œå¾ˆè€ƒéªŒäººçš„è€å¿ƒã€‚ä¸è¿‡å¥½åœ¨åŸºæœ¬æ‰€æœ‰çš„å®éªŒéƒ½æ˜¯è‡ªå·±ç‹¬ç«‹å®Œæˆçš„ï¼Œå½“ç„¶æœ‰äº›ä¹Ÿå‚è€ƒäº†ç½‘ä¸Šçš„ä»£ç ï¼Œè¿˜æ˜¯å­¦åˆ°äº†å¾ˆå¤šä¸œè¥¿ï¼Œæœ‰äº›ç»†èŠ‚ä¸æ³¨æ„å¯èƒ½å°±è¦èŠ±æ›´å¤šçš„æ—¶é—´è§£å†³äº†ã€‚</p><p>Xv6åº”è¯¥è¿˜æ˜¯æˆ‘é˜…è¯»çš„ç¬¬ä¸€ä¸ªå¼€æºä»£ç ï¼Œé‡Œé¢è¿˜æ˜¯æœ‰å¾ˆå¤šå·¥ç¨‹ä»£ç æ–¹é¢çš„è®¾è®¡å¾ˆå€¼å¾—æ·±å…¥å­¦ä¹ ï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿã€æ—¥å¿—ã€ç½‘ç»œåè®®æ ˆã€‚Xv6å¯è°“éº»é›€è™½å°äº”è„ä¿±å…¨ï¼Œåªç”¨ååˆ†ç²¾ç®€çš„ä»£ç å°±å®ç°äº†ä¸€ä¸ªOSï¼Œä¹‹åè¿˜æ˜¯è¦å¤šçœ‹ã€‚</p><p>å½“ç„¶è¿™é—¨è¯¾åº”è¯¥åªæ˜¯OSå­¦ä¹ ä¹‹è·¯çš„èµ·ç‚¹ï¼Œä¹‹åä¹Ÿæ›´å¤šå…³æ³¨ä¸å­¦ä¹ Linuxçš„å®ç°ï¼ŒLinuxä¹Ÿæ›´åŠ å®Œæ•´ä¸å·¥ç¨‹åŒ–ï¼Œè¿™é—¨è¯¾åº”è¯¥ä¹Ÿä¸ºåç»­çš„å­¦ä¹ åšäº†éå¸¸å¥½çš„é“ºå«ã€‚</p><p>æœ€åï¼Œè¿™é—¨è¯¾ä¹Ÿæ˜¯æˆ‘å®Œæˆçš„ç¬¬ä¸€é—¨é«˜è´¨é‡çš„CSå…¬å¼€è¯¾ï¼Œæ€»ä½“åšçš„è¿˜æ˜¯æ¯”è¾ƒæ…¢çš„ï¼Œå¸Œæœ›ä¹‹åçš„å­¦ä¹ èƒ½å¤Ÿå¿«é€Ÿè¿­ä»£ã€‚</p><p>å†æ¬¡æ’’èŠ±å®Œç»“ å“ˆå“ˆğŸ‰ğŸ‰ğŸ‰</p><p>Next ?   è¯¥CMU15-445/645å’ŒMIT 6.824äº†ğŸ’ª</p>]]></content>
    
    
    <categories>
      
      <category>OS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6.S081-Lab11: networking</title>
    <link href="/2021/07/11/6-S081-Lab11-networking/"/>
    <url>/2021/07/11/6-S081-Lab11-networking/</url>
    
    <content type="html"><![CDATA[<h2 id="Lab11-networking"><a href="#Lab11-networking" class="headerlink" title="Lab11: networking"></a>Lab11: networking</h2><p>Lab11ä¸ºxv6ç¼–å†™ç½‘å¡é©±åŠ¨ï¼Œä½¿å¾—ç½‘ç»œåè®®æ ˆï¼ˆIPã€UDPã€ARPï¼‰èƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚</p><h4 id="networking"><a href="#networking" class="headerlink" title="networking"></a>networking</h4><h5 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h5><ol><li>å®ç°<code>e1000_transmit()</code></li></ol><p><code>e1000_transmit()</code>å‡½æ•°æ¥æ”¶ä¸€mbufï¼ŒmbufåŒ…å«äº†å°†è¦å‘é€çš„ä»¥å¤ªç½‘å¸§ã€‚ç”±äºç½‘å¡é‡‡ç”¨DMAä¼ è¾“æ•°æ®ï¼Œè¦å‘é€æ•°æ®å¸§ï¼Œè¦å‘Šè¯‰DMAæ§åˆ¶å™¨æ•°æ®å¸§çš„èµ·å§‹å†…å­˜åœ°å€å’Œé•¿åº¦ã€‚å› æ­¤å†…å­˜ä¸­ç»´æŠ¤äº†<code>tx_ring</code>ç¯å½¢ä¼ é€æè¿°é˜Ÿåˆ—ï¼Œç½‘å¡å¯„å­˜å™¨ç»´æŠ¤äº†<code>E1000_TDH</code>ä½œä¸ºé˜Ÿåˆ—å¤´æŒ‡é’ˆï¼Œ<code>E1000_TDT</code>ä½œä¸ºé˜Ÿåˆ—å°¾æŒ‡é’ˆï¼Œç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210711171635.png" alt="image-20210711171628026" style="zoom: 50%;" /><p>åˆå§‹åŒ–æ—¶æ‰€æœ‰é˜Ÿåˆ—ä¸­çš„æè¿°ç¬¦çŠ¶æ€å‡è®¾ä¸º<code>E1000_TXD_STAT_DD</code>ï¼Œæ ¹æ®æç¤ºï¼Œå½“tailçš„<code>E1000_TXD_STAT_DD</code>ä¸º0æ—¶ï¼Œä»£è¡¨ç½‘å¡è¿˜æœªå–èµ°è¯¥å¸§æ•°æ®ï¼Œåˆ™å½“å‰é˜Ÿåˆ—æ»¡äº†ï¼Œè¿”å›é”™è¯¯ã€‚</p><p>ç½‘å¡æ¯æ¬¡ä¼šä»headå¤„å–æ•°æ®ï¼Œå–å®Œæ•°æ®å°†<code>E1000_TXD_STAT_DD</code>çŠ¶æ€è®¾ä¸º1ï¼Œä»£è¡¨ä¼ é€å®Œæˆï¼Œä½†æ˜¯åªæœ‰åœ¨æè¿°ç¬¦æ‹¥æœ‰<code>E1000_TXD_CMD_RS</code>å‘½ä»¤æ—¶æ‰è®¾ç½®<code>E1000_TXD_STAT_DD</code>ã€‚</p><p>æ­¤å¤–ä»¥å¤ªç½‘å¸§çš„MTUä¸º1500ï¼Œä¸€ä¸ªç¼“å†²åŒºçš„å¤§å°ä¸º2048ï¼Œå› æ­¤ä¸éœ€è¦è¿›è¡Œå¸§çš„åˆ’åˆ†ï¼Œå› æ­¤æ¯ä¸ªä¼ é€æ•°æ®çš„æè¿°å‘½ä»¤åº”åŠ ä¸Š<code>E1000_TXD_CMD_EOP</code>ï¼Œä»£è¡¨æ•°æ®åŒ…çš„ç»“æŸã€‚</p><p>å¯èƒ½å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨<code>e1000_transmit()</code>æ¥ä¼ é€æ•°æ®ï¼Œéœ€è¦ä¸ºå…¶åŠ é”äº’æ–¥è®¿é—®ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">e1000_transmit</span><span class="hljs-params">(struct mbuf *m)</span></span><br><span class="hljs-function"></span>&#123;<br>  acquire(&amp;e1000_lock);<br><br>  <span class="hljs-keyword">int</span> tail = regs[E1000_TDT];<br>  <span class="hljs-keyword">if</span>(!(tx_ring[tail].status &amp; E1000_TXD_STAT_DD))&#123;<br>    release(&amp;e1000_lock);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span>(tx_mbufs[tail])<br>    mbuffree(tx_mbufs[tail]);<br>  <br>  <span class="hljs-built_in">memset</span>(&amp;tx_ring[tail], <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(struct tx_desc));<br>  tx_ring[tail].cmd = (E1000_TXD_CMD_EOP | E1000_TXD_CMD_RS);<br>  tx_ring[tail].addr = (uint64)m-&gt;head;<br>  tx_ring[tail].length = m-&gt;len;<br>  tx_mbufs[tail] = m;<br><br>  regs[E1000_TDT] = (tail + <span class="hljs-number">1</span>) % TX_RING_SIZE;<br>  <br>  release(&amp;e1000_lock);<br> <br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>å®ç°å®ç°<code>e1000_recv()</code></li></ol><p>ç½‘å¡æ¥æ”¶åˆ°æ•°æ®å¹¶æ ¹æ®<code>rx_ring</code>ç¯å½¢æ¥æ”¶æè¿°é˜Ÿåˆ—å°†æ•°æ®é€šè¿‡DMAä¼ é€åˆ°å†…å­˜æŒ‡å®šä½ç½®ï¼Œè®¾ç½®<code>E1000_RXD_STAT_DD</code>æ ‡è®°ï¼Œå¹¶äº§ç”Ÿä¸­æ–­ï¼Œ<code>e1000_recv()</code>è¢«è°ƒç”¨ã€‚</p><p>è¯¥å‡½æ•°éœ€è¦æ‰«æ<code>rx_ring</code>ä¼ é€’æ¯ä¸€ä¸ªæ¥æ”¶åˆ°çš„åŒ…åˆ°ç½‘ç»œåè®®æ ˆï¼Œè°ƒç”¨<code>net_rx()</code>å‡½æ•°ä¼ é€ï¼Œä¹‹ååº”è¯¥åˆ†é…ä¸€ä¸ªæ–°çš„ç¼“å†²åŒºæ›¿æ¢åˆ°ç›¸åº”æè¿°ç¬¦ä¸­ã€‚</p><p><code>e1000_transmit()</code>å’Œ<code>e1000_recv()</code>å¹¶ä¸å…±äº«æ•°æ®ç»“æ„ï¼Œç›¸äº’ç‹¬ç«‹ï¼Œä¸ä¼šç›¸äº’å½±å“ï¼Œå› æ­¤å¯ä»¥ä¸º<code>e1000_recv()</code>å•ç‹¬åŠ ä¸Šå¦ä¸€æŠŠé”ï¼Œé˜²æ­¢åœ¨ä¸€ä¸ªçº¿ç¨‹åœ¨<code>e1000_recv()</code>æ‰§è¡Œæ—¶ï¼Œå¦å¤–ä¸€ä¸ªCPUäº§ç”Ÿäº†<code>e1000_intr</code>ä¸­æ–­ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spinlock</span> <span class="hljs-title">e1000_lockrx</span>;</span><br><br><span class="hljs-comment">// e1000_init()</span><br>initlock(&amp;e1000_lockrx, <span class="hljs-string">&quot;e1000_rx&quot;</span>);<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">e1000_recv</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  acquire(&amp;e1000_lockrx);<br><br>  <span class="hljs-keyword">int</span> i = (regs[E1000_RDT] + <span class="hljs-number">1</span>) % RX_RING_SIZE;<br>  <span class="hljs-keyword">while</span>(rx_ring[i].status &amp; E1000_RXD_STAT_DD)&#123;<br>    rx_mbufs[i]-&gt;len = rx_ring[i].length;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mbuf</span> *<span class="hljs-title">rb</span> =</span> rx_mbufs[i];<br><br>    rx_mbufs[i] = mbufalloc(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (!rx_mbufs[i])<br>      panic(<span class="hljs-string">&quot;e1000&quot;</span>);<br>    rx_ring[i].addr = (uint64) rx_mbufs[i]-&gt;head;<br>    rx_ring[i].status = <span class="hljs-number">0</span>;<br>    regs[E1000_RDT] = i;<br><br>    net_rx(rb);<br><br>    i = (regs[E1000_RDT] + <span class="hljs-number">1</span>) % RX_RING_SIZE;<br>  &#125;<br><br>  release(&amp;e1000_lockrx);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å®éªŒæµ‹è¯•"><a href="#å®éªŒæµ‹è¯•" class="headerlink" title="å®éªŒæµ‹è¯•"></a>å®éªŒæµ‹è¯•</h4><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210711175600.png" alt="image-20210711175600483"></p><h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><p><a href="https://github.com/whileskies/xv6-labs-2020/tree/net">https://github.com/whileskies/xv6-labs-2020/tree/net</a></p>]]></content>
    
    
    <categories>
      
      <category>OS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6.S081-Lab10: mmap</title>
    <link href="/2021/07/11/6-S081-Lab10-mmap/"/>
    <url>/2021/07/11/6-S081-Lab10-mmap/</url>
    
    <content type="html"><![CDATA[<h2 id="Lab10-mmap"><a href="#Lab10-mmap" class="headerlink" title="Lab10: mmap"></a>Lab10: mmap</h2><p>Lab10éœ€è¦ä¸ºxv6å®ç°ç®€æ˜“ç‰ˆçš„mmapå’Œmunmapç³»ç»Ÿè°ƒç”¨ï¼Œmmapå…è®¸å¯¹è¿›ç¨‹çš„åœ°å€ç©ºé—´è¿›è¡Œè¯¦ç»†æ§åˆ¶ï¼Œå¯ä»¥ç”¨æ¥è¿›ç¨‹é—´å…±äº«å†…å­˜ã€å°†æ–‡ä»¶æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ç­‰ï¼Œæœ¬labä»…ä»…å®ç°å†…å­˜æ˜ å°„æ–‡ä»¶ã€‚</p><h4 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h4><h5 id="ä»»åŠ¡"><a href="#ä»»åŠ¡" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>mmapçš„æ¥å£æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">mmap</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *addr, <span class="hljs-keyword">size_t</span> length, <span class="hljs-keyword">int</span> prot, <span class="hljs-keyword">int</span> flags, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">off_t</span> offset)</span></span><br></code></pre></td></tr></table></figure><p>åœ¨æœ¬labä¸­å‡è®¾addræ€»æ˜¯0ï¼Œç”±å†…æ ¸å†³å®šæ‰€æ˜ å°„æ–‡ä»¶çš„è™šæ‹Ÿåœ°å€ï¼Œå½“è¿”å›0xffffffffffffffff ä»£è¡¨å¤±è´¥ï¼›lengthæ˜¯æ˜ å°„çš„å­—èŠ‚æ•°ï¼Œå¯èƒ½å’Œæ–‡ä»¶å¤§å°ä¸ä¸€è‡´ï¼›protè¡¨ç¤ºè¢«æ˜ å°„çš„å†…å­˜æ˜¯å¦å¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œï¼Œå¯ä»¥å‡è®¾protæ˜¯å¯è¯»ã€å¯å†™æˆ–å¯è¯»å¯å†™çš„ï¼›flagsè¦ä¹ˆæ˜¯MAP_SHAREDï¼Œè¡¨ç¤ºå¯¹äºæ‰€æ˜ å°„å†…å­˜çš„ä¿®æ”¹åº”è¯¥å†™å›æ–‡ä»¶ï¼Œè¦ä¹ˆæ˜¯MAP_PRIVATEï¼Œè¡¨ç¤ºä¸ç”¨å†™å›æ–‡ä»¶ï¼Œä¸ç”¨è€ƒè™‘å…¶ä»–çš„bitsï¼›fdæ˜¯è¢«æ˜ å°„æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼›offsetæ˜¯æ–‡ä»¶çš„åç§»ï¼Œå¯ä»¥å‡å®šæ€»ä¸º0ï¼ˆæ˜ å°„æ–‡ä»¶æ—¶æ€»æ˜¯ä»æ–‡ä»¶èµ·å§‹è¿›è¡Œæ˜ å°„ï¼‰ã€‚</p><p>å¦‚æœå¤šä¸ªè¿›ç¨‹æ˜ å°„åŒä¸€MAP_SHAREDæ–‡ä»¶ï¼Œå¯ä»¥ä¸ç”¨å®ç°å…±äº«åŒä¸€ç‰©ç†é¡µã€‚</p><p>munmapçš„æ¥å£æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">munmap</span><span class="hljs-params">(uint64 addr, <span class="hljs-keyword">int</span> length)</span></span><br></code></pre></td></tr></table></figure><p>munmapåº”è¯¥ç§»é™¤åœ¨å‚æ•°æŒ‡å®šèŒƒå›´çš„mmapæ˜ å°„ï¼Œå¦‚æœè¿›ç¨‹ä¿®æ”¹äº†æ˜ å°„çš„å†…å­˜ï¼Œå¹¶ä¸”æ˜¯MAP_SHAREDçš„ï¼Œä¿®æ”¹åº”è¯¥é¦–å…ˆå†™å›æ–‡ä»¶ï¼›å¯ä»¥å‡å®šmunmapå–æ¶ˆæ˜ å°„çš„èŒƒå›´è¦ä¹ˆèµ·å§‹äºæ˜ å°„åŒºåŸŸçš„å¼€å§‹ï¼Œè¦ä¹ˆç»“æŸä¸æ˜ å°„åŒºåŸŸçš„ç»“å°¾ï¼Œè¦ä¹ˆæ•´ä¸ªåŒºåŸŸï¼Œä¹Ÿå³ä¸ä¼šæ˜¯æ•´ä¸ªæ˜ å°„åŒºåŸŸä¸­æ‰“ä¸€ä¸ªå­”ï¼Œå°†å‰©ä½™çš„æ˜ å°„åŒºåŸŸåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ã€‚</p><h5 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h5><ol><li>å®šä¹‰VMA</li></ol><p>ä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¤šæ¬¡è°ƒç”¨mmapæ˜ å°„å¤šä¸ªæ–‡ä»¶ï¼Œå› æ­¤è¿›ç¨‹åº”è®°å½•æ¯ä¸€æ¬¡æ‰€æ˜ å°„çš„è™šæ‹Ÿåœ°å€åŒºåŸŸï¼Œå®šä¹‰vmaä»£è¡¨è¿›ç¨‹è™šæ‹Ÿåœ°å€æ˜ å°„çš„ä¸€ä¸ªåŒºåŸŸï¼Œå­—æ®µåŒ…æ‹¬æ˜¯å¦è¢«ä½¿ç”¨ã€åŒºåŸŸçš„èµ·å§‹åœ°å€ã€ç»“æŸåœ°å€ã€æ–‡ä»¶æè¿°ç¬¦ã€æƒé™ç­‰ã€‚</p><p>æ¯ä¸ªè¿›ç¨‹åŒ…å«å¤šä¸ªVMAï¼Œæœ€å¤§ä¸º16ä¸ªï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// param.h</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NVMA         16    <span class="hljs-comment">// maximum number of vma</span></span><br><br><span class="hljs-comment">// proc.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> &#123;</span><br>  <span class="hljs-keyword">int</span> used;<br>  uint64 addr;<br>  <span class="hljs-keyword">int</span> length;<br>  <span class="hljs-keyword">int</span> permissions;<br>  <span class="hljs-keyword">int</span> flags;<br>  <span class="hljs-keyword">int</span> offset;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">f</span>;</span><br>  uint64 start;<br>  uint64 end;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> &#123;</span><br>  <span class="hljs-comment">// çœç•¥</span><br>  <span class="hljs-keyword">char</span> name[<span class="hljs-number">16</span>];               <span class="hljs-comment">// Process name (debugging)</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> <span class="hljs-title">vmas</span>[<span class="hljs-title">NVMA</span>];</span>       <span class="hljs-comment">// Virtual Memory Area</span><br>&#125;;<br></code></pre></td></tr></table></figure><ol start="2"><li>å®ç°mmap</li></ol><p><code>mmap()</code>å®ç°ä¸ºä¸€ç³»ç»Ÿè°ƒç”¨ï¼Œé¦–å…ˆè¯»å–ç³»ç»Ÿè°ƒç”¨å‚æ•°ï¼Œå¦‚æœè¯¥mmapæ˜¯MAP_SHAREDçš„ï¼Œä½†æ˜¯æ˜ å°„å†…å­˜æ ‡å¿—ä¸ºä¸å¯å†™çš„ï¼Œåˆ™è¿”å›é”™è¯¯ã€‚</p><p>ä»VMAæ•°ç»„ä¸­å¯»æ‰¾ä¸€æœªä½¿ç”¨çš„VMAï¼Œä¹‹åç¡®å®šæ˜ å°„çš„èµ·å§‹åœ°å€ï¼Œèµ·å§‹åœ°å€ä¸ºå·²ä½¿ç”¨çš„VMAä¸­æœ€å¤§ç»“æŸåœ°å€ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸ºVMA_BASEï¼ˆ4GBå¼€å§‹ï¼‰ï¼Œä¹‹åè®¾ç½®VMAå³å¯ï¼Œè¿™é‡Œæ˜ å°„çš„åŒºåŸŸåœ°å€èŒƒå›´ä¸º[start, end)ï¼Œå·¦é—­å³å¼€ã€‚</p><p>ç”±äºmmapè°ƒç”¨ä½¿ç”¨äº†æ–‡ä»¶ï¼Œå› æ­¤åº”è¯¥ä¸ºè¯¥æ–‡ä»¶çš„å¼•ç”¨è®¡æ•°+1ï¼Œé˜²æ­¢è¯¥æ–‡ä»¶å˜é‡è¢«å›æ”¶ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// sysfile.c</span><br><span class="hljs-function">uint64</span><br><span class="hljs-function"><span class="hljs-title">sys_mmap</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> i;<br>  uint64 addr;<br>  <span class="hljs-keyword">int</span> prot, flags, length, offset;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">f</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> *<span class="hljs-title">a</span> =</span> <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">if</span>(argaddr(<span class="hljs-number">0</span>, &amp;addr) || argint(<span class="hljs-number">1</span>, &amp;length) || argint(<span class="hljs-number">2</span>, &amp;prot) ||<br>    argint(<span class="hljs-number">3</span>, &amp;flags) || argfd(<span class="hljs-number">4</span>, <span class="hljs-number">0</span>, &amp;f) &lt; <span class="hljs-number">0</span> || argint(<span class="hljs-number">5</span>, &amp;offset) &lt; <span class="hljs-number">0</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  <br>  <span class="hljs-keyword">if</span>((flags &amp; MAP_SHARED) &amp;&amp; !f-&gt;writable &amp;&amp; (prot &amp; PROT_WRITE))<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; NVMA; i++)&#123;<br>    <span class="hljs-keyword">if</span>(!p-&gt;vmas[i].used)&#123;<br>      a = &amp;p-&gt;vmas[i];<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(a == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  uint64 maxend = VMA_BASE;<br>  <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; NVMA; i++)&#123;<br>    <span class="hljs-keyword">if</span>(p-&gt;vmas[i].used &amp;&amp; p-&gt;vmas[i].end &gt; maxend)<br>      maxend = p-&gt;vmas[i].end;<br>  &#125;<br>  <br>  a-&gt;used = <span class="hljs-number">1</span>;<br>  a-&gt;start = maxend;<br>  a-&gt;end = PGROUNDUP(a-&gt;start + length);<br>  a-&gt;addr = a-&gt;start;<br>  a-&gt;length = a-&gt;end - a-&gt;start;<br>  a-&gt;f = f;<br>  a-&gt;offset = offset;<br>  a-&gt;permissions = prot;<br>  a-&gt;flags = flags;<br><br>  filedup(f);<br><br>  <span class="hljs-keyword">return</span> a-&gt;start;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>å®ç°mmapç¼ºé¡µä¸­æ–­å¤„ç†</li></ol><p>ä¸Šé¢çš„mmapç³»ç»Ÿè°ƒç”¨åªæ˜¯ä¸ºè¿›ç¨‹æ ‡è®°äº†æ˜ å°„åŒºåŸŸï¼Œå®é™…ä¸Šå¹¶æœªæ˜ å°„ç‰©ç†å†…å­˜ï¼Œè¿™é‡Œä»ç„¶æ˜¯lazyåˆ†é…çš„æ€æƒ³ï¼Œç­‰åˆ°è¿›ç¨‹å®é™…è®¿é—®æ˜ å°„åŒºåŸŸæ—¶ï¼Œäº§ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œå†ä¸ºæ‰€ç¼ºçš„è™šæ‹Ÿé¡µåˆ†é…ç‰©ç†é¡µï¼Œé€šè¿‡é¡µè¡¨å»ºç«‹æ˜ å°„ï¼Œå¹¶è¯»å–æ–‡ä»¶åˆ°ç‰©ç†é¡µä¸­ï¼Œä¸­æ–­è¿”å›åè¿›ç¨‹å†æ¬¡è®¿é—®è¯¥åœ°å€å¯æ­£å¸¸è®¿é—®è¯¥æ–‡ä»¶çš„æ˜ å°„ã€‚</p><p>è¯»å–æ–‡ä»¶æ—¶çš„åç§»åº”ä¸ºè¯¥æ–‡ä»¶åœ¨vmaä¸­èµ·å§‹åç§» + è¯¥é¡µä¸vmaèµ·å§‹é¡µçš„åç§»ã€‚</p><p>ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vm.c</span><br><span class="hljs-comment">// Mmap pages does not exist, page fault will occur.</span><br><span class="hljs-comment">// Alloc a physical page and read the file to it.</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> </span><br><span class="hljs-function"><span class="hljs-title">mmap_pgfault</span><span class="hljs-params">(uint64 stval, struct proc *p)</span></span><br><span class="hljs-function"></span>&#123;<br>  stval = PGROUNDDOWN(stval);<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> *<span class="hljs-title">a</span> =</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// Which vma?</span><br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NVMA; i++)&#123;<br>    <span class="hljs-keyword">if</span>(p-&gt;vmas[i].used &amp;&amp; stval &gt;= p-&gt;vmas[i].start &amp;&amp; stval &lt; p-&gt;vmas[i].end)&#123;<br>      a = &amp;p-&gt;vmas[i];<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(a == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-keyword">char</span> *pa = kalloc();<br>  <span class="hljs-keyword">if</span>(pa == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  <span class="hljs-built_in">memset</span>(pa, <span class="hljs-number">0</span>, PGSIZE);<br><br>  <span class="hljs-keyword">int</span> perm = PTE_U;<br>  <span class="hljs-keyword">if</span>(a-&gt;permissions &amp; PROT_READ)<br>    perm |= PTE_R;<br>  <span class="hljs-keyword">if</span>(a-&gt;permissions &amp; PROT_WRITE)<br>    perm |= PTE_W;<br>  <span class="hljs-keyword">if</span>(mappages(p-&gt;pagetable, PGROUNDDOWN(stval), PGSIZE, (uint64)pa, perm) != <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  <br>  uint64 off = stval - a-&gt;start + a-&gt;offset;<br>  ilock(a-&gt;f-&gt;ip);<br>  <span class="hljs-keyword">if</span>(readi(a-&gt;f-&gt;ip, <span class="hljs-number">0</span>, (uint64)pa, off, PGSIZE) &lt;= <span class="hljs-number">0</span>)&#123;<br>    iunlock(a-&gt;f-&gt;ip);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br>  iunlock(a-&gt;f-&gt;ip);<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// trap.c</span><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (r_scause() == <span class="hljs-number">13</span> || r_scause() == <span class="hljs-number">15</span>) &#123;<br>    uint64 stval = r_stval();<br>    <span class="hljs-keyword">if</span>(mmap_pgfault(stval, p) != <span class="hljs-number">0</span>)&#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;usertrap(): unexpected scause %p pid=%d\n&quot;</span>, r_scause(), p-&gt;pid);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;            sepc=%p stval=%p\n&quot;</span>, r_sepc(), r_stval());<br>      p-&gt;killed = <span class="hljs-number">1</span>;<br>    &#125;<br><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((which_dev = devintr()) != <span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-comment">// ok</span><br>  &#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>å®ç°munmap</li></ol><p><code>munmap()</code>å–æ¶ˆæ˜ å°„åŒºåŸŸçš„ä¸€éƒ¨åˆ†ï¼Œé¦–å…ˆè¦æ‰¾åˆ°æ‰€å±çš„vmaï¼Œå–æ¶ˆçš„æ˜ å°„åŒºåŸŸåˆ†ä¸ºä¸‰ç§æƒ…å†µï¼šå–æ¶ˆvmaèµ·å§‹åœ°å€çš„ä¸€æ®µæ˜ å°„ã€å–æ¶ˆä»¥vmaç»“æŸåœ°å€ç»“æŸçš„ä¸€æ®µæ˜ å°„ã€å–æ¶ˆæ•´ä¸ªvmaæ˜ å°„ï¼Œæ ¹æ®ä¸‰ç§æƒ…å†µå¾—å‡ºæ‰€å–æ¶ˆæ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€ï¼ˆunstartï¼‰ä¸é•¿åº¦ï¼ˆunlenï¼‰ï¼Œå¹¶æ›´æ–°å–æ¶ˆä¸€æ®µåŒºåŸŸåçš„vmaã€‚</p><p>å–æ¶ˆæ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€éœ€è¦æŒ‰é¡µå¯¹å…¶ï¼Œé•¿åº¦ä¹Ÿéœ€è¦æ˜¯é¡µå¤§å°çš„æ•´æ•°å€ã€‚</p><p>å¦‚æœè¯¥vmaçš„æ ‡å¿—ä¸ºMAP_SHAREDæ—¶ï¼Œåº”è¯¥æŠŠæ‰€å–æ¶ˆçš„åŒºåŸŸçš„ä¿®æ”¹å†™å›åˆ°æ–‡ä»¶ä¸­å»ï¼Œè¿™é‡Œä¸ºäº†ç®€å•ä¸è€ƒè™‘é¡µè¡¨ä¸­çš„dirtyä½ï¼Œç›´æ¥å†™å›æ–‡ä»¶ï¼›å¦‚æœå–æ¶ˆæ˜ å°„çš„é¡µè¿˜æ²¡æœ‰é€šè¿‡<code>mmap_pgfault()</code>æ˜ å°„ç‰©ç†é¡µï¼Œä¹Ÿå°±ä»£è¡¨ç€æ²¡æœ‰è®¿é—®ä¿®æ”¹ï¼Œåˆ™ä¸ç”¨å†™å›ã€‚</p><p>å¦‚æœå–æ¶ˆäº†vmaæ•´æ®µåŒºåŸŸçš„æ˜ å°„ï¼Œä»£è¡¨ç€è¯¥æ–‡ä»¶æ˜ å°„çš„å–æ¶ˆï¼Œåº”è¯¥å‡å°‘è¯¥æ–‡ä»¶çš„å¼•ç”¨è®¡æ•°ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vm.c</span><br><span class="hljs-comment">// Whether the virtual address is mapped.</span><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">vm_exists</span><span class="hljs-params">(<span class="hljs-keyword">pagetable_t</span> pagetable, uint64 va)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">pte_t</span> *pte;<br>  <span class="hljs-keyword">return</span> (pte = walk(pagetable, va, <span class="hljs-number">0</span>)) != <span class="hljs-number">0</span> &amp;&amp; (*pte &amp; PTE_V) != <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">//Find the VMA for the address range and unmap the specified pages.</span><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">munmap</span><span class="hljs-params">(uint64 addr, <span class="hljs-keyword">int</span> length)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> *<span class="hljs-title">a</span> =</span> <span class="hljs-number">0</span>;<br>  addr = PGROUNDDOWN(addr);<br><br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NVMA; i++)&#123;<br>    <span class="hljs-keyword">if</span>(p-&gt;vmas[i].used &amp;&amp; addr &gt;= p-&gt;vmas[i].start &amp;&amp; addr &lt; p-&gt;vmas[i].end)&#123;<br>      a = &amp;p-&gt;vmas[i];<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (a == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  uint64 unstart, unlen;<br>  uint64 start = a-&gt;start, offset = a-&gt;offset, orilen = a-&gt;length;<br><br>  <span class="hljs-keyword">if</span>(addr == a-&gt;start)&#123;<br>    <span class="hljs-comment">// Unmap at the start</span><br>    unstart = addr;<br>    unlen = PGROUNDUP(length) &lt; a-&gt;length ? PGROUNDUP(length) : a-&gt;length;<br><br>    a-&gt;start = unstart + unlen; <br>    a-&gt;length = a-&gt;end - a-&gt;start;<br>    a-&gt;offset = a-&gt;offset + unlen;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(addr + length &gt;= a-&gt;end)&#123;<br>    <span class="hljs-comment">// Unmap at the end</span><br>    unstart = addr;<br>    unlen = a-&gt;end - unstart;<br><br>    a-&gt;end = unstart;<br>    a-&gt;length = a-&gt;end - a-&gt;start;<br>  &#125; <span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-comment">// Unmap the whole region</span><br>    unstart = a-&gt;start;<br>    unlen = a-&gt;end - a-&gt;start;<br>  &#125;<br>  <br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; unlen / PGSIZE; i++)&#123;<br>    uint64 va = unstart + i * PGSIZE;<br>    <span class="hljs-comment">// May not be alloced due to lazy alloc through page fault.</span><br>    <span class="hljs-keyword">if</span>(vm_exists(p-&gt;pagetable, va))&#123;<br>      <span class="hljs-keyword">if</span>(a-&gt;flags &amp; MAP_SHARED)&#123;<br>        munmap_writeback(va, PGSIZE, start, offset, a);<br>      &#125;<br><br>      uvmunmap(p-&gt;pagetable, va, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(unlen == orilen)&#123;<br>    fileclose(a-&gt;f);<br>    a-&gt;used = <span class="hljs-number">0</span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// sysfile.c</span><br><span class="hljs-function">uint64</span><br><span class="hljs-function"><span class="hljs-title">sys_munmap</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  uint64 addr;<br>  <span class="hljs-keyword">int</span> length;<br><br>  <span class="hljs-keyword">if</span>(argaddr(<span class="hljs-number">0</span>, &amp;addr) || argint(<span class="hljs-number">1</span>, &amp;length))<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  <br>  <span class="hljs-keyword">return</span> munmap(addr, length);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="5"><li>å®ç°munmap_writeback</li></ol><p><code>munmap_writeback()</code>ç”¨äºå–æ¶ˆæ˜ å°„æ—¶å°†ä¿®æ”¹çš„æ˜ å°„é¡µå†™å›æ–‡ä»¶ï¼Œå†™å›æ—¶åº”æ³¨æ„å†™æ–‡ä»¶çš„èµ·å§‹åç§»ï¼Œä¸è¯»æ–‡ä»¶ç±»ä¼¼ï¼Œå†™åç§»ä¸ºè¯¥æ–‡ä»¶åœ¨vmaä¸­èµ·å§‹åç§» + è¯¥é¡µä¸vmaèµ·å§‹é¡µçš„åç§»ï¼Œæ­¤å¤–è¯¥æ–‡ä»¶å‰©ä½™å¤§å°ä¸è¶³ä¸€é¡µå¤§å°æ—¶ï¼Œåº”è¯¥æŒ‰ç…§å®é™…å‰©ä½™å¤§å°æ¥å†™ã€‚</p><p>å†™æ–‡ä»¶æ—¶å’Œ<code>filewrite()</code>ç±»ä¼¼ï¼Œå°†å†™æ“ä½œæ‰“åŒ…ä¸ºå¤šæ¬¡æ—¥å¿—äº‹åŠ¡æ¥å†™ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vm.c</span><br><span class="hljs-comment">// If an unmapped page has been modified and the file is mapped MAP_SHARED, </span><br><span class="hljs-comment">// write the page back to the file. </span><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">munmap_writeback</span><span class="hljs-params">(uint64 unstart, uint64 unlen, uint64 start, uint64 offset, struct vma *a)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">f</span> =</span> a-&gt;f;<br>  uint off = unstart - start + offset;<br>  uint size;<br><br>  ilock(f-&gt;ip);<br>  size = f-&gt;ip-&gt;size;<br>  iunlock(f-&gt;ip);<br><br>  <span class="hljs-keyword">if</span>(off &gt;= size) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  uint n = unlen &lt; size - off ? unlen : size - off;<br><br>  <span class="hljs-keyword">int</span> r, ret = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">int</span> max = ((MAXOPBLOCKS<span class="hljs-number">-1</span><span class="hljs-number">-1</span><span class="hljs-number">-2</span>) / <span class="hljs-number">2</span>) * BSIZE;<br>  <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span>(i &lt; n)&#123;<br>    <span class="hljs-keyword">int</span> n1 = n - i;<br>    <span class="hljs-keyword">if</span>(n1 &gt; max)<br>      n1 = max;<br><br>    begin_op();<br>    ilock(f-&gt;ip);<br>    r = writei(f-&gt;ip, <span class="hljs-number">1</span>, unstart, off + i, n1);<br>    iunlock(f-&gt;ip);<br>    end_op();<br><br>    <span class="hljs-keyword">if</span>(r != n1)&#123;<br>      <span class="hljs-comment">// error from writei</span><br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    i += r;<br>  &#125;<br>  ret = (i == n ? n : <span class="hljs-number">-1</span>);<br><br>  <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="6"><li>ä¿®æ”¹exit</li></ol><p>è¿›ç¨‹é€€å‡ºæ—¶åº”è¯¥å–æ¶ˆæ‰€æœ‰çš„mmapæ˜ å°„ï¼Œç›´æ¥è°ƒç”¨<code>munmap()</code>å‡½æ•°å–æ¶ˆæ¯ä¸€ä¸ªä½¿ç”¨ä¸­çš„vmaçš„æ˜ å°„å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// proc.c/exit</span><br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NVMA; i++)&#123;<br>    <span class="hljs-keyword">if</span>(p-&gt;vmas[i].used)&#123;<br>      munmap(p-&gt;vmas[i].start, p-&gt;vmas[i].length);<br>      p-&gt;vmas[i].used = <span class="hljs-number">0</span>;<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><ol start="7"><li>ä¿®æ”¹fork</li></ol><p>å½“è°ƒç”¨<code>fork()</code>æ—¶ï¼Œå­è¿›ç¨‹ä¹Ÿéœ€è¦å¤åˆ¶çˆ¶è¿›ç¨‹çš„æ˜ å°„ï¼Œç›´æ¥å¤åˆ¶çˆ¶è¿›ç¨‹çš„vmaå³å¯ï¼Œä¸è¿‡éœ€è¦ä¸ºæ–‡ä»¶çš„å¼•ç”¨è®¡æ•°+1ï¼Œè¿™é‡Œå®ç°æ—¶ä¸è€ƒè™‘çˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹å…±äº«ç›¸åŒçš„ç‰©ç†é¡µï¼Œå¦‚æœå…±äº«çš„è¯ï¼Œå®ç°å’ŒCOW forkç±»ä¼¼ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// proc.c</span><br><span class="hljs-comment">// Copy vmas of parent proc for mmap</span><br><span class="hljs-comment">// Need to increase file reference count</span><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">fork_mmap</span><span class="hljs-params">(struct proc *np, struct proc *p)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NVMA; i++)&#123;<br>    <span class="hljs-keyword">if</span>(p-&gt;vmas[i].used)&#123;<br>      np-&gt;vmas[i] = p-&gt;vmas[i];<br>      filedup(np-&gt;vmas[i].f);<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// proc.c/fork</span><br>safestrcpy(np-&gt;name, p-&gt;name, <span class="hljs-keyword">sizeof</span>(p-&gt;name));<br><br>fork_mmap(np, p);<br><br>pid = np-&gt;pid;<br></code></pre></td></tr></table></figure><h4 id="å®éªŒæµ‹è¯•"><a href="#å®éªŒæµ‹è¯•" class="headerlink" title="å®éªŒæµ‹è¯•"></a>å®éªŒæµ‹è¯•</h4><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210708130511.png" alt="image-20210708130504265"></p><h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><p><a href="https://github.com/whileskies/xv6-labs-2020/tree/mmap">https://github.com/whileskies/xv6-labs-2020/tree/mmap</a></p>]]></content>
    
    
    <categories>
      
      <category>OS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6.S081-Lab9: file system</title>
    <link href="/2021/07/11/6-S081-Lab9-file-system/"/>
    <url>/2021/07/11/6-S081-Lab9-file-system/</url>
    
    <content type="html"><![CDATA[<h2 id="Lab9-file-system"><a href="#Lab9-file-system" class="headerlink" title="Lab9: file system"></a>Lab9: file system</h2><p>lab9æ˜¯ä¸ºxv6æ–‡ä»¶ç³»ç»Ÿå¢åŠ æ”¯æŒå¤§æ–‡ä»¶çš„åŠŸèƒ½ä»¥åŠè½¯é“¾æ¥åŠŸèƒ½ã€‚</p><h4 id="Large-files"><a href="#Large-files" class="headerlink" title="Large files"></a>Large files</h4><h5 id="ä»»åŠ¡"><a href="#ä»»åŠ¡" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>å½“å‰çš„xv6æ–‡ä»¶è¢«é™åˆ¶åœ¨268ä¸ªå—å†…ï¼Œ æ¯ä¸€å—1024å­—èŠ‚ï¼Œè¿™ä¸ªé™åˆ¶ç”±äºxv6çš„inodeç»“ç‚¹åŒ…å«12ä¸ªç›´æ¥å—å·ï¼Œä¸€ä¸ªå•ä¸€çš„é—´æ¥å—å·ï¼Œé—´æ¥å—å·å¯ä»¥å­˜å‚¨256ä¸ªæ•°æ®å—å—å·ï¼Œå› æ­¤æ€»å…±æ˜¯12 + 256 = 268å—ã€‚</p><p>è¯¥éƒ¨åˆ†éœ€è¦å¢åŠ xv6æ–‡ä»¶çš„æœ€å¤§å¤§å°ï¼Œé€šè¿‡ä¸ºxv6å¼•å…¥äºŒçº§é—´æ¥å—å·æ¥å¢åŠ æ–‡ä»¶å¤§å°æœ€å¤§å€¼ï¼ŒäºŒçº§é—´æ¥å—å·åŒ…æ‹¬256ä¸ªä¸€çº§é—´æ¥å—å·ï¼Œæ¯ä¸ªä¸€çº§é—´æ¥å—å·åˆå¯ä»¥å­˜å‚¨256ä¸ªæ•°æ®å—å—å·ï¼Œå› æ­¤æœ€å¤§æ–‡ä»¶å¯ä»¥è¾¾åˆ°65803 å—ï¼ˆ256 * 256 + 256 + 11å—ï¼Œç‰ºç‰²äº†ä¸€ä¸ªç›´æ¥å—å·ä½œä¸ºäºŒçº§é—´æ¥å—å·åœ°å€ï¼‰ã€‚</p><h5 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><ol><li>ä¿®æ”¹inodeç»“æ„</li></ol><p>ç”±äºéœ€è¦å¼•å…¥äºŒçº§é—´æ¥å—å·ï¼Œéœ€è¦ç‰ºç‰²ä¸€ä¸ªç›´æ¥å—å·ï¼Œå› æ­¤éœ€è¦ä¿®æ”¹inodeçš„ç»“æ„ä»¥ä¿®æ”¹å¸ƒå±€ï¼Œä¿®æ”¹åinodeæœ‰11ä¸ªç›´æ¥å—å·ã€1ä¸ªä¸€çº§é—´æ¥å—å·åœ°å€ã€1ä¸ªäºŒçº§é—´æ¥å—å·åœ°å€ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// fs.h</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NDIRECT 11</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> DINDIRECTI (NDIRECT + 1)</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NINDIRECT (BSIZE / sizeof(uint))</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAXFILE (NDIRECT + NINDIRECT + NINDIRECT * NINDIRECT</span><br><br><span class="hljs-comment">// file.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> &#123;</span><br>  uint dev;           <span class="hljs-comment">// Device number</span><br>  uint inum;          <span class="hljs-comment">// Inode number</span><br>  <span class="hljs-keyword">int</span> ref;            <span class="hljs-comment">// Reference count</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sleeplock</span> <span class="hljs-title">lock</span>;</span> <span class="hljs-comment">// protects everything below here</span><br>  <span class="hljs-keyword">int</span> valid;          <span class="hljs-comment">// inode has been read from disk?</span><br><br>  <span class="hljs-keyword">short</span> type;         <span class="hljs-comment">// copy of disk inode</span><br>  <span class="hljs-keyword">short</span> major;<br>  <span class="hljs-keyword">short</span> minor;<br>  <span class="hljs-keyword">short</span> nlink;<br>  uint size;<br>  uint addrs[NDIRECT+<span class="hljs-number">2</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><ol start="2"><li>ä¿®æ”¹<code>fs.c/bmap()</code></li></ol><p><code>bmap()</code>å‡½æ•°å°†æ–‡ä»¶å†…å—å·æ˜ å°„ä¸ºç£ç›˜å—å·ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¼šä¸ºå…¶ä»bitmapå¯»æ‰¾ä¸€ç©ºé—²æ•°æ®å—ï¼Œå¹¶å°†å¯»æ‰¾åˆ°çš„æ•°æ®å—å·æ·»åŠ åˆ°inodeä¸­ï¼Œå»ºç«‹ç›¸åº”çš„æ˜ å°„ã€‚</p><p>å¦‚æœæ–‡ä»¶å†…å—å·ä½äºä¸€çº§é—´æ¥å—å·çš„èŒƒå›´å†…ï¼Œåˆ™åº”è¯¥å…ˆæ ¹æ®ä¸€çº§é—´æ¥å—å·åœ°å€æ‰¾åˆ°å­˜æ”¾ä¸€çº§é—´æ¥å—å·çš„æ•°æ®å—ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ†é…ï¼Œå†æ ¹æ®ä¸€çº§é—´æ¥å—å·ä¸­çš„å—å·åœ°å€ï¼Œæ‰¾åˆ°å…·ä½“çš„æ•°æ®å—ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ†é…ã€‚</p><p>äºŒçº§é—´æ¥å—å·ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡å¤šäº†ä¸€å±‚æŸ¥æ‰¾è¿‡ç¨‹ï¼Œä¿®æ”¹åçš„inodeç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210630153348.png" alt="image-20210630153348525" style="zoom: 67%;" /><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> uint</span><br><span class="hljs-function"><span class="hljs-title">bmap</span><span class="hljs-params">(struct inode *ip, uint bn)</span></span><br><span class="hljs-function"></span>&#123;<br>  uint addr, addr2, *a, *a2;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">bp</span>, *<span class="hljs-title">bp2</span>;</span><br><br>  <span class="hljs-keyword">if</span>(bn &lt; NDIRECT)&#123;<br>    <span class="hljs-keyword">if</span>((addr = ip-&gt;addrs[bn]) == <span class="hljs-number">0</span>)<br>      ip-&gt;addrs[bn] = addr = balloc(ip-&gt;dev);<br>    <span class="hljs-keyword">return</span> addr;<br>  &#125;<br>  bn -= NDIRECT;<br><br>  <span class="hljs-keyword">if</span>(bn &lt; NINDIRECT)&#123;<br>    <span class="hljs-comment">// Load indirect block, allocating if necessary.</span><br>    <span class="hljs-keyword">if</span>((addr = ip-&gt;addrs[NDIRECT]) == <span class="hljs-number">0</span>)<br>      ip-&gt;addrs[NDIRECT] = addr = balloc(ip-&gt;dev);<br>    bp = bread(ip-&gt;dev, addr);<br>    a = (uint*)bp-&gt;data;<br>    <span class="hljs-keyword">if</span>((addr = a[bn]) == <span class="hljs-number">0</span>)&#123;<br>      a[bn] = addr = balloc(ip-&gt;dev);<br>      log_write(bp);<br>    &#125;<br>    brelse(bp);<br>    <span class="hljs-keyword">return</span> addr;<br>  &#125;<br>  <br>  bn -= NINDIRECT;<br><br>  <span class="hljs-keyword">if</span>(bn &lt; NINDIRECT * NINDIRECT)&#123;<br>    uint dbn = bn / NINDIRECT;<br>    uint dbnoff = bn % NINDIRECT;<br><br>    <span class="hljs-comment">// Load doubly-indirect block, allocating if necessary.</span><br>    <span class="hljs-keyword">if</span>((addr = ip-&gt;addrs[DINDIRECTI]) == <span class="hljs-number">0</span>)<br>      ip-&gt;addrs[DINDIRECTI] = addr = balloc(ip-&gt;dev);<br>    bp = bread(ip-&gt;dev, addr);<br>    <br>    a = (uint*)bp-&gt;data;<br>    <span class="hljs-keyword">if</span>((addr2 = a[dbn]) == <span class="hljs-number">0</span>)&#123;<br>      a[dbn] = addr2 = balloc(ip-&gt;dev);<br>      log_write(bp);<br>    &#125;<br>    brelse(bp);<br><br>    <span class="hljs-comment">//printf(&quot;addr2: %d\n&quot;, addr2);</span><br>    bp2 = bread(ip-&gt;dev, addr2);<br>    a2 = (uint*)bp2-&gt;data;<br>    <span class="hljs-keyword">if</span>((addr = a2[dbnoff]) == <span class="hljs-number">0</span>)&#123;<br>      a2[dbnoff] = addr = balloc(ip-&gt;dev);<br>      log_write(bp2);<br>    &#125;<br>    brelse(bp2);<br><br>    <span class="hljs-keyword">return</span> addr;<br>  &#125;<br><br>  panic(<span class="hljs-string">&quot;bmap: out of range&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>ä¿®æ”¹<code>fs.c/itrunc()</code></li></ol><p>æœ‰å¢åŠ æ˜ å°„å°±æœ‰åˆ é™¤æ˜ å°„ï¼Œ<code>itrunc()</code>ç”¨äºåˆ é™¤æ•´ä¸ªæ–‡ä»¶å†…å®¹ï¼Œåˆ™éœ€è¦æŸ¥æ‰¾inodeï¼Œåˆ é™¤æ‰€å æœ‰çš„æ‰€æœ‰æ•°æ®å—ï¼ŒåŒ…æ‹¬ä¸€çº§é—´æ¥å—ã€äºŒçº§é—´æ¥å—ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">itrunc</span><span class="hljs-params">(struct inode *ip)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> i, j;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">bp</span>, *<span class="hljs-title">bp2</span>;</span><br>  uint *a, *a2;<br><br>  <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; NDIRECT; i++)&#123;<br>    <span class="hljs-keyword">if</span>(ip-&gt;addrs[i])&#123;<br>      bfree(ip-&gt;dev, ip-&gt;addrs[i]);<br>      ip-&gt;addrs[i] = <span class="hljs-number">0</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(ip-&gt;addrs[NDIRECT])&#123;<br>    bp = bread(ip-&gt;dev, ip-&gt;addrs[NDIRECT]);<br>    a = (uint*)bp-&gt;data;<br>    <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; NINDIRECT; j++)&#123;<br>      <span class="hljs-keyword">if</span>(a[j])<br>        bfree(ip-&gt;dev, a[j]);<br>    &#125;<br>    brelse(bp);<br>    bfree(ip-&gt;dev, ip-&gt;addrs[NDIRECT]);<br>    ip-&gt;addrs[NDIRECT] = <span class="hljs-number">0</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(ip-&gt;addrs[DINDIRECTI])&#123;<br>    bp = bread(ip-&gt;dev, ip-&gt;addrs[DINDIRECTI]);<br>    a = (uint*)bp-&gt;data;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; NINDIRECT; i++)&#123;<br>      <span class="hljs-keyword">if</span>(a[i])&#123;<br>        bp2 = bread(ip-&gt;dev, a[i]);<br>        a2 = (uint*)bp2-&gt;data;<br>        <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; NINDIRECT; j++)&#123;<br>          <span class="hljs-keyword">if</span>(a2[j])<br>            bfree(ip-&gt;dev, a2[j]);<br>        &#125;<br>        brelse(bp2);<br>        bfree(ip-&gt;dev, a[i]);<br>      &#125;<br>    &#125;<br>    brelse(bp);<br>    bfree(ip-&gt;dev, ip-&gt;addrs[DINDIRECTI]);<br>    ip-&gt;addrs[DINDIRECTI] = <span class="hljs-number">0</span>;<br>  &#125;<br><br>  ip-&gt;size = <span class="hljs-number">0</span>;<br>  iupdate(ip);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>ä¿®æ”¹<code>file.c/filewrite()</code></li></ol><p>xv6ä¸ºäº†ç»´æŒæ–‡ä»¶ç³»ç»Ÿçš„ä¸€è‡´æ€§ï¼Œå¯¹äºæ–‡ä»¶ç³»ç»Ÿçš„è°ƒç”¨éƒ½å°†è¢«ä½œä¸ºä¸€ä¸ªäº‹åŠ¡æ¥å®Œæˆï¼Œç”±äºæ—¥å¿—å¤§å°é™åˆ¶ï¼Œä¸€ä¸ªäº‹åŠ¡åŒæ—¶æ›´æ–°çš„æ•°æ®å—æ•°é‡ä¹Ÿå—åˆ°äº†é™åˆ¶ï¼Œå¯¹äºå¤§æ–‡ä»¶çš„å†™æ¥è¯´ï¼Œå°†è¢«åˆ‡åˆ†æˆå¤šæ¬¡å†™ï¼Œæ¯æ¬¡å†™å‡ ä¸ªæ•°æ®å—ä½œä¸ºä¸€ä¸ªäº‹åŠ¡è¿›è¡Œæäº¤ã€‚</p><p>å¯¹äºæ–‡ä»¶çš„ä¸€æ¬¡å†™ï¼Œå¯èƒ½éœ€è¦ä¸ºå…¶åˆ†é…æ•°æ®å—ï¼Œé‚£ä¹ˆå­˜å‚¨é—´æ¥å—å·çš„æ•°æ®å—ã€inodeæ•°æ®å—éƒ½éœ€è¦æ›´æ–°ï¼Œæ¯ä¸ªäº‹åŠ¡å®é™…ä½¿ç”¨çš„æ•°æ®å—æ•°é‡åº”è¯¥è€ƒè™‘åˆ°åŒæ—¶æ›´æ–°çš„è¿™äº›æ•°æ®å—ï¼›è€Œç”±äºæ·»åŠ äº†äºŒçº§é—´æ¥å—å·çš„æ•°æ®å—ï¼Œé‚£ä¹ˆåŒæ—¶åˆå¯èƒ½éœ€è¦æ›´æ–°äºŒçº§é—´æ¥å—å·çš„æ•°æ®å—ï¼Œå› æ­¤æœ€ç»ˆæ¯ä¸ªäº‹åŠ¡ä½¿ç”¨çš„æœ€å¤§æ•°æ®å—åˆåº”è¯¥ä»æ¯ä¸ªäº‹åŠ¡çš„æ—¥å¿—æœ€å¤§å—æ•° -1ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">int</span> max = ((MAXOPBLOCKS<span class="hljs-number">-1</span><span class="hljs-number">-2</span><span class="hljs-number">-2</span>) / <span class="hljs-number">2</span>) * BSIZE;<br></code></pre></td></tr></table></figure><h4 id="Symbolic-links"><a href="#Symbolic-links" class="headerlink" title="Symbolic links"></a>Symbolic links</h4><h5 id="ä»»åŠ¡-1"><a href="#ä»»åŠ¡-1" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>è¯¥éƒ¨åˆ†ä¸ºxv6å¢åŠ ç¬¦å·é“¾æ¥ï¼ˆè½¯é“¾æ¥ï¼‰ï¼Œç¬¦å·é“¾æ¥é€šè¿‡æ–‡ä»¶è·¯å¾„é“¾æ¥å¦ä¸€ä¸ªæ–‡ä»¶ï¼›å½“ä¸€ä¸ªç¬¦å·é“¾æ¥æ‰“å¼€æ—¶ï¼Œå†…æ ¸æ‰“å¼€å®é™…é“¾æ¥åˆ°çš„æ–‡ä»¶ã€‚ç¬¦å·é“¾æ¥åƒç¡¬é“¾æ¥ï¼Œä½†æ˜¯ç¡¬é“¾æ¥è¢«é™åˆ¶æŒ‡å‘åŒä¸€ä¸ªç£ç›˜ä¸Šï¼Œç¬¦å·é“¾æ¥å¯ä»¥åœ¨ä¸åŒçš„ç£ç›˜è®¾å¤‡ä¸Šã€‚</p><h5 id="è¿‡ç¨‹-1"><a href="#è¿‡ç¨‹-1" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><ol><li>å¢åŠ ç³»ç»Ÿè°ƒç”¨</li></ol><p>æŒ‰ç…§ä¹‹å‰Labæ·»åŠ ç³»ç»Ÿè°ƒç”¨çš„æ–¹å¼æ·»åŠ <code>symlink</code>ç³»ç»Ÿè°ƒç”¨ã€‚</p><ol start="2"><li>å¢åŠ ç¬¦å·é“¾æ¥æ–‡ä»¶ç±»å‹</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// stat.h</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> T_DIR     1   <span class="hljs-comment">// Directory</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> T_FILE    2   <span class="hljs-comment">// File</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> T_DEVICE  3   <span class="hljs-comment">// Device</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> T_SYMLINK 4   <span class="hljs-comment">// Symbolic link</span></span><br><br><span class="hljs-comment">// fcntl.h </span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> O_RDWR    0x002</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> O_CREATE  0x200</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> O_TRUNC   0x400</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> O_NOFOLLOW 0x800 </span><br></code></pre></td></tr></table></figure><ol start="3"><li>åˆ›å»º<code>sysfile.c/sys_symlink()</code>ç³»ç»Ÿè°ƒç”¨å‡½æ•°</li></ol><p>ç¬¦å·é“¾æ¥æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ï¼Œæ–‡ä»¶ç±»å‹ä¸ºT_SYMLINKï¼Œè¯¥æ–‡ä»¶åªéœ€è¦å­˜å‚¨å¦ä¸€ä¸ªæ–‡ä»¶çš„è·¯å¾„å³å¯ï¼Œå› æ­¤é¦–å…ˆå…ˆåˆ›å»ºä¸€ä¸ªç¬¦å·é“¾æ¥æ–‡ä»¶ï¼Œå†å°†æ‰€é“¾æ¥æ–‡ä»¶è·¯å¾„å†™åˆ°ç¬¦å·é“¾æ¥æ–‡ä»¶ä¸­å³å¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">uint64</span><br><span class="hljs-function"><span class="hljs-title">sys_symlink</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">char</span> <span class="hljs-keyword">new</span>[MAXPATH], old[MAXPATH];<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">op</span>, *<span class="hljs-title">ip</span>;</span><br><br>  <span class="hljs-keyword">if</span>(argstr(<span class="hljs-number">0</span>, old, MAXPATH) &lt; <span class="hljs-number">0</span> || argstr(<span class="hljs-number">1</span>, <span class="hljs-keyword">new</span>, MAXPATH) &lt; <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  begin_op();<br>  <span class="hljs-keyword">if</span>((op = namei(old)) != <span class="hljs-number">0</span>)&#123;<br>    ilock(op);<br>    <span class="hljs-keyword">if</span>(op-&gt;type == T_DIR)&#123;<br>      iunlockput(op);<br>      end_op();<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    iunlockput(op);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>((ip = create(<span class="hljs-keyword">new</span>, T_SYMLINK, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)) == <span class="hljs-number">0</span>)&#123;<br>    end_op();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  uint len = <span class="hljs-built_in">strlen</span>(old) + <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">if</span>(writei(ip, <span class="hljs-number">0</span>, (uint64)old, <span class="hljs-number">0</span>, len) != len)&#123;<br>    iunlockput(ip);<br>    end_op();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  iupdate(ip);<br>  iunlockput(ip);<br>  end_op();<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>ä¿®æ”¹<code>sysfile.c/sys_open()</code>å¢åŠ é“¾æ¥æ–‡ä»¶æ‰“å¼€æ–¹å¼</li></ol><p>è¿›ç¨‹ä½¿ç”¨<code>open()</code>ç³»ç»Ÿè°ƒç”¨æ‰“å¼€ç¬¦å·é“¾æ¥æ–‡ä»¶æ—¶ï¼Œå¯ä»¥æœ‰ä¸¤ç§æ‰“å¼€æ–¹å¼ï¼š</p><ul><li>æ‰“å¼€æ¨¡å¼ä¸º<code>O_NOFOLLOW</code>æ—¶ï¼Œç›´æ¥æ‰“å¼€ç¬¦å·é“¾æ¥æ–‡ä»¶çš„å†…å®¹ï¼Œä¹Ÿå³å¦ä¸€ä¸ªæ–‡ä»¶çš„æ–‡ä»¶è·¯å¾„ï¼Œç›´æ¥æŒ‰ç…§ä¸€èˆ¬æ–‡ä»¶æ‰“å¼€å³å¯</li><li>æ‰“å¼€æ¨¡å¼ä¸åŠ <code>O_NOFOLLOW</code>æ—¶ï¼Œåˆ™æ‰“å¼€æ‰€é“¾æ¥çš„æ–‡ä»¶ï¼Œå¦‚æœæ‰€é“¾æ¥çš„æ–‡ä»¶åˆæ˜¯ä¸€ä¸ªé“¾æ¥æ–‡ä»¶ï¼Œè¿™åº”è¯¥é€’å½’åœ°å»æ‰¾åˆ°çœŸæ­£çš„æ–‡ä»¶</li></ul><p><code>sys_open()</code>å‡½æ•°ä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(omode &amp; O_NOFOLLOW)&#123;<br>  <span class="hljs-keyword">if</span>((ip = namei(path)) == <span class="hljs-number">0</span>)&#123;<br>    end_op();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br>&#125; <span class="hljs-keyword">else</span>&#123;<br>  <span class="hljs-keyword">char</span> rpath[MAXPATH];<br>  <span class="hljs-keyword">if</span>((ip = find_symlink(path, rpath, <span class="hljs-number">0</span>)) == <span class="hljs-number">0</span>)&#123;<br>    end_op();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>find_symlink()</code>å‡½æ•°é€’å½’æ‰¾åˆ°çœŸæ­£çš„æ–‡ä»¶ï¼Œå¦‚æœé€’å½’å±‚æ•°è¿‡å¤šï¼Œåˆ™åœæ­¢ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">struct inode*</span><br><span class="hljs-function"><span class="hljs-title">find_symlink</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *path, <span class="hljs-keyword">char</span> *rpath, <span class="hljs-keyword">int</span> depth)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span>(depth &gt;= <span class="hljs-number">10</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">ip</span>;</span><br>  <span class="hljs-keyword">if</span>((ip = namei(path)) != <span class="hljs-number">0</span>)&#123;<br>    ilock(ip);<br><br>    <span class="hljs-keyword">if</span>(ip-&gt;type != T_SYMLINK)&#123;<br>      iunlock(ip);<br>      <span class="hljs-keyword">return</span> ip;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(readi(ip, <span class="hljs-number">0</span>, (uint64)rpath, <span class="hljs-number">0</span>, ip-&gt;size) == <span class="hljs-number">0</span>)&#123;<br>      iunlockput(ip);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    iunlockput(ip);<br>  <br>    <span class="hljs-keyword">return</span> find_symlink(rpath, rpath, depth + <span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å®éªŒæµ‹è¯•"><a href="#å®éªŒæµ‹è¯•" class="headerlink" title="å®éªŒæµ‹è¯•"></a>å®éªŒæµ‹è¯•</h4><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210630161137.png" alt="test2"></p><h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><p><a href="https://github.com/whileskies/xv6-labs-2020/tree/fs">https://github.com/whileskies/xv6-labs-2020/tree/fs</a></p>]]></content>
    
    
    <categories>
      
      <category>OS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6.S081-Lab8: locks</title>
    <link href="/2021/07/11/6-S081-Lab8-locks/"/>
    <url>/2021/07/11/6-S081-Lab8-locks/</url>
    
    <content type="html"><![CDATA[<h2 id="Lab8-locks"><a href="#Lab8-locks" class="headerlink" title="Lab8: locks"></a>Lab8: locks</h2><p>Lab8é€šè¿‡é‡æ–°è®¾è®¡å†…æ ¸çš„ä¸€äº›ä»£ç ï¼Œå°†åŸæœ¬ç²—ç²’åº¦çš„é”æ›´æ”¹ä¸ºç»†ç²’åº¦çš„é”æ¥å¢åŠ å¹¶è¡Œåº¦ã€‚å¤šæ ¸æœºå™¨ä¸Šå¼±å¹¶è¡Œåº¦çš„ä¸€ä¸ªé€šç”¨çš„æ ‡å¿—æ˜¯å…·æœ‰è¾ƒé«˜çš„é”çš„äº‰ç”¨ï¼Œæé«˜å¹¶è¡Œåº¦é€šå¸¸æ¶‰åŠåˆ°ä¿®æ”¹æ•°æ®ç»“æ„å’ŒåŠ é”ç­–ç•¥ã€‚æœ¬å®éªŒéœ€è¦é‡æ–°è®¾è®¡xv6çš„memory allocatorå’Œblock cacheä¸¤ä¸ªæ¨¡å—çš„æ•°æ®ç»“æ„å’ŒåŠ é”ç­–ç•¥ï¼Œæ¥æé«˜å¹¶è¡Œåº¦ã€‚</p><h4 id="Memory-allocator"><a href="#Memory-allocator" class="headerlink" title="Memory allocator"></a>Memory allocator</h4><h5 id="ä»»åŠ¡"><a href="#ä»»åŠ¡" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>åœ¨åŸæœ¬xv6çš„<code>kalloc()</code>å’Œ<code>kfree()</code>çš„è®¾è®¡ä¸­ï¼Œä¼šå‘ç”Ÿè¾ƒé«˜çš„é”çš„äº‰ç”¨ï¼ŒåŸå› åœ¨äºä½¿ç”¨äº†ä¸€ä¸ªå•ä¸€çš„ç©ºé—²ç‰©ç†é¡µé“¾è¡¨ç”¨äºåˆ†é…ä¸é‡Šæ”¾ç‰©ç†é¡µï¼Œè¯¥é“¾è¡¨ä½¿ç”¨ä¸€ä¸ªé”è¿›è¡Œä¿æŠ¤ã€‚ä¸ºäº†ç§»é™¤é”çš„äº‰ç”¨ï¼Œéœ€è¦é‡æ–°è®¾è®¡å†…å­˜åˆ†é…å™¨æ¥é¿å…å•ä¸€çš„é”å’Œé“¾è¡¨ã€‚åŸºæœ¬çš„æƒ³æ³•æ˜¯æ¯ä¸ªCPUç»´æŠ¤ä¸€ä¸ªç©ºé—²ç‰©ç†é¡µé“¾è¡¨ï¼Œç›¸åº”çš„æ¯ä¸ªé“¾è¡¨æŒæœ‰ä¸€ä¸ªè‡ªå·±çš„é”ã€‚åœ¨ä¸åŒCPUä¸Šå»åˆ†é…å’Œé‡Šæ”¾å¯ä»¥æ˜¯å¹¶è¡Œçš„ï¼Œå› ä¸ºæ¯ä¸ªCPUå°†æ“ä½œä¸åŒçš„é“¾è¡¨ã€‚å…¶ä¸­ä¸»è¦çš„æŒ‘æˆ˜æ˜¯å½“ä¸€ä¸ªCPUçš„é“¾è¡¨ä¸ºç©ºæ—¶ï¼ŒåŒæ—¶å¦ä¸€ä¸ªCPUçš„é“¾è¡¨ä¸­æœ‰ç©ºé—²çš„ç‰©ç†é¡µï¼›è¿™ç§æƒ…å†µæ—¶ï¼Œé“¾è¡¨ä¸ºç©ºçš„CPUéœ€è¦çªƒå–ä¸€äº›å…¶ä»–CPUé“¾è¡¨ä¸Šçš„ç©ºé—²ç‰©ç†é¡µï¼›çªƒå–å¯èƒ½ä¼šäº§ç”Ÿé”çš„äº‰ç”¨ï¼Œä¸è¿‡è¿˜å¥½è¿™å°†ä¸ç»å¸¸å‘ç”Ÿã€‚</p><h5 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><ol><li>å®šä¹‰æ¯ä¸ªCPUä¸€ä¸ªç©ºé—²ç‰©ç†é¡µé“¾è¡¨</li></ol><p>å°†åŸæœ¬çš„å•é“¾è¡¨æ‰©å±•ä¸ºæ¯ä¸ªCPUä¸€ä¸ªé“¾è¡¨ï¼Œå¹¶åœ¨<code>kinit()</code>å‡½æ•°ä¸­åˆå§‹åŒ–æ¯ä¸ªé”ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOCK_NAME_N 6</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spinlock</span> <span class="hljs-title">lock</span>;</span><br>  <span class="hljs-keyword">char</span> lock_name[LOCK_NAME_N];<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">run</span> *<span class="hljs-title">freelist</span>;</span><br>&#125; kmem[NCPU]<br><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">kinit</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NCPU; i++) &#123;<br>    <span class="hljs-built_in">snprintf</span>(kmem[i].lock_name, LOCK_NAME_N, <span class="hljs-string">&quot;kmem%d&quot;</span>, i);<br>    initlock(&amp;kmem[i].lock, kmem[i].lock_name);<br>  &#125;<br>  freerange(end, (<span class="hljs-keyword">void</span>*)PHYSTOP);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>ä¿®æ”¹<code>kalloc()</code>å‡½æ•°</li></ol><p>å½“ç”³è¯·ç‰©ç†é¡µæ—¶ï¼Œ<code>kalloc()</code>è¢«è°ƒç”¨ï¼Œç”±äºç°åœ¨æ¯ä¸ªCPUä¸€ä¸ªé“¾è¡¨ï¼Œå› æ­¤éœ€è¦é€šè¿‡<code>cpuid()</code>å‡½æ•°è·å–åˆ°å½“å‰è°ƒç”¨<code>kalloc()</code>çº¿ç¨‹æ‰€å±CPUçš„ç¼–å·ï¼Œä¹‹åä»è¯¥CPUçš„é“¾è¡¨ä¸­å»è·å–ä¸€ä¸ªç©ºé—²ç‰©ç†é¡µï¼›åŒæ—¶è¦æ³¨æ„åªæœ‰ä¸­æ–­å…³é—­æ—¶é€šè¿‡<code>cpuid()</code>è·å–CPUå·æ‰æ˜¯å®‰å…¨çš„ï¼Œå¦åˆ™å¯èƒ½ç”±äºä¸­æ–­ï¼Œä¹‹åçš„ä»£ç è¢«è°ƒåº¦åˆ°å…¶ä»–CPUä¸Šå»æ‰§è¡Œäº†ã€‚</p><p>åœ¨å½“å‰CPUé“¾è¡¨ä¸ä¸ºç©ºæ—¶ï¼Œé¦–å…ˆå¯¹å½“å‰CPUé“¾è¡¨åŠ é”ï¼Œå¹¶ä»é“¾è¡¨ä¸­è·å–åˆ°ç©ºé—²ç‰©ç†é¡µã€‚ç”±äºæ¯ä¸ªCPUä¸€ä¸ªé”ï¼Œå› æ­¤å¯ä»¥ä½¿å¾—å¤šä¸ªCPUåŒæ—¶è°ƒç”¨<code>kalloc()</code>å‡½æ•°å¹¶åˆ†é…å„è‡ªé“¾è¡¨ä¸Šçš„ç©ºé—²ç‰©ç†é¡µï¼Œæé«˜äº†å¹¶è¡Œåº¦ã€‚</p><p>åœ¨å½“å‰CPUé“¾è¡¨ä¸ºç©ºæ—¶ï¼Œä¾æ¬¡éå†å…¶ä»–CPUçš„é“¾è¡¨ï¼Œå½“é‡åˆ°éç©ºçš„CPUé“¾è¡¨ï¼Œåˆ™çªƒå–è¯¥é“¾è¡¨å¤´éƒ¨çš„ç©ºé—²ç‰©ç†é¡µï¼Œçªƒå–è¿‡ç¨‹ä¸­åº”åŠ ä¸Šè¢«çªƒå–CPUé“¾è¡¨çš„é”ã€‚</p><p>æœ‰ä¸ªç»†èŠ‚æ˜¯åœ¨çªƒå–ä¹‹å‰ï¼Œåº”å…ˆé‡Šæ”¾å½“å‰CPUé“¾è¡¨çš„é”ï¼Œé˜²æ­¢ä¹‹åçªƒå–è¿‡ç¨‹å‘ç”Ÿæ­»é”ï¼Œæ‰€çªƒå–çš„ç‰©ç†é¡µä¹‹åç›´æ¥ä½œä¸ºè¿”å›å€¼è¿”å›äº†ï¼Œä¹Ÿä¸éœ€è¦å†æ“ä½œå½“å‰é“¾è¡¨ã€‚åœ¨æœ€åˆçš„å°è¯•ä¸­ï¼Œæƒ³æ³•æ˜¯æ¯æ¬¡ä»å…¶ä»–éç©ºçš„CPUé“¾è¡¨ä¸­çªƒå–ä¸€åŠçš„ç©ºé—²ç‰©ç†é¡µåˆ°å½“å‰CPUé“¾è¡¨ï¼Œä½†æ˜¯æ— å¥ˆéœ€è¦åŒæ—¶åŠ ä¸Šä¸¤ä¸ªé”ï¼Œä¼šå‘ç”Ÿæ­»é”ã€‚</p><p>ä¿®æ”¹åçš„<code>kalloc()</code>å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">kalloc</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">run</span> *<span class="hljs-title">r</span>;</span><br>  <br>  push_off();<br>  <span class="hljs-keyword">int</span> cpu = cpuid();<br>  acquire(&amp;kmem[cpu].lock);<br>  r = kmem[cpu].freelist;<br>  <span class="hljs-keyword">if</span>(r) &#123;<br>    kmem[cpu].freelist = r-&gt;next;<br>    release(&amp;kmem[cpu].lock);<br>  &#125;<span class="hljs-keyword">else</span> &#123;<br>    release(&amp;kmem[cpu].lock);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> nextid = <span class="hljs-number">0</span>; nextid &lt; NCPU; nextid++) &#123;<br>      <span class="hljs-keyword">if</span>(cpu != nextid) &#123;<br>        acquire(&amp;kmem[nextid].lock);<br>        r = kmem[nextid].freelist;<br>        <span class="hljs-keyword">if</span>(r) &#123;<br>          kmem[nextid].freelist = r-&gt;next;<br>          release(&amp;kmem[nextid].lock);<br>          <span class="hljs-keyword">break</span>;<br>        &#125;<br>        release(&amp;kmem[nextid].lock);<br>      &#125;<br>    &#125;<br>  &#125;<br>  pop_off();<br>  <br>  <span class="hljs-keyword">if</span>(r)<br>    <span class="hljs-built_in">memset</span>((<span class="hljs-keyword">char</span>*)r, <span class="hljs-number">5</span>, PGSIZE); <span class="hljs-comment">// fill with junk</span><br>  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">void</span>*)r;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>ä¿®æ”¹<code>kfree()</code>å‡½æ•°</li></ol><p><code>kfree()</code>å‡½æ•°çš„ä¿®æ”¹ç›¸å¯¹ç®€å•ï¼Œåªè¦æŠŠè¢«é‡Šæ”¾çš„ç‰©ç†é¡µæ”¾åˆ°å½“å‰CPUé“¾è¡¨çš„å¤´éƒ¨å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">kfree</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *pa)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">run</span> *<span class="hljs-title">r</span>;</span><br><br>  <span class="hljs-keyword">if</span>(((uint64)pa % PGSIZE) != <span class="hljs-number">0</span> || (<span class="hljs-keyword">char</span>*)pa &lt; end || (uint64)pa &gt;= PHYSTOP)<br>    panic(<span class="hljs-string">&quot;kfree&quot;</span>);<br><br>  <span class="hljs-comment">// Fill with junk to catch dangling refs.</span><br>  <span class="hljs-built_in">memset</span>(pa, <span class="hljs-number">1</span>, PGSIZE);<br><br>  r = (struct run*)pa;<br><br>  push_off();<br>  <span class="hljs-keyword">int</span> cpu = cpuid();<br>  acquire(&amp;kmem[cpu].lock);<br>  r-&gt;next = kmem[cpu].freelist;<br>  kmem[cpu].freelist = r;<br>  release(&amp;kmem[cpu].lock);<br>  pop_off();<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="è¿è¡Œç»“æœ"><a href="#è¿è¡Œç»“æœ" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h5><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210620172413.png" alt="image-20210620172413597"></p><h4 id="Buffer-cache"><a href="#Buffer-cache" class="headerlink" title="Buffer cache"></a>Buffer cache</h4><h5 id="ä»»åŠ¡-1"><a href="#ä»»åŠ¡-1" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>buffer cacheä½äºxv6æ–‡ä»¶ç³»ç»Ÿä¸­çš„Diskä¸Šå±‚ã€Loggingä¸‹å±‚ï¼Œç”¨äºç¼“å­˜ç£ç›˜å—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210620172804.png" alt="image-20210620172804214" style="zoom: 50%;" /><p>åœ¨åŸæœ¬çš„buffer cacheè®¾è®¡ä¸­ï¼Œå¤šä¸ªbufferå—ç”¨ä¸€ä¸ªåŒå‘é“¾è¡¨æ¥ç»„ç»‡ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªé”(bcache.lock)æ¥é¿å…è·å–å’Œé‡Šæ”¾ä¸­çš„race conditionï¼Œé€šè¿‡LRUç®—æ³•æ¥æ·˜æ±°bufferã€‚</p><p>ç”±æ­¤å¯è§ï¼Œåªæœ‰ä¸€ä¸ªé”ï¼Œé€ æˆäº†å¤§é‡çš„é”çš„äº‰ç”¨ï¼Œè¯¥éƒ¨åˆ†çš„ä»»åŠ¡ä»ç„¶æ˜¯ä¿®æ”¹buffer cacheçš„æ•°æ®ç»“æ„å’ŒåŠ é”ç­–ç•¥æ¥å‡å°‘äº‰ç”¨ï¼Œæé«˜å¹¶è¡Œåº¦ã€‚</p><p>å‡å°‘buffer cacheä¸­çš„äº‰ç”¨æ¯”kallocçš„æ›´ä¸ºå¤æ‚ï¼Œå› ä¸ºbuffer cacheæ˜¯è¢«è¿›ç¨‹ï¼ˆå¤šä¸ªCPUï¼‰å…±äº«çš„ï¼Œä¸èƒ½åƒkallocä¸€æ ·æ¯ä¸ªCPUæœ‰ä¸€ä¸ªè‡ªå·±çš„ç©ºé—²ç‰©ç†é¡µé“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨ä¸Šçš„ç©ºç™½ç‰©ç†é¡µéƒ½æ˜¯ç­‰åŒçš„ï¼Œåˆ†é…æ—¶ä¸éœ€è¦è€ƒè™‘ç©¶ç«Ÿæ˜¯å“ªä¸ªç‰©ç†é¡µï¼Œä½†æ˜¯buffer cacheä¸­çš„æ¯ä¸ªbufferå´æ˜¯ä¸åŒçš„ã€‚</p><p>è§£å†³åŠæ³•æ˜¯ä½¿ç”¨hashè¡¨ï¼ŒåŒæ—¶æ¯ä¸ªhash bucketæœ‰ä¸€ä¸ªé”ã€‚</p><h5 id="è¿‡ç¨‹-1"><a href="#è¿‡ç¨‹-1" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><ol><li>ä¿®æ”¹æ•°æ®ç»“æ„ä¸ºhashè¡¨</li></ol><p>ä¹‹å‰çš„bufferé‡‡ç”¨åŒå‘é“¾è¡¨ç»„ç»‡ï¼Œä¸ºé™ä½é”çš„ç²’åº¦ï¼Œå¯ä»¥ä½¿ç”¨hashè¡¨æ¥ç»„ç»‡ï¼Œæ ¹æ®å—å·(blockno)è¿›è¡Œhashï¼Œå°†bufferåˆ†å¸ƒåˆ°ç›¸åº”çš„bucketä¸­å»ã€‚æ¯ä¸ªhash bucketä¸­çš„bufferåŒæ ·é‡‡ç”¨åŒå‘é“¾è¡¨ç»„ç»‡ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ï¼Œæ¯ä¸ªbucketé“¾è¡¨æœ‰ä¸€ä¸ªbufä½œä¸ºdummyç»“ç‚¹ï¼Œç”¨ä½œé“¾è¡¨å¤´ã€‚</p><p>æ¯ä¸ªbucketæœ‰ä¸€ä¸ªé”ï¼Œè¿™æ ·è·å–å’Œåˆ†é…æ—¶å¯ç›´æ¥é’ˆå¯¹æŸä¸ªbucketè¿›è¡Œï¼Œå®ç°ä¸åŒbucketé—´çš„å¹¶è¡Œã€‚</p><p>åŒæ—¶æ¯ä¸ªbufferç»´æŠ¤ä¸€ä¸ªticksä½œä¸ºæ—¶é—´æˆ³ï¼Œç”¨æ¥å®ç°LRUç®—æ³•ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/buf.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> &#123;</span><br>  <span class="hljs-keyword">int</span> valid;   <span class="hljs-comment">// has data been read from disk?</span><br>  <span class="hljs-keyword">int</span> disk;    <span class="hljs-comment">// does disk &quot;own&quot; buf?</span><br>  uint dev;<br>  uint blockno;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sleeplock</span> <span class="hljs-title">lock</span>;</span><br>  uint refcnt;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">prev</span>;</span> <span class="hljs-comment">// LRU cache list</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">next</span>;</span><br>  uchar data[BSIZE];<br><br>  uint ticks;<br>&#125;;<br><br><span class="hljs-comment">// kernel/bio.c</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NBUCKET 13</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spinlock</span> <span class="hljs-title">lock</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> <span class="hljs-title">buf</span>[<span class="hljs-title">NBUF</span>];</span><br><br>  <span class="hljs-comment">// Linked list of all buffers, through prev/next.</span><br>  <span class="hljs-comment">// Sorted by how recently the buffer was used.</span><br>  <span class="hljs-comment">// head.next is most recent, head.prev is least.</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> <span class="hljs-title">head</span>;</span><br><br>  <span class="hljs-comment">// Hash bucket</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> <span class="hljs-title">bucket</span>[<span class="hljs-title">NBUCKET</span>];</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spinlock</span> <span class="hljs-title">bucket_lock</span>[<span class="hljs-title">NBUCKET</span>];</span><br>&#125; bcache;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">hash</span><span class="hljs-params">(uint blockno)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">return</span> blockno % NBUCKET;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">binit</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">b</span>;</span><br><br>  initlock(&amp;bcache.lock, <span class="hljs-string">&quot;bcache&quot;</span>);<br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NBUCKET; i++) &#123;<br>    initlock(&amp;bcache.bucket_lock[i], <span class="hljs-string">&quot;bcache.bucket&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NBUCKET; i++) &#123;<br>    bcache.bucket[i].next = &amp;bcache.bucket[i];<br>    bcache.bucket[i].prev = &amp;bcache.bucket[i];<br>  &#125;<br>  <br>  <span class="hljs-comment">// Create hash table of buffers</span><br>  <span class="hljs-keyword">for</span>(b = bcache.buf; b &lt; bcache.buf+NBUF; b++)&#123;<br>    <span class="hljs-keyword">int</span> i = hash(b-&gt;blockno);<br>    b-&gt;next = bcache.bucket[i].next;<br>    b-&gt;prev = &amp;bcache.bucket[i];<br><br>    bcache.bucket[i].next-&gt;prev = b;<br>    bcache.bucket[i].next = b;<br>    b-&gt;ticks = ticks;<br>    initsleeplock(&amp;b-&gt;lock, <span class="hljs-string">&quot;buffer&quot;</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>ä¿®æ”¹<code>bget()</code>å‡½æ•°</li></ol><p><code>bget()</code>å‡½æ•°å¯åˆ†ä¸ºä¸¤æ­¥è¿›è¡Œï¼š</p><p>ç¬¬ä¸€æ­¥ï¼šé¦–å…ˆæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ç»™å®šdevå’Œblocknoçš„bufferï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ä½¿ç”¨æ­¤bufferå¹¶è¿”å›ï¼›</p><p>ç¬¬äºŒæ­¥ï¼šå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å¯»æ‰¾ä¸€ä¸ªLRUæœªä½¿ç”¨çš„bufferå¹¶è¿”å›ã€‚</p><p>è¿™é‡Œé¢å®ç°æ—¶æœ‰å¾ˆå¤šéœ€è¦æ³¨æ„çš„ç»†èŠ‚ï¼š</p><ul><li><p>bufä¸ºå…±äº«å˜é‡ï¼Œè®¿é—®å…¶ä¸­çš„å˜é‡æ—¶(å¦‚refcnt)éœ€è¦åŠ bufæ‰€åœ¨bucketçš„é”æ¥äº’æ–¥è®¿é—®ã€‚</p></li><li><p><code>hi = hash(blockno)</code>ï¼Œç¬¬ä¸€æ­¥åº”è¯¥ä»bucket hiä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæœªæŸ¥æ‰¾åˆ°ï¼Œæ‰§è¡Œç¬¬äºŒæ­¥ï¼Œç¬¬äºŒæ­¥ä»å…¶ä»–bucketä¸­æŸ¥æ‰¾æœªä½¿ç”¨bufferï¼Œå¹¶å°†è¯¥bufferæ·»åŠ åˆ°bucket hiä¸­ï¼ˆå¦‚æœä¸åœ¨åŒä¸€bucketä¸Šï¼‰ã€‚</p></li><li><p>ç¬¬äºŒæ­¥å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå¤§é”æ¥ä½¿å…¶ä¸²è¡ŒåŒ–ï¼Œå¦‚æœä¸åŠ æœ‰ä¸‹é¢å‡ ç§å¯èƒ½åšæ³•ä»¥åŠå‡ºç°çš„é—®é¢˜ï¼š</p><ul><li>ç¬¬ä¸€æ­¥ä¸­bucket hiçš„é”ä¸é‡Šæ”¾ï¼šä¸€ä¸ªCPUæŒæœ‰bucket hiçš„é”ï¼Œå¸Œæœ›éå†bucket Bå¹¶ç”³è¯·Bçš„é”ï¼ŒåŒæ—¶å¦ä¸€ä¸ªCPUæŒæœ‰bucket Bé”ï¼Œå¸Œæœ›éå†bucket hiå¹¶ç”³è¯·hiçš„é”ï¼Œåˆ™å‘ç”Ÿæ­»é”ï¼›</li><li>ç¬¬ä¸€æ­¥bucket hiçš„é”é‡Šæ”¾ï¼Œç¬¬äºŒæ­¥ä½¿ç”¨å…¨å±€çš„LRUæŸ¥æ‰¾æ‰€æœ‰çš„bucketä¸­æœªä½¿ç”¨çš„bufferï¼Œä¸¤ä¸ªCPUåŒæ—¶å¯»æ‰¾devå’Œblocknoç›¸åŒçš„bufferï¼Œç¬¬ä¸€æ­¥æœªæ‰¾åˆ°ï¼ŒåŒæ—¶å¯»æ‰¾åˆ°äº†ä¸€ä¸ªæœªä½¿ç”¨bufferï¼Œä½†è¿™ä¸¤ä¸ªå¯»æ‰¾åˆ°çš„bufferä¸åŒï¼Œè¿åäº†<code>the invariant that at most one copy of each block is cached</code>çš„è¦æ±‚ï¼Œä¸€ä¸ªå—æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªbufferï¼Œä¼šå‡ºç°<code>panic: freeing free block</code>çš„é”™è¯¯ï¼›</li></ul></li><li><p>ä½¿ç”¨äº†å¤§é”æ¥ä½¿å¾—ç¬¬äºŒæ­¥çš„æ·˜æ±°è¿‡ç¨‹ä¸²è¡ŒåŒ–æ—¶ï¼Œé¦–å…ˆåº”åœ¨ç¬¬äºŒæ­¥å¼€å§‹å†æ¬¡å¯»æ‰¾ä¸€ébufferï¼ŒåŸå› æ˜¯ä¸¤ä¸ªCPUåŒæ—¶å¯»æ‰¾devå’Œblocknoç›¸åŒçš„bufferï¼Œç¬¬ä¸€æ­¥æœªæ‰¾åˆ°ï¼Œç¬¬ä¸€ä¸ªCPUé€šè¿‡åŠ é”è¿è¡Œç¬¬äºŒæ­¥æ‰¾åˆ°ä¸€ä¸ªbufferï¼Œé‡Šæ”¾é”åç¬¬äºŒä¸ªCPUè¿è¡Œç¬¬äºŒæ­¥ï¼Œæ­¤æ—¶ç¬¬ä¸€ä¸ªCPUå·²ç»å°†æ‰¾åˆ°çš„bufferä½œä¸ºè¯¥devå’Œblocknoçš„bufferï¼Œå¦‚æœç¬¬äºŒä¸ªCPUå†æ¬¡å¯»æ‰¾ä¸€ä¸ªæ–°çš„bufferä½œä¸ºç›¸åŒdevå’Œblocknoçš„bufferï¼Œåˆ™åŒæ ·è¿åäº†<code>the invariant that at most one copy of each block is cached</code>çš„è¦æ±‚ï¼›å› æ­¤åœ¨ç¬¬äºŒæ­¥åº”é¦–å…ˆå†æ¬¡åœ¨ç›¸åº”çš„bucket hiä¸­æ‰¾ä¸€æ¬¡ï¼Œå¦‚æœä¹‹å‰å·²ç»æœ‰CPUæ‰¾åˆ°äº†è¯¥bufferï¼Œç›´æ¥ä½¿ç”¨å³å¯ã€‚</p></li><li><p>å°½é‡é¿å…åŒæ—¶åŠ ä¸¤æŠŠé”ï¼Œè¿™å°†æœ‰å¯èƒ½å¯¼è‡´æ­»é”ã€‚</p></li></ul><p>çœ‹ç½‘ä¸Šçš„å®ç°è¿˜æœ‰æ–¹å¼æ˜¯<code>bget()</code>æ ¹æ®<code>hi = hash(bockno)</code>ç›´æ¥ä»bucket hiçš„é“¾è¡¨ä¸­å¯»æ‰¾ï¼Œå¯»æ‰¾ä¸åˆ°åé€šè¿‡å±€éƒ¨çš„LRUåªä»hiçš„é“¾è¡¨ä¸­å»å¯»æ‰¾æœªä½¿ç”¨çš„bufferï¼Œè¿™æ ·å¯ä»¥ç§»é™¤ç¬¬äºŒæ­¥çš„å¤§é”ï¼Œè€Œä¸”å®ç°èµ·æ¥è¿˜æŒºç®€å•ï¼Œä¸è¿‡ä¼¼ä¹ä¸ç¬¦åˆhintsä¸­çš„å®ç°æ–¹å¼ï¼Œæ„Ÿè§‰å±€éƒ¨LRUæ›´å®¹æ˜“äº§ç”Ÿ<code>panic(&quot;bget: no buffers&quot;);</code>ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Look through buffer cache for block on device dev.</span><br><span class="hljs-comment">// If not found, allocate a buffer.</span><br><span class="hljs-comment">// In either case, return locked buffer.</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> struct buf*</span><br><span class="hljs-function"><span class="hljs-title">bget</span><span class="hljs-params">(uint dev, uint blockno)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">b</span>;</span><br>  <span class="hljs-keyword">int</span> hi = hash(blockno); <br>  <br>  <span class="hljs-comment">// Find cache from bucket hi.</span><br>  acquire(&amp;bcache.bucket_lock[hi]);<br>  <span class="hljs-keyword">for</span>(b = bcache.bucket[hi].next; b != &amp;bcache.bucket[hi]; b = b-&gt;next) &#123;<br>    <span class="hljs-keyword">if</span>(b-&gt;dev == dev &amp;&amp; b-&gt;blockno == blockno) &#123;<br>      b-&gt;refcnt++;<br>      release(&amp;bcache.bucket_lock[hi]);<br>      acquiresleep(&amp;b-&gt;lock);<br>      <span class="hljs-keyword">return</span> b;<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// Release lock hi, avoid deadlock.</span><br>  release(&amp;bcache.bucket_lock[hi]);<br><br>  <span class="hljs-comment">// Steal lock makes the eviction serialized in bget.</span><br>  acquire(&amp;bcache.lock);<br><br>  <span class="hljs-comment">// Check again cache to maintain the invariant that at most one copy of each block is cached. </span><br>  acquire(&amp;bcache.bucket_lock[hi]);<br>  <span class="hljs-keyword">for</span>(b = bcache.bucket[hi].next; b != &amp;bcache.bucket[hi]; b = b-&gt;next) &#123;<br>    <span class="hljs-keyword">if</span>(b-&gt;dev == dev &amp;&amp; b-&gt;blockno == blockno) &#123;<br>      b-&gt;refcnt++;<br>      release(&amp;bcache.bucket_lock[hi]);<br>      release(&amp;bcache.lock);<br>      acquiresleep(&amp;b-&gt;lock);<br>      <span class="hljs-keyword">return</span> b;<br>    &#125;<br>  &#125;<br>  release(&amp;bcache.bucket_lock[hi]);<br>  <br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">buf</span> *<span class="hljs-title">minb</span> =</span> <span class="hljs-number">0</span>;<br>  uint min_ticks = ~<span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">// Find Recycle the least recently used (LRU) unused buffer.</span><br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NBUCKET; i++) &#123;<br>    acquire(&amp;bcache.bucket_lock[i]);<br>    <span class="hljs-keyword">int</span> find = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(b = bcache.bucket[i].next; b != &amp;bcache.bucket[i]; b = b-&gt;next) &#123;<br>      <span class="hljs-keyword">if</span>(b-&gt;refcnt == <span class="hljs-number">0</span> &amp;&amp; b-&gt;ticks &lt; min_ticks) &#123;<br>        <span class="hljs-keyword">if</span>(minb != <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-keyword">int</span> last = hash(minb-&gt;blockno);<br>          <span class="hljs-keyword">if</span>(last != i)<br>            release(&amp;bcache.bucket_lock[last]);<br>        &#125;<br>        <br>        min_ticks = b-&gt;ticks;<br>        minb = b;<br>        find = <span class="hljs-number">1</span>;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(!find)<br>      release(&amp;bcache.bucket_lock[i]);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(minb == <span class="hljs-number">0</span>)<br>    panic(<span class="hljs-string">&quot;bget: no buffers&quot;</span>);<br>  <br>  <span class="hljs-keyword">int</span> minb_i = hash(minb-&gt;blockno);<br><br>  minb-&gt;dev = dev;<br>  minb-&gt;blockno = blockno;<br>  minb-&gt;valid = <span class="hljs-number">0</span>;<br>  minb-&gt;refcnt = <span class="hljs-number">1</span>;<br><br>  <span class="hljs-keyword">if</span> (minb_i != hi) &#123;<br>    minb-&gt;prev-&gt;next = minb-&gt;next;<br>    minb-&gt;next-&gt;prev = minb-&gt;prev;<br>  &#125;<br>  release(&amp;bcache.bucket_lock[minb_i]);<br>  <br>  <span class="hljs-keyword">if</span>(minb_i != hi) &#123;<br>    <span class="hljs-comment">// Move the buf from original bucket to bucket hi.</span><br>    acquire(&amp;bcache.bucket_lock[hi]);<br><br>    minb-&gt;next = bcache.bucket[hi].next;<br>    minb-&gt;prev = &amp;bcache.bucket[hi];<br>    bcache.bucket[hi].next-&gt;prev = minb;<br>    bcache.bucket[hi].next = minb;<br><br>    release(&amp;bcache.bucket_lock[hi]);<br>  &#125;<br><br>  release(&amp;bcache.lock);<br><br>  acquiresleep(&amp;minb-&gt;lock);<br><br>  <span class="hljs-keyword">return</span> minb;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>ä¿®æ”¹<code>brelse()</code>å‡½æ•°</li></ol><p><code>brelse()</code>çš„ä¿®æ”¹åˆ™æ¯”è¾ƒç®€å•ï¼Œç›´æ¥å°†bufferçš„å¼•ç”¨æ•°-1ï¼Œå¦‚æœä¹‹åæœªè¢«å¼•ç”¨çš„è¯ï¼Œæ›´æ–°ticksï¼Œè¡¨ç¤ºä¸ºæœ€æ–°çš„æœªä½¿ç”¨çš„bufferï¼Œç”¨äºLRUç®—æ³•å¯»æ‰¾æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„unused bufferã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Release a locked buffer.</span><br><span class="hljs-comment">// Move to the head of the most-recently-used list.</span><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">brelse</span><span class="hljs-params">(struct buf *b)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span>(!holdingsleep(&amp;b-&gt;lock))<br>    panic(<span class="hljs-string">&quot;brelse&quot;</span>);<br><br>  releasesleep(&amp;b-&gt;lock);<br><br>  <span class="hljs-keyword">int</span> hi = hash(b-&gt;blockno);<br>  acquire(&amp;bcache.bucket_lock[hi]);<br>  b-&gt;refcnt--;<br>  <span class="hljs-keyword">if</span> (b-&gt;refcnt == <span class="hljs-number">0</span>) &#123;<br>    b-&gt;ticks = ticks;<br>  &#125;<br>  release(&amp;bcache.bucket_lock[hi]);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>ä¿®æ”¹<code>bpin()</code>å’Œ<code>bunpin()</code></li></ol><p>æ›´æ–°bufferçš„å¼•ç”¨æ•°æ—¶ï¼Œåº”åŠ é”ï¼Œå¼•ç”¨æ•°ä¸ºå…±äº«å˜é‡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">bpin</span><span class="hljs-params">(struct buf *b)</span> </span>&#123;<br>  <span class="hljs-keyword">int</span> hi = hash(b-&gt;blockno);<br>  acquire(&amp;bcache.bucket_lock[hi]);<br>  b-&gt;refcnt++;<br>  release(&amp;bcache.bucket_lock[hi]);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">bunpin</span><span class="hljs-params">(struct buf *b)</span> </span>&#123;<br>  <span class="hljs-keyword">int</span> hi = hash(b-&gt;blockno);<br>  acquire(&amp;bcache.bucket_lock[hi]);<br>  b-&gt;refcnt--;<br>  release(&amp;bcache.bucket_lock[hi]);<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="è¿è¡Œç»“æœ-1"><a href="#è¿è¡Œç»“æœ-1" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h5><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210622153929.png" alt="image-20210622153929205"></p><h4 id="å®éªŒæµ‹è¯•"><a href="#å®éªŒæµ‹è¯•" class="headerlink" title="å®éªŒæµ‹è¯•"></a>å®éªŒæµ‹è¯•</h4><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210622161745.png" alt="image-20210622161745154"></p><h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><p><a href="https://github.com/whileskies/xv6-labs-2020/tree/lock">https://github.com/whileskies/xv6-labs-2020/tree/lock</a></p>]]></content>
    
    
    <categories>
      
      <category>OS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6.S081-Lab7: Multithreading</title>
    <link href="/2021/07/11/6-S081-Lab7-Multithreading/"/>
    <url>/2021/07/11/6-S081-Lab7-Multithreading/</url>
    
    <content type="html"><![CDATA[<h2 id="Lab7-Multithreading"><a href="#Lab7-Multithreading" class="headerlink" title="Lab7: Multithreading"></a>Lab7: Multithreading</h2><p>lab7ä¸ºä¸‰ä¸ªå¤šçº¿ç¨‹ç›¸å…³çš„ä»»åŠ¡ï¼šå®ç°ç”¨æˆ·æ€çº¿ç¨‹ã€ä½¿ç”¨å¤šçº¿ç¨‹åŠ é€Ÿç¨‹åºã€å®ç°ä¸€ä¸ªçº¿ç¨‹å±éšœã€‚</p><h4 id="Uthread-switching-between-threads"><a href="#Uthread-switching-between-threads" class="headerlink" title="Uthread: switching between threads"></a>Uthread: switching between threads</h4><h5 id="ä»»åŠ¡"><a href="#ä»»åŠ¡" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>è®¾è®¡å¹¶å®ç°ä¸€ä¸ªç”¨æˆ·æ€çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æœºåˆ¶ï¼ˆå…¶å®ç±»ä¼¼äºåç¨‹ï¼‰ã€‚</p><h5 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><ol><li>å®šä¹‰<code>context</code>ç»“æ„ï¼Œç”¨äºä¿å­˜ä¸Šä¸‹æ–‡å¯„å­˜å™¨</li></ol><p>å½“ä»ä¸€ä¸ªçº¿ç¨‹åˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œéœ€è¦ä¿å­˜åˆ‡æ¢å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œæ¢å¤åˆ‡æ¢åçº¿ç¨‹çš„ä¸Šä¸‹æ–‡ã€‚åœ¨ä¿å­˜æ—¶å¯ä»¥å‚è€ƒxv6ä¸­å†…æ ¸çº¿ç¨‹çš„åˆ‡æ¢ï¼Œåªç”¨ä¿å­˜è¢«è°ƒç”¨è€…ä¿å­˜çš„å¯„å­˜å™¨å³å¯ï¼Œå› ä¸ºéœ€è¦è°ƒç”¨è€…ä¿å­˜çš„å¯„å­˜å™¨éƒ½å·²ç»å­˜å‚¨åœ¨çº¿ç¨‹çš„æ ˆä¸­äº†ã€‚</p><p>é™¤æ­¤ä¹‹å¤–è¿˜åº”ä¿å­˜ä¸¤ä¸ªé‡è¦çš„å¯„å­˜å™¨ï¼šraã€spï¼Œraç›¸å½“äºä¿å­˜äº†pcå¯„å­˜å™¨ï¼Œç”¨æˆ·æ¢å¤åˆ°ä¹‹å‰åˆ‡æ¢çš„åœ°æ–¹ç»§ç»­æ‰§è¡Œï¼›spä¿å­˜äº†çº¿ç¨‹æ ˆé¡¶æŒ‡é’ˆï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½éœ€è¦åœ¨æ ˆä¸­æ‰§è¡Œã€‚</p><p>åœ¨<code>user/uthread.c </code>ä¸­å®šä¹‰<code>context</code>ç»“æ„ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">context</span> &#123;</span><br>  uint64 ra;<br>  uint64 sp;<br><br>  <span class="hljs-comment">// callee-saved</span><br>  uint64 s0;<br>  uint64 s1;<br>  uint64 s2;<br>  uint64 s3;<br>  uint64 s4;<br>  uint64 s5;<br>  uint64 s6;<br>  uint64 s7;<br>  uint64 s8;<br>  uint64 s9;<br>  uint64 s10;<br>  uint64 s11;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å°†<code>context</code>ç»“æ„ä½“æ·»åŠ è‡³<code>thread</code>ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">thread</span> &#123;</span><br>  <span class="hljs-keyword">char</span>       <span class="hljs-built_in">stack</span>[STACK_SIZE]; <span class="hljs-comment">/* the thread&#x27;s stack */</span><br>  <span class="hljs-keyword">int</span>        state;             <span class="hljs-comment">/* FREE, RUNNING, RUNNABLE */</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">context</span> <span class="hljs-title">context</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><ol start="2"><li>çº¿ç¨‹åˆ‡æ¢æ±‡ç¼–</li></ol><p>ç”¨æˆ·çº¿ç¨‹çš„åˆ‡æ¢æ±‡ç¼–ä»£ç å‚è€ƒäº†(å¤åˆ¶äº†)å†…æ ¸çº¿ç¨‹åˆ‡æ¢çš„æ±‡ç¼–ä»£ç ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c">thread_switch:<br><span class="hljs-comment">/* YOUR CODE HERE */</span><br>sd ra, <span class="hljs-number">0</span>(a0)<br>sd sp, <span class="hljs-number">8</span>(a0)<br>sd s0, <span class="hljs-number">16</span>(a0)<br>sd s1, <span class="hljs-number">24</span>(a0)<br>sd s2, <span class="hljs-number">32</span>(a0)<br>sd s3, <span class="hljs-number">40</span>(a0)<br>sd s4, <span class="hljs-number">48</span>(a0)<br>sd s5, <span class="hljs-number">56</span>(a0)<br>sd s6, <span class="hljs-number">64</span>(a0)<br>sd s7, <span class="hljs-number">72</span>(a0)<br>sd s8, <span class="hljs-number">80</span>(a0)<br>sd s9, <span class="hljs-number">88</span>(a0)<br>sd s10, <span class="hljs-number">96</span>(a0)<br>sd s11, <span class="hljs-number">104</span>(a0)<br><br>ld ra, <span class="hljs-number">0</span>(a1)<br>ld sp, <span class="hljs-number">8</span>(a1)<br>ld s0, <span class="hljs-number">16</span>(a1)<br>ld s1, <span class="hljs-number">24</span>(a1)<br>ld s2, <span class="hljs-number">32</span>(a1)<br>ld s3, <span class="hljs-number">40</span>(a1)<br>ld s4, <span class="hljs-number">48</span>(a1)<br>ld s5, <span class="hljs-number">56</span>(a1)<br>ld s6, <span class="hljs-number">64</span>(a1)<br>ld s7, <span class="hljs-number">72</span>(a1)<br>ld s8, <span class="hljs-number">80</span>(a1)<br>ld s9, <span class="hljs-number">88</span>(a1)<br>ld s10, <span class="hljs-number">96</span>(a1)<br>ld s11, <span class="hljs-number">104</span>(a1)<br>ret    <span class="hljs-comment">/* return to ra */</span><br></code></pre></td></tr></table></figure><p>å£°æ˜çº¿ç¨‹åˆ‡æ¢çš„å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> <span class="hljs-title">thread_switch</span><span class="hljs-params">(struct context*, struct context*)</span></span><br></code></pre></td></tr></table></figure><ol start="3"><li>çº¿ç¨‹åˆå§‹åŒ–</li></ol><p>çº¿ç¨‹åˆå§‹åŒ–æ—¶ï¼Œå°†raè®¾ä¸ºå‡½æ•°åœ°å€ï¼Œspè®¾ä¸ºè¯¥çº¿ç¨‹çš„å †æ ˆï¼Œç­‰è°ƒåº¦åˆ°è¯¥çº¿ç¨‹æ—¶ï¼Œçº¿ç¨‹å°±å¯æ‰§è¡Œæ‰€ç»‘å®šçš„å‡½æ•°ï¼Œéœ€è¦æ³¨æ„æ ˆæ˜¯ä»é«˜åœ°å€å‘ä½åœ°å€å¢é•¿çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> </span><br><span class="hljs-function"><span class="hljs-title">thread_create</span><span class="hljs-params">(<span class="hljs-keyword">void</span> (*func)())</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">thread</span> *<span class="hljs-title">t</span>;</span><br><br>  <span class="hljs-keyword">for</span> (t = all_thread; t &lt; all_thread + MAX_THREAD; t++) &#123;<br>    <span class="hljs-keyword">if</span> (t-&gt;state == FREE) <span class="hljs-keyword">break</span>;<br>  &#125;<br>  t-&gt;state = RUNNABLE;<br>  <span class="hljs-comment">// YOUR CODE HERE</span><br>  t-&gt;context.sp = (uint64)t-&gt;<span class="hljs-built_in">stack</span> + STACK_SIZE;<br>  t-&gt;context.ra = (uint64)func;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>çº¿ç¨‹åˆ‡æ¢</li></ol><p>å½“ä¸€ä¸ªçº¿ç¨‹ä¸»åŠ¨è°ƒç”¨<code>thread_yield</code>å‡½æ•°æ—¶ï¼Œæ”¾å¼ƒCPUçš„æ§åˆ¶æƒï¼Œå°†å…¶äº¤ç»™è°ƒåº¦å™¨ï¼Œè°ƒåº¦å™¨å‡½æ•°æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¯æ‰§è¡Œçš„çº¿ç¨‹ï¼Œåˆ‡æ¢åˆ°è¯¥çº¿ç¨‹è¿›è¡Œæ‰§è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (current_thread != next_thread) &#123;         <span class="hljs-comment">/* switch threads?  */</span><br>    next_thread-&gt;state = RUNNING;<br>    t = current_thread;<br>    current_thread = next_thread;<br>    <span class="hljs-comment">/* YOUR CODE HERE</span><br><span class="hljs-comment">     * Invoke thread_switch to switch from t to next_thread:</span><br><span class="hljs-comment">     * thread_switch(??, ??);</span><br><span class="hljs-comment">     */</span><br>    thread_switch(&amp;t-&gt;context, &amp;next_thread-&gt;context);<br>&#125; <span class="hljs-keyword">else</span><br>    next_thread = <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><h5 id="è¿è¡Œç»“æœ"><a href="#è¿è¡Œç»“æœ" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h5><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210527203130.png" alt="image-20210527203123223"></p><h4 id="Using-threads"><a href="#Using-threads" class="headerlink" title="Using threads"></a>Using threads</h4><h5 id="ä»»åŠ¡-1"><a href="#ä»»åŠ¡-1" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>åœ¨hashè¡¨ä¸­ä½¿ç”¨å¤šçº¿ç¨‹å’Œé”ï¼Œç”¨äºåŠ å¿«ç¨‹åºè¿è¡Œé€Ÿåº¦ã€‚åœ¨linuxä¸­ä½¿ç”¨<code>pthread</code>åº“æ¥å®Œæˆï¼Œå¹¶éxv6ã€‚</p><h5 id="è¿‡ç¨‹-1"><a href="#è¿‡ç¨‹-1" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><ol><li>race condition</li></ol><p>å¯¹hashè¡¨æ‰§è¡Œæ’å…¥å…ƒç´ çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> </span><br><span class="hljs-function"><span class="hljs-title">insert</span><span class="hljs-params">(<span class="hljs-keyword">int</span> key, <span class="hljs-keyword">int</span> value, struct entry **p, struct entry *n)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">entry</span> *<span class="hljs-title">e</span> =</span> <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(struct entry));<br>  e-&gt;key = key;<br>  e-&gt;value = value;<br>  e-&gt;next = n;<br>  *p = e;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨æ’å…¥å…ƒç´ æ—¶ï¼Œé¦–å…ˆé€šè¿‡å¯¹keyè¿›è¡Œhashæ‰¾åˆ°ç›¸åº”çš„é“¾è¡¨ï¼Œå°†æ–°æ’å…¥çš„å…ƒç´ ä½œä¸ºé“¾è¡¨å¤´ï¼Œä¹‹å‰çš„é“¾è¡¨æ¥åˆ°æ–°æ’å…¥å…ƒç´ çš„åé¢ã€‚å½“å•çº¿ç¨‹æ—¶è‚¯å®šèƒ½æ­£å¸¸æ‰§è¡Œï¼Œä¸ä¼šäº§ç”Ÿé—®é¢˜ï¼Œä½†å½“å¤šä¸ªçº¿ç¨‹å¹¶å‘çš„æ‰§è¡Œä¸Šé¢çš„<code>insert</code>å‡½æ•°æ—¶å°±ä¼šå‡ºç°é—®é¢˜ï¼šä¸¤ä¸ªçº¿ç¨‹åŒæ—¶åˆ›å»ºæ–°çš„<code>entry</code>ï¼Œå¹¶å°†é“¾è¡¨æ”¾åˆ°<code>entry</code>åéƒ¨ï¼Œä¹‹åä¸€ä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œ<code>*p = e</code>å°†è‡ªå·±çš„<code>entry</code>ä½œä¸ºé“¾è¡¨å¤´ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å†æ‰§è¡Œ<code>*p = e</code>å°†è‡ªå·±çš„<code>entry</code>ä½œä¸ºé“¾è¡¨å¤´ï¼Œæ­¤æ—¶å…ˆæ‰§è¡Œçš„çº¿ç¨‹çš„ä¿®æ”¹è¢«åæ‰§è¡Œçš„çº¿ç¨‹è¦†ç›–æ‰äº†ï¼Œä¸¢å¤±äº†ä¿®æ”¹ï¼Œä¹Ÿå°±æ²¡æœ‰æˆåŠŸæ’å…¥æ–°å…ƒç´ ã€‚</p><p>ä¸ºè§£å†³ä¸Šè¿°å¤šçº¿ç¨‹æƒ…å†µä¸‹çš„race conditionï¼Œéœ€è¦å°†<code>insert</code>æ“ä½œä½œä¸ºä¸€ä¸ªåŸå­æ“ä½œï¼Œä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œäº’æ–¥é”æ­£æ˜¯ç”¨æ¥è§£å†³æ­¤é—®é¢˜çš„ã€‚</p><ol start="2"><li>å®šä¹‰äº’æ–¥é”</li></ol><p>å®šä¹‰å¹¶åˆå§‹åŒ–çº¿ç¨‹äº’æ–¥é”ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// å…¨å±€å˜é‡</span><br><span class="hljs-keyword">pthread_mutex_t</span> lock;<br><br><span class="hljs-comment">// mainå‡½æ•°ä¸­</span><br>pthread_mutex_init(&amp;lock, <span class="hljs-literal">NULL</span>);<br></code></pre></td></tr></table></figure><ol start="3"><li>ä¸º<code>insert</code>æ“ä½œåŠ é”</li></ol><p>åœ¨<code>put</code>å‡½æ•°ä¸­ä¸º<code>insert</code>å‡½æ•°åŠ äº’æ–¥é”ï¼Œç”±äº<code>put</code>ä¹‹å‰åŸºæœ¬éƒ½æ˜¯è¯»æ“ä½œï¼Œä¸ç”¨åŠ é”ï¼Œè™½ç„¶<code>e-&gt;value = value;</code>æ˜¯ä¿®æ”¹æ“ä½œï¼Œä½†ä¸ä¼šäº§ç”Ÿå†²çªï¼Œä¸€å®šæ˜¯åä¿®æ”¹çš„çº¿ç¨‹ä¼šè¦†ç›–å…ˆä¿®æ”¹çš„çº¿ç¨‹ï¼Œä¹Ÿä¸ç”¨åŠ é”ï¼Œåªæœ‰<code>insert</code>æ‰éœ€è¦åŠ é”ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> </span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">(<span class="hljs-keyword">int</span> key, <span class="hljs-keyword">int</span> value)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> i = key % NBUCKET;<br><br>  <span class="hljs-comment">// is the key already present?</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">entry</span> *<span class="hljs-title">e</span> =</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> (e = table[i]; e != <span class="hljs-number">0</span>; e = e-&gt;next) &#123;<br>    <span class="hljs-keyword">if</span> (e-&gt;key == key)<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span>(e)&#123;<br>    <span class="hljs-comment">// update the existing key.</span><br>    e-&gt;value = value;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// the new is new.</span><br>    pthread_mutex_lock(&amp;lock);<br>    insert(key, value, &amp;table[i], table[i]);<br>    pthread_mutex_unlock(&amp;lock);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="è¿è¡Œç»“æœ-1"><a href="#è¿è¡Œç»“æœ-1" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h5><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210527205109.png" alt="image-20210527205109919"></p><p>å¯è§ä½¿ç”¨ä¸¤ä¸ªçº¿ç¨‹æ—¶çš„é€Ÿåº¦ä¸ºå•çº¿ç¨‹çš„å°†è¿‘2å€ï¼Œå¹¶ä¸”å¤šçº¿ç¨‹æƒ…å†µä¸‹æ²¡æœ‰å‘ç”Ÿæ’å…¥çš„ä¸¢å¤±ã€‚</p><h4 id="Barrier"><a href="#Barrier" class="headerlink" title="Barrier"></a>Barrier</h4><h5 id="ä»»åŠ¡-2"><a href="#ä»»åŠ¡-2" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>ä½¿ç”¨<code>pthread</code>çš„æ¡ä»¶ç­‰å¾…å®ç°çº¿ç¨‹å±éšœ(barrier)ï¼šæ‰€æœ‰çš„çº¿ç¨‹éƒ½éœ€è¦åœ¨è¯¥ç‚¹ç­‰å¾…ç›´åˆ°æ‰€æœ‰å…¶ä»–çº¿ç¨‹ä¹Ÿéƒ½åˆ°è¾¾äº†è¯¥ç‚¹ã€‚</p><h5 id="è¿‡ç¨‹-2"><a href="#è¿‡ç¨‹-2" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><p>æ¯ä¸€è½®<code>barrier</code>ç»“æ„ç»´æŠ¤å½“å‰åˆ°è¾¾å±éšœçš„çº¿ç¨‹æ•°ç›®ï¼Œå½“æœªå…¨éƒ¨è¾¾åˆ°æ—¶ï¼Œå…ˆåˆ°çš„çº¿ç¨‹è°ƒç”¨<code>pthread_cond_wait</code>åœ¨æ¡ä»¶ä¸Šç­‰å¾…ï¼Œå½“æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾æ—¶ï¼Œå†è°ƒç”¨<code>pthread_cond_broadcast</code>å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œä¹‹åæ‰€æœ‰çº¿ç¨‹è¿›è¡Œæ–°ä¸€è½®çš„æ‰§è¡Œã€‚</p><p>åœ¨<code>barrier()</code>å‡½æ•°å®ç°çš„è¿‡ç¨‹ä¸­ï¼ŒåŒæ ·æ¶‰åŠå¤šä¸ªçº¿ç¨‹å¯¹äº<code>barrier</code>å…±äº«æ•°æ®ç»“æ„çš„ä¿®æ”¹ï¼Œå› æ­¤åº”è¯¥åŠ é”è¿›è¡ŒåŒæ­¥ã€‚</p><p>ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> </span><br><span class="hljs-function"><span class="hljs-title">barrier</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  pthread_mutex_lock(&amp;bstate.barrier_mutex);<br>  bstate.nthread++;<br>  <span class="hljs-keyword">if</span> (bstate.nthread &lt; nthread) &#123;<br>    pthread_cond_wait(&amp;bstate.barrier_cond, &amp;bstate.barrier_mutex);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    pthread_cond_broadcast(&amp;bstate.barrier_cond);<br>    bstate.round++;<br>    bstate.nthread = <span class="hljs-number">0</span>;<br>  &#125;<br>  pthread_mutex_unlock(&amp;bstate.barrier_mutex);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å®éªŒæµ‹è¯•"><a href="#å®éªŒæµ‹è¯•" class="headerlink" title="å®éªŒæµ‹è¯•"></a>å®éªŒæµ‹è¯•</h4><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210527210418.png" alt="image-20210527210418061"></p><h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><p><a href="https://github.com/whileskies/xv6-labs-2020/tree/thread">https://github.com/whileskies/xv6-labs-2020/tree/thread</a></p>]]></content>
    
    
    <categories>
      
      <category>OS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6.S081-Lab6: Copy-on-Write Fork for xv6</title>
    <link href="/2021/07/11/6-S081-Lab6-Copy-on-Write-Fork-for-xv6/"/>
    <url>/2021/07/11/6-S081-Lab6-Copy-on-Write-Fork-for-xv6/</url>
    
    <content type="html"><![CDATA[<h2 id="Lab6-Copy-on-Write-Fork-for-xv6"><a href="#Lab6-Copy-on-Write-Fork-for-xv6" class="headerlink" title="Lab6: Copy-on-Write Fork for xv6"></a>Lab6: Copy-on-Write Fork for xv6</h2><p>lab6å®ç°<code>fork()</code>çš„COW</p><p>è™šæ‹Ÿå†…å­˜æä¾›ä¸€ä¸ªä¸­é—´å±‚ï¼šå†…æ ¸é€šè¿‡ä½¿å¾—é¡µè¡¨é¡¹éæ³•æˆ–è€…åªè¯»æ¥æ‹¦æˆªå†…å­˜å¼•ç”¨ï¼Œå¯¼è‡´é¡µé”™è¯¯ï¼Œç»§è€Œé€šè¿‡æ”¹å˜é¡µè¡¨é¡¹ä¿®æ”¹å®é™…çš„ç‰©ç†åœ°å€ï¼›è®¡ç®—æœºç³»ç»Ÿé¢†åŸŸæœ‰å¥åè¨€ï¼šè®¡ç®—æœºç³»ç»Ÿçš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡åŠ ä¸€ä¸ªä¸­é—´å±‚æ¥è§£å†³ï¼›lazy labå°±æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œè¯¥å®éªŒå®ç°äº†å¦ä¸€ä¸ªä¾‹å­ï¼šå†™æ—¶å¤åˆ¶fork</p><h4 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h4><p>xv6ä¸­çš„<code>fork()</code>ç³»ç»Ÿè°ƒç”¨ä¼šæ‹·è´çˆ¶è¿›ç¨‹çš„ç”¨æˆ·å†…å­˜ç©ºé—´åˆ°å­è¿›ç¨‹ï¼›å¦‚æœçˆ¶è¿›ç¨‹éå¸¸å¤§ï¼Œæ‹·è´å¯èƒ½ä¼šæ¶ˆè€—å¾ˆé•¿æ—¶é—´ï¼Œç”šè‡³ï¼Œæ‹·è´è¿‡ç¨‹é€šå¸¸äº§ç”Ÿå¤§çš„æµªè´¹ï¼Œæ¯”å¦‚<code>fork()</code>è°ƒç”¨é€šå¸¸ä¼šä¼´éšç€å­è¿›ç¨‹è°ƒç”¨<code>exec()</code>å¹¶æ¸…é™¤æ‰æ‰€æ‹·è´çš„å†…å­˜ï¼Œå¾ˆå¯èƒ½æ ¹æœ¬å°±æ²¡æœ‰ä½¿ç”¨è¿‡è¿™äº›å†…å­˜ï¼›å¦ä¸€æ–¹é¢ï¼Œå¦‚æœçˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹å…±äº«ç›¸åŒçš„ç‰©ç†é¡µï¼Œå½“å…¶ä¸­ä¸€ä¸ªå¸Œæœ›å†™è¯¥ç‰©ç†é¡µæ—¶ï¼Œéœ€è¦æ‹·è´è¯¥ç‰©ç†é¡µ</p><h4 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h4><p>å†™æ—¶å¤åˆ¶(COW) <code>fork()</code>çš„ç›®æ ‡æ˜¯æ¨è¿Ÿåˆ†é…å’Œæ‹·è´ç‰©ç†é¡µç›´åˆ°çœŸæ­£å®é™…éœ€è¦æ‹·è´æ—¶</p><p><code>COW fork()</code>ä»…ä»…ä¸ºå­è¿›ç¨‹åˆ›å»ºé¡µè¡¨ï¼Œå¹¶ä¸”ä½¿å¾—é¡µè¡¨é¡¹ä¸­çš„ç”¨æˆ·åœ°å€æŒ‡å‘çˆ¶è¿›ç¨‹ç›¸åº”çš„ç‰©ç†é¡µï¼›<code>COW fork()</code>æ ‡è®°çˆ¶å­è¿›ç¨‹çš„é¡µè¡¨é¡¹å‡ä¸ºåªè¯»çš„ï¼ˆä¸å¯å†™çš„ï¼‰ï¼›å½“æœ‰ä¸€æ–¹å°è¯•å†™è¿™äº›COWé¡µæ—¶ï¼ŒCPUä¼šäº§ç”Ÿé¡µé”™è¯¯ï¼›å†…æ ¸é¡µé”™è¯¯å¤„ç†ç¨‹åºå¤„ç†é¡µé”™è¯¯ï¼Œä¸ºå‡ºé”™è¿›ç¨‹åˆ†é…ç‰©ç†é¡µï¼Œå¤åˆ¶åŸå§‹é¡µæ•°æ®åˆ°æ–°çš„ç‰©ç†é¡µï¼Œä¿®æ”¹ç›¸åº”é¡µè¡¨é¡¹æŒ‡å‘æ–°ç‰©ç†é¡µï¼Œè¿™æ—¶å°†ç›¸åº”é¡µè¡¨é¡¹æ ‡è®°ä¸ºå¯å†™çš„ï¼›å½“é¡µé”™è¯¯å¤„ç†ç¨‹åºè¿”å›ï¼Œç”¨æˆ·è¿›ç¨‹å¯ä»¥æ­£å¸¸å†™æ‰€å¤åˆ¶çš„é¡µ</p><p><code>COW fork()</code>é‡Šæ”¾ç‰©ç†é¡µæ—¶æœ‰äº›æ£˜æ‰‹ï¼Œä¸€ä¸ªç‰©ç†é¡µå¯èƒ½ä¼šè¢«å¤šä¸ªè¿›ç¨‹çš„é¡µè¡¨æ‰€å¼•ç”¨ï¼Œåº”è¯¥å½“æœ€åä¸€ä¸ªå¼•ç”¨å–æ¶ˆæ—¶æ‰èƒ½é‡Šæ”¾</p><h4 id="Implement-copy-on-write-hard"><a href="#Implement-copy-on-write-hard" class="headerlink" title="Implement copy-on write(hard)"></a>Implement copy-on write(hard)</h4><h5 id="ä»»åŠ¡"><a href="#ä»»åŠ¡" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>å®Œæˆå†™æ—¶å¤åˆ¶<code>fork()</code>ï¼Œä¿®æ”¹åèƒ½å¤Ÿé€šè¿‡<code>cowtest</code>å’Œ<code>usertests</code></p><h5 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><ol><li>å¼•ç”¨è®¡æ•°å®ç°</li></ol><p>ç”±ä¸Šæ‰€è¿°ï¼ŒCOWæ—¶ä¸€ä¸ªç‰©ç†é¡µå¯èƒ½ä¼šè¢«å¤šä¸ªè¿›ç¨‹çš„é¡µè¡¨å¼•ç”¨ï¼Œå¦‚ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨<code>fork()</code>ï¼Œå­è¿›ç¨‹å†æ¬¡è°ƒç”¨<code>fork()</code>â€¦ï¼Œé‚£ä¹ˆåªæœ‰æ²¡æœ‰è¿›ç¨‹å¼•ç”¨è¯¥ç‰©ç†é¡µæ—¶è¯¥ç‰©ç†é¡µæ‰èƒ½è¢«é‡Šæ”¾ï¼Œå¯ä»¥ä½¿ç”¨å¼•ç”¨è®¡æ•°è§£å†³ï¼Œæ¯ä¸ªç‰©ç†é¡µå¯¹åº”ä¸€ä¸ªæ•°å€¼ï¼Œè¡¨ç¤ºå½“å‰è¢«å¼•ç”¨çš„è¿›ç¨‹ä¸ªæ•°ï¼Œå½“ä¸ªæ•°ä¸º0æ—¶é‡Šæ”¾</p><p>å®ç°æ—¶å¯ä»¥ç»´æŠ¤ä¸€ä¸ªå¼•ç”¨è®¡æ•°æ•°ç»„ï¼Œæ•°ç»„çš„ç¬¬<code>i</code>é¡¹è¡¨ç¤ºä»<code>KERNBASE</code>å¼€å§‹çš„ç¬¬<code>i</code>ä¸ªç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°ï¼Œæœ€å¤§ç‰©ç†é¡µçš„ä¸ªæ•°ä¸º<code>(PHYSTOP - KERNBASE) / PGSIZE</code>ï¼Œåœ¨<code>kalloc.c</code>ä¸­å®šä¹‰å¼•ç”¨æ•°ç»„ï¼Œç”±äºæ˜¯å…¨å±€å˜é‡ï¼Œåˆå§‹å€¼å‡ä¸º0ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">uint16 pgs_rfc[(PHYSTOP - KERNBASE) / PGSIZE];<br></code></pre></td></tr></table></figure><p>ç»™å‡ºä¸€ä¸ªç‰©ç†åœ°å€<code>get_pg_rfc()</code>å‡½æ•°è·å–ç›¸åº”ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°ï¼Œ<code>set_pg_rfc()</code>è®¾ç½®ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">uint16</span><br><span class="hljs-function"><span class="hljs-title">get_pg_rfc</span><span class="hljs-params">(uint64 pa)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">return</span> pgs_rfc[(pa - KERNBASE) &gt;&gt; <span class="hljs-number">12</span>];<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">set_pg_rfc</span><span class="hljs-params">(uint64 pa, uint16 rfc)</span></span><br><span class="hljs-function"></span>&#123;<br>  pgs_rfc[(pa - KERNBASE) &gt;&gt; <span class="hljs-number">12</span>] = rfc;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¿®æ”¹<code>kalloc.c/kfree()</code>ï¼Œä»…å½“paå¯¹åº”çš„ç‰©ç†é¡µå¼•ç”¨è®¡æ•° &lt;= 1æ—¶ï¼Œæ‰é‡Šæ”¾ç‰©ç†é¡µï¼Œå½“è¶…è¿‡ä¸€ä¸ªè¿›ç¨‹å¼•ç”¨ç‰©ç†é¡µæ—¶ï¼Œä»…ä»…å°†å¼•ç”¨æ•° -1ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(((uint64)pa % PGSIZE) != <span class="hljs-number">0</span> || (<span class="hljs-keyword">char</span>*)pa &lt; end || (uint64)pa &gt;= PHYSTOP)<br>  panic(<span class="hljs-string">&quot;kfree&quot;</span>);<br><br>uint16 ref = get_pg_rfc((uint64)pa);<br><span class="hljs-keyword">if</span> (ref &gt; <span class="hljs-number">1</span>) &#123;<br>  set_pg_rfc((uint64)pa, ref - <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¿®æ”¹<code>kalloc.c/kalloc</code>ï¼Œå½“åˆ†é…ä¸€ä¸ªç‰©ç†é¡µæ—¶ï¼Œè¯¥ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°ä¸º1ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(r) &#123;<br>  <span class="hljs-built_in">memset</span>((<span class="hljs-keyword">char</span>*)r, <span class="hljs-number">5</span>, PGSIZE); <span class="hljs-comment">// fill with junk</span><br>  set_pg_rfc((uint64)r, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>ä¿®æ”¹<code>vm.c/uvmcopy</code>å‡½æ•°ä¸ºCOW</li></ol><p><code>fork()</code>å‡½æ•°é€šè¿‡è°ƒç”¨<code>uvmcopy()</code>å‡½æ•°å¤åˆ¶çˆ¶è¿›ç¨‹çš„æ‰€æœ‰ç‰©ç†é¡µï¼Œå› æ­¤éœ€è¦å°†å…¶ä¿®æ”¹ä¸ºçˆ¶å­è¿›ç¨‹å…±äº«åŒä¸€ç‰©ç†é¡µï¼Œå¹¶ä¸”ç›¸åº”çš„é¡µè¡¨é¡¹å‡ä¸ºåªè¯»ä¸ä½¿ç”¨COWæ ‡è®°ï¼ŒåŒæ—¶ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°+1</p><p>é¡µè¡¨é¡¹COWæ ‡è®°åœ¨PTEçš„ç¬¬8ä½ï¼ˆRSWé¢„ç•™ä½ï¼‰è®¾ç½®ï¼Œåœ¨<code>riscv.h</code>ä¸­æ·»åŠ å¦‚ä¸‹å®å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PTE_COW (1L &lt;&lt; 8)</span><br></code></pre></td></tr></table></figure><p>ä¿®æ”¹åçš„<code>uvmcopy</code>å‡½æ•°ä»£ç ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">uvmcopy</span><span class="hljs-params">(<span class="hljs-keyword">pagetable_t</span> old, <span class="hljs-keyword">pagetable_t</span> <span class="hljs-keyword">new</span>, uint64 sz)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">pte_t</span> *pte;<br>  uint64 pa, i;<br>  uint flags;<br><br>  <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; sz; i += PGSIZE)&#123;<br>    <span class="hljs-keyword">if</span>((pte = walk(old, i, <span class="hljs-number">0</span>)) == <span class="hljs-number">0</span>)<br>      panic(<span class="hljs-string">&quot;uvmcopy: pte should exist&quot;</span>);<br>    <span class="hljs-keyword">if</span>((*pte &amp; PTE_V) == <span class="hljs-number">0</span>)<br>      panic(<span class="hljs-string">&quot;uvmcopy: page not present&quot;</span>);<br>    pa = PTE2PA(*pte);<br>    flags = PTE_FLAGS(*pte);<br><br>    *pte = *pte &amp; ~PTE_W;<br>    *pte = *pte | PTE_COW;<br>    set_pg_rfc(pa, get_pg_rfc(pa) + <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">if</span>(mappages(<span class="hljs-keyword">new</span>, i, PGSIZE, pa, (flags &amp; ~PTE_W) | PTE_COW) != <span class="hljs-number">0</span>) &#123;<br>      set_pg_rfc(pa, get_pg_rfc(pa) - <span class="hljs-number">1</span>);<br>      <span class="hljs-keyword">goto</span> err;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br> err:<br>  uvmunmap(<span class="hljs-keyword">new</span>, <span class="hljs-number">0</span>, i / PGSIZE, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li><code>cow()</code>å†™æ—¶å¤åˆ¶å‡½æ•°å®ç°</li></ol><p>å½“<code>COW fork()</code>åï¼Œçˆ¶è¿›ç¨‹æˆ–å­è¿›ç¨‹å†™è¢«å…±äº«çš„ç‰©ç†é¡µæ—¶ï¼Œéœ€è¦åˆ†é…ä¸€æ–°ç‰©ç†é¡µï¼Œå¤åˆ¶è¢«å…±äº«çš„ç‰©ç†é¡µï¼Œæ–°ç‰©ç†é¡µå¯¹åº”çš„é¡µè¡¨é¡¹æ ‡è®°ä½å¯å†™ï¼Œè¢«å…±äº«ç‰©ç†é¡µå¼•ç”¨è®¡æ•° -1ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œé‡Šæ”¾è¢«å…±äº«ç‰©ç†é¡µ</p><p>åœ¨<code>vm.c</code>ä¸­æ·»åŠ <code>cow()</code>å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">cow</span><span class="hljs-params">(uint64 va, struct proc *p)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">pte_t</span> *pte = walk(p-&gt;pagetable, va, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span>(*pte &amp; PTE_COW) &#123;<br>    <span class="hljs-keyword">char</span> *mem;<br>    uint64 pa = PTE2PA(*pte);<br><br>    <span class="hljs-keyword">if</span>((mem = kalloc()) == <span class="hljs-number">0</span>) <br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    memmove(mem, (<span class="hljs-keyword">char</span>*)pa, PGSIZE);<br>    uint16 rfc = get_pg_rfc(pa);<br>    rfc--;<br>    set_pg_rfc(pa, rfc);<br>    <span class="hljs-keyword">if</span> (rfc == <span class="hljs-number">0</span>) &#123;<br>      kfree((<span class="hljs-keyword">char</span> *)pa);<br>    &#125;<br><br>    <span class="hljs-keyword">pte_t</span> newpte = PA2PTE(mem);<br>    newpte = ((newpte | PTE_FLAGS(*pte)) | PTE_W) &amp; ~PTE_COW;<br>    *pte = newpte;<br>  &#125; <span class="hljs-keyword">else</span> <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-2</span>;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>è°ƒç”¨<code>cow()</code></li></ol><p>å½“çˆ¶è¿›ç¨‹æˆ–å­è¿›ç¨‹å†™å…¥æ•°æ®åˆ°åªè¯»çš„å…±äº«é¡µæ—¶ï¼Œå‘ç”Ÿé¡µé”™è¯¯ï¼Œ<code>trap.c/usertrap()</code>å‡½æ•°å¤„ç†è¯¥é¡µé”™è¯¯ï¼Œå½“é”™è¯¯ç ä¸º15æ—¶ï¼Œæ‰§è¡ŒCOWï¼Œä¹Ÿå³<code>cow()</code>å‡½æ•°ï¼Œtrapè¿”å›åä¼šå†™å…¥åˆ°åˆæ³•çš„ç‰©ç†é¡µï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((which_dev = devintr()) != <span class="hljs-number">0</span>)&#123;<br>  <span class="hljs-comment">// ok</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(r_scause() == <span class="hljs-number">15</span>) &#123;<br>  uint64 stval = r_stval();<br>  <span class="hljs-keyword">if</span> (cow(stval, p) != <span class="hljs-number">0</span>) &#123;<br>    p-&gt;killed = <span class="hljs-number">1</span>;<br>  &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br></code></pre></td></tr></table></figure><p>å½“çˆ¶è¿›ç¨‹æˆ–å­è¿›ç¨‹è°ƒç”¨å¦‚<code>read()</code>ä¹‹ç±»çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå°†å†…æ ¸æ•°æ®å†™å…¥ç”¨æˆ·åœ°å€ç©ºé—´ï¼Œå¦‚æœè¯¥åœ°å€å®é™…çš„ç‰©ç†é¡µä¸ºå…±äº«é¡µçš„è¯ï¼Œä¹Ÿä¼šå‘ç”Ÿé”™è¯¯ï¼Œä½†æ˜¯å‡ºé”™æ—¶å†…æ ¸æ­£åœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä¸ä¼šäº§ç”Ÿ<code>usertrap</code>ï¼Œå› æ­¤éœ€è¦åœ¨<code>vm.c/copyout()</code>ä¸­å¢åŠ COWçš„ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">copyout</span><span class="hljs-params">(<span class="hljs-keyword">pagetable_t</span> pagetable, uint64 dstva, <span class="hljs-keyword">char</span> *src, uint64 len)</span></span><br><span class="hljs-function"></span>&#123;<br>  uint64 n, va0, pa0;<br><br>  <span class="hljs-keyword">while</span>(len &gt; <span class="hljs-number">0</span>)&#123;<br>    va0 = PGROUNDDOWN(dstva);<br>    pa0 = walkaddr(pagetable, va0);<br>    <span class="hljs-keyword">if</span>(pa0 == <span class="hljs-number">0</span>)<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    cow(va0, myproc());<br>    pa0 = walkaddr(pagetable, va0);<br><br>    n = PGSIZE - (dstva - va0);<br>    <span class="hljs-keyword">if</span>(n &gt; len)<br>      n = len;<br>    memmove((<span class="hljs-keyword">void</span> *)(pa0 + (dstva - va0)), src, n);<br><br>    len -= n;<br>    src += n;<br>    dstva = va0 + PGSIZE;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="5"><li>ä¿®æ”¹å¼•ç”¨è®¡æ•°æ—¶åŠ é”</li></ol><p>å½“ä¿®æ”¹æŸç‰©ç†é¡µå¼•ç”¨è®¡æ•°æ—¶åˆ†ä¸ºä¸¤æ­¥ï¼š<code>set_pg_rfc(pa, get_pg_rfc(pa) + 1)</code>ï¼Œé¦–å…ˆé€šè¿‡<code>get_pg_rfc()</code>å‡½æ•°è·å–æŸç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°ï¼Œä¹‹åå†é€šè¿‡<code>set_pg_rfc()</code>æ¥ä¿®æ”¹å¼•ç”¨è®¡æ•°ï¼Œå½“å¤šä¸ªè¿›ç¨‹åŒæ—¶ä¿®æ”¹åŒä¸€ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°æ—¶ï¼Œä¼šå‘ç”Ÿ<code>race conditons</code>ï¼Œå¦‚æœä¸åŠ é”ï¼Œä¼šé€ æˆç‰©ç†é¡µçš„å†…å­˜æ³„éœ²</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæœ‰3ä¸ªè¿›ç¨‹å…±äº«åŒä¸€ç‰©ç†é¡µï¼Œé‚£ä¹ˆè¯¥ç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°ä¸º3ï¼Œå½“å…¶ä¸­2ä¸ªè¿›ç¨‹åŒæ—¶è°ƒç”¨<code>kfree()</code>å‡½æ•°é‡Šæ”¾ç‰©ç†é¡µï¼Œåœ¨<code>kfree()</code>ä»£ç ä¸­ï¼Œ2ä¸ªè¿›ç¨‹åŒæ—¶æ‰§è¡Œ<code>uint16 ref = get_pg_rfc((uint64)pa)</code>ï¼Œå¾—åˆ°å½“å‰å¼•ç”¨è®¡æ•°ä¸º3ï¼Œä¹‹åä¸€ä¸ªè¿›ç¨‹å…ˆæ‰§è¡Œ<code>set_pg_rfc((uint64)pa, ref - 1)</code>å°†è¯¥é¡µå¼•ç”¨è®¡æ•°å˜ä¸º2ï¼Œå†ä¹‹åå¦ä¸€ä¸ªè¿›ç¨‹åŒæ ·æ‰§è¡Œ<code>set_pg_rfc((uint64)pa, ref - 1)</code>å°†è¯¥é¡µå¼•ç”¨è®¡æ•°å˜ä¸º2ï¼Œè¿™æ ·æœ€ç»ˆè¯¥é¡µå¼•ç”¨è®¡æ•°å˜ä¸º2ï¼ˆæ­£ç¡®æƒ…å†µåº”ä¸º1ï¼‰ï¼Œä¸¢å¤±äº†ä¸€æ¬¡æ›´æ–°ï¼Œå®é™…ä¸Šä¹‹ååªæœ‰1ä¸ªè¿›ç¨‹å…±äº«è¯¥ç‰©ç†é¡µï¼Œå½“è¯¥è¿›ç¨‹ä¹Ÿè°ƒç”¨<code>kfree()</code>é‡Šæ”¾ç‰©ç†é¡µæ—¶ï¼Œå¼•ç”¨è®¡æ•°ä»2å˜ä¸º1ï¼Œè€Œä¸æ˜¯ç›´æ¥é‡Šæ”¾è¯¥ç‰©ç†é¡µï¼Œæœ€ç»ˆé€ æˆè¯¥ç‰©ç†é¡µçš„æ³„éœ²ï¼Œä¸€ç›´ä¸ä¼šè¢«å›æ”¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">kfree</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *pa)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">run</span> *<span class="hljs-title">r</span>;</span><br>  <span class="hljs-keyword">if</span>(((uint64)pa % PGSIZE) != <span class="hljs-number">0</span> || (<span class="hljs-keyword">char</span>*)pa &lt; end || (uint64)pa &gt;= PHYSTOP)<br>    panic(<span class="hljs-string">&quot;kfree&quot;</span>);<br><br>  acquire(&amp;rfc_lock);<br>  uint16 ref = get_pg_rfc((uint64)pa);<br>  <span class="hljs-keyword">if</span> (ref &gt; <span class="hljs-number">1</span>) &#123;<br>    set_pg_rfc((uint64)pa, ref - <span class="hljs-number">1</span>);<br>    release(&amp;rfc_lock);<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br>  release(&amp;rfc_lock);<br><br>  <span class="hljs-comment">// Fill with junk to catch dangling refs.</span><br>  <span class="hljs-built_in">memset</span>(pa, <span class="hljs-number">1</span>, PGSIZE);<br>  r = (struct run*)pa;<br>  acquire(&amp;kmem.lock);<br>  r-&gt;next = kmem.freelist;<br>  kmem.freelist = r;<br>  release(&amp;kmem.lock);<br>&#125;<br></code></pre></td></tr></table></figure><p>å› æ­¤ï¼Œä¸ºè§£å†³å¹¶å‘å‡ºç°çš„é—®é¢˜ï¼Œåº”å½“æŠŠè·å–å¼•ç”¨è®¡æ•°ã€ä¿®æ”¹å¼•ç”¨è®¡æ•°è¿™ä¸¤æ­¥æ“ä½œä½œä¸ºä¸€ä¸ªåŸå­æ“ä½œï¼Œä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªCPUæˆ–è¿›ç¨‹æ‰§è¡Œè¯¥ä¸´ç•ŒåŒºä»£ç </p><p>é¦–å…ˆåœ¨<code>kalloc.c</code>å®šä¹‰é¡µå¼•ç”¨çš„è‡ªæ—‹é”ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spinlock</span> <span class="hljs-title">rfc_lock</span>;</span><br></code></pre></td></tr></table></figure><p>åœ¨<code>kalloc.c/kinit()</code>å‡½æ•°ä¸­åˆå§‹åŒ–è¯¥è‡ªæ—‹é”ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">kinit()<br>&#123;<br>  initlock(&amp;kmem.lock, <span class="hljs-string">&quot;kmem&quot;</span>);<br>  initlock(&amp;rfc_lock, <span class="hljs-string">&quot;pgs_rfc&quot;</span>);<br>  freerange(end, (<span class="hljs-keyword">void</span>*)PHYSTOP);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>kalloc.c/kfree()</code>å‡½æ•°ä¸­åŠ é”ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">acquire(&amp;rfc_lock);<br>uint16 ref = get_pg_rfc((uint64)pa);<br><span class="hljs-keyword">if</span> (ref &gt; <span class="hljs-number">1</span>) &#123;<br>  set_pg_rfc((uint64)pa, ref - <span class="hljs-number">1</span>);<br>  release(&amp;rfc_lock);<br>  <span class="hljs-keyword">return</span>;<br>&#125;<br>release(&amp;rfc_lock);<br></code></pre></td></tr></table></figure><p>åœ¨<code>vm.c/uvmcopy()</code>å‡½æ•°ä¸­åŠ é”ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">acquire(&amp;rfc_lock);<br>set_pg_rfc(pa, get_pg_rfc(pa) + <span class="hljs-number">1</span>);<br>release(&amp;rfc_lock);<br><span class="hljs-keyword">if</span>(mappages(<span class="hljs-keyword">new</span>, i, PGSIZE, pa, (flags &amp; ~PTE_W) | PTE_COW) != <span class="hljs-number">0</span>) &#123;<br>  acquire(&amp;rfc_lock);<br>  set_pg_rfc(pa, get_pg_rfc(pa) - <span class="hljs-number">1</span>);<br>  release(&amp;rfc_lock);<br>  <span class="hljs-keyword">goto</span> err;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>vm.c/cow</code>ä¸­åŠ é”ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">acquire(&amp;rfc_lock);<br>uint16 rfc = get_pg_rfc(pa);<br>rfc--;<br>set_pg_rfc(pa, rfc);<br>release(&amp;rfc_lock);<br><span class="hljs-keyword">if</span> (rfc == <span class="hljs-number">0</span>) &#123;<br>  kfree((<span class="hljs-keyword">char</span> *)pa);<br>&#125;<br></code></pre></td></tr></table></figure><p>å®é™…ä¸Šè¿™é‡ŒåŠ é”çš„ç²’åº¦æ¯”è¾ƒå¤§ï¼Œæ˜¯å¯¹è®¿é—®æ•´ä¸ªå¼•ç”¨æ•°ç»„æ—¶åŠ é”ï¼Œå®é™…ä¸Šåªéœ€å¯¹è®¿é—®ç‰¹å®šç‰©ç†é¡µçš„å¼•ç”¨è®¡æ•°æ—¶åŠ é”ï¼Œä½†æ˜¯è¿™æ ·éœ€è¦çš„é”è¿‡å¤š</p><h4 id="å®éªŒæµ‹è¯•"><a href="#å®éªŒæµ‹è¯•" class="headerlink" title="å®éªŒæµ‹è¯•"></a>å®éªŒæµ‹è¯•</h4><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210413175049.png" alt="image-20210413175042082"></p><h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><p><a href="https://github.com/whileskies/xv6-labs-2020/tree/cow">https://github.com/whileskies/xv6-labs-2020/tree/cow</a></p>]]></content>
    
    
    <categories>
      
      <category>OS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6.S081-Lab5: xv6 lazy page allocation</title>
    <link href="/2021/07/11/6-S081-Lab5-xv6-lazy-page-allocation/"/>
    <url>/2021/07/11/6-S081-Lab5-xv6-lazy-page-allocation/</url>
    
    <content type="html"><![CDATA[<h2 id="Lab5-xv6-lazy-page-allocation"><a href="#Lab5-xv6-lazy-page-allocation" class="headerlink" title="Lab5: xv6 lazy page allocation"></a>Lab5: xv6 lazy page allocation</h2><p>lab5ä¸»è¦æ˜¯ä¸ºsbrk()ç³»ç»Ÿè°ƒç”¨å®ç°æ‡’åˆ†é…</p><p>oså¯ä»¥ä½¿ç”¨é¡µè¡¨å®ç°å¾ˆå¤šæŠ€å·§ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯å¯¹äºç”¨æˆ·ç©ºé—´å †å†…å­˜çš„æ‡’åˆ†é…ï¼Œxv6åº”ç”¨ç¨‹åºä½¿ç”¨sbrk()ç³»ç»Ÿè°ƒç”¨æ¥å‘å†…æ ¸ç”³è¯·å †å†…å­˜ï¼›åœ¨æœªä¿®æ”¹ç‰ˆæœ¬çš„xv6ä¸­ï¼Œsbrk()åˆ†é…ç‰©ç†é¡µï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¯¹ä¸€ä¸ªå¤§çš„å †å†…å­˜ç”³è¯·éœ€æ±‚ï¼Œå†…æ ¸éœ€è¦ä¸€æ®µæ—¶é—´å»åˆ†é…å¹¶ä¸”æ˜ å°„åˆ°é¡µè¡¨ï¼›å¦å¤–ï¼Œä¸€äº›ç¨‹åºä¼šç”³è¯·æ¯”å®é™…ä½¿ç”¨æ›´å¤šçš„å†…å­˜ï¼Œæˆ–è€…åœ¨ä½¿ç”¨å‰å»åˆ†é…å†…å­˜ï¼›ä¸ºäº†ä½¿å¾—sbrk()åœ¨è¿™äº›æƒ…å†µä¸‹æ›´å¿«å®Œæˆï¼Œæ›´ä¸ºå¤æ‚çš„å†…æ ¸å®ç°æ‡’åˆ†é…ï¼›è¿™æ—¶ï¼Œsbrk()ä¸å®é™…åˆ†é…ç‰©ç†å†…å­˜ï¼Œè€Œæ˜¯è®°å½•å“ªäº›ç”¨æˆ·åœ°å€è¢«åˆ†é…ï¼Œå¹¶ä¸”åœ¨ç”¨æˆ·é¡µè¡¨æ ‡è®°è¿™äº›åœ°å€æ˜¯éæ³•çš„ï¼›å½“è¿›ç¨‹é¦–æ¬¡å°è¯•è®¿é—®æ‡’åˆ†é…çš„å†…å­˜ä¸­ä»»ä½•ä¸€é¡µæ—¶ï¼ŒCPUä¼šäº§ç”Ÿé¡µé”™è¯¯ï¼Œå†…æ ¸å¤„ç†è¯¥é”™è¯¯ï¼Œä¸ºå…¶åˆ†é…ç‰©ç†å†…å­˜ï¼Œå¡«å……0ï¼Œå¹¶ä¸”è¿›è¡Œæ˜ å°„ï¼›åœ¨è¯¥labä¸­ä¸ºxv6æ·»åŠ è¯¥ç‰¹æ€§</p><h4 id="Eliminate-allocation-from-sbrk-easy"><a href="#Eliminate-allocation-from-sbrk-easy" class="headerlink" title="Eliminate allocation from sbrk() (easy)"></a>Eliminate allocation from sbrk() (easy)</h4><h5 id="ä»»åŠ¡"><a href="#ä»»åŠ¡" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>å®Œæˆlazy allocé¦–å…ˆéœ€è¦åœ¨sbrk(n)ç³»ç»Ÿè°ƒç”¨å®ç°ä¸­åˆ é™¤ç‰©ç†é¡µåˆ†é…ä»£ç ï¼Œsbrk(n)ç³»ç»Ÿè°ƒç”¨å¢é•¿è¿›ç¨‹nä¸ªå­—èŠ‚çš„å†…å­˜å¤§å°ï¼Œè¿”å›æ–°åˆ†é…åŒºåŸŸçš„é¦–åœ°å€ï¼›æ–°çš„sbrk(n)åº”è¯¥ä»…ä»…å¢åŠ è¿›ç¨‹nä¸ªå­—èŠ‚çš„å†…å­˜å¤§å°ï¼Œå¹¶è¿”å›ä¹‹å‰çš„å†…å­˜è¾¹ç•Œï¼›ç”±äºä¸åˆ†é…ç‰©ç†å†…å­˜ï¼Œæ‰€ä»¥éœ€è¦åˆ é™¤growproc()å‡½æ•°</p><h5 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><p>ä¿®æ”¹<code>sysproc.c/sys_sbrk</code>çš„å®ç°ï¼Œä»…ä»…ä¿®æ”¹è¿›ç¨‹çš„szçš„å€¼ï¼Œè€Œä¸å®é™…åˆ†é…ç‰©ç†é¡µï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">uint64</span><br><span class="hljs-function"><span class="hljs-title">sys_sbrk</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> addr;<br>  <span class="hljs-keyword">int</span> n;<br><br>  <span class="hljs-keyword">if</span>(argint(<span class="hljs-number">0</span>, &amp;n) &lt; <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span>* <span class="hljs-title">p</span> =</span> myproc();<br>  addr = p-&gt;sz;<br>  <br>  <span class="hljs-keyword">if</span>(n &lt; <span class="hljs-number">0</span>) &#123;<br>    uvmdealloc(p-&gt;pagetable, p-&gt;sz, p-&gt;sz + n);<br>  &#125;<br>  p-&gt;sz += n;<br>  <br>  <span class="hljs-keyword">return</span> addr;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Lazy-allocation-moderate"><a href="#Lazy-allocation-moderate" class="headerlink" title="Lazy allocation (moderate)"></a>Lazy allocation (moderate)</h4><h5 id="ä»»åŠ¡-1"><a href="#ä»»åŠ¡-1" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>ä¿®æ”¹<code>trap.c</code>ä¸­çš„ä»£ç ä½¿å¾—å½“ç”¨æˆ·åœ°å€å‘ç”Ÿé¡µé”™è¯¯æ—¶ï¼Œä¸ºé¡µé”™è¯¯åœ°å€åˆ†é…æ–°çš„ç‰©ç†é¡µï¼Œå¹¶è¿›è¡Œæ˜ å°„</p><h5 id="è¿‡ç¨‹-1"><a href="#è¿‡ç¨‹-1" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><ol><li>åˆ›å»º<code>vm.c/lazy_alloc</code>å‡½æ•°</li></ol><p><code>lazy_alloc</code>å‡½æ•°æ ¹æ®å‡ºç°é¡µé”™è¯¯æ—¶çš„è¿›ç¨‹è™šæ‹Ÿåœ°å€ï¼Œä¸ºè¯¥è¿›ç¨‹åˆ†é…ç‰©ç†é¡µå¹¶è¿›è¡Œæ˜ å°„</p><p>å¦‚æœè¿›ç¨‹è®¿é—®çš„è™šæ‹Ÿåœ°å€è¶…å‡ºè¿›ç¨‹å†…å­˜å¤§å°ï¼ˆå †ç©ºé—´ï¼‰è¾¹ç•Œæˆ–ä½äºæ ˆé¡¶åœ°å€æ—¶ï¼Œæ€æ‰æ­¤è¿›ç¨‹</p><p>å½“åˆ†é…ç‰©ç†é¡µå¤±è´¥æˆ–æ˜ å°„ç‰©ç†é¡µåˆ°ç”¨æˆ·é¡µè¡¨å¤±è´¥æ—¶ï¼ŒåŒæ ·æ€æ‰æ­¤è¿›ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Lazy alloc for sbrk</span><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">lazy_alloc</span><span class="hljs-params">(uint64 stval, struct proc *p)</span></span><br><span class="hljs-function"></span>&#123;<br>  uint64 va = PGROUNDDOWN(stval);<br>  <span class="hljs-keyword">if</span>(stval &gt;= p-&gt;sz || stval &lt; PGROUNDDOWN(p-&gt;trapframe-&gt;sp)) &#123;<br>    <span class="hljs-comment">//printf(&quot;lazy alloc error: va higher than sz or below user stack\n&quot;);</span><br>    p-&gt;killed = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">char</span> *mem = kalloc();<br>  <span class="hljs-keyword">if</span>(mem == <span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-comment">//printf(&quot;lazy alloc error: no more memory\n&quot;);</span><br>    p-&gt;killed = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  <span class="hljs-built_in">memset</span>(mem, <span class="hljs-number">0</span>, PGSIZE);<br>  <span class="hljs-keyword">if</span>(mappages(p-&gt;pagetable, va, PGSIZE, (uint64)mem, PTE_W|PTE_R|PTE_U) != <span class="hljs-number">0</span>)&#123;<br>    kfree(mem);<br>    <span class="hljs-comment">//printf(&quot;lazy alloc error: map error\n&quot;);</span><br>    p-&gt;killed = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>å¤„ç†é¡µé”™è¯¯é™·å…¥</li></ol><p>å½“ç”¨æˆ·è¿›ç¨‹è®¿é—®åˆ°æŸä¸ªå †ç©ºé—´å¤„çš„è™šæ‹Ÿåœ°å€ï¼Œç”±äºæ˜¯æ‡’åˆ†é…ï¼Œå®é™…ä¸Šå¹¶æ²¡æœ‰åˆ†é…ç›¸åº”çš„ç‰©ç†é¡µï¼Œcpuäº§ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œäº§ç”Ÿé¡µé”™è¯¯é™·å…¥åˆ°å†…æ ¸åï¼Œåº”è°ƒç”¨<code>lazy_alloc</code>ä¸ºå…¶åˆ†é…ç‰©ç†é¡µåï¼Œé‡æ–°è®¿é—®è¯¥åœ°å€</p><p>é™·å…¥çš„åŸå› çŠ¶æ€ç è¢«ä¿å­˜åœ¨<code>scause</code>å¯„å­˜å™¨ä¸­ï¼Œ13ä»£è¡¨Load page faultã€15ä»£è¡¨Store page faultï¼Œå› æ­¤å½“<code>scause</code>ä¸º13æˆ–15æ—¶ï¼Œä¹Ÿå³è¿›ç¨‹æ­£åœ¨è¯»å–æˆ–å†™å…¥è™šæ‹Ÿåœ°å€æ—¶ï¼Œå®ç°æ‡’åˆ†é…å¹¶æ¢å¤è®¿é—®</p><p>ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((which_dev = devintr()) != <span class="hljs-number">0</span>)&#123;<br>  <span class="hljs-comment">// ok</span><br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (r_scause() == <span class="hljs-number">13</span> || r_scause() == <span class="hljs-number">15</span>) &#123;<br>  <span class="hljs-comment">// lazy allocation</span><br>  <span class="hljs-comment">// printf(&quot;page fault: stval=%p pid=%d\n&quot;, r_stval(), p-&gt;pid);</span><br>  uint64 stval = r_stval();<br>  lazy_alloc(stval, p);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br></code></pre></td></tr></table></figure><ol start="3"><li>ä¿®æ”¹<code>vm.c/uvmunmap</code>å‡½æ•°</li></ol><p>ç”±äºæ˜¯æ‡’åˆ†é…ï¼Œå½“è¿›ç¨‹éœ€è¦è¢«é‡Šæ”¾ï¼Œå–æ¶ˆæ˜ å°„çš„é¡µè¡¨æ—¶ï¼Œæœ‰çš„ç‰©ç†é¡µå®é™…å¹¶ä¸å­˜åœ¨ï¼Œå› æ­¤éœ€è¦ä¿®æ”¹å–æ¶ˆæ˜ å°„çš„è§„åˆ™ï¼Œå½“ç‰©ç†é¡µä¸å­˜åœ¨æ—¶ç•¥è¿‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span>(a = va; a &lt; va + npages*PGSIZE; a += PGSIZE)&#123;<br>  <span class="hljs-keyword">if</span>((pte = walk(pagetable, a, <span class="hljs-number">0</span>)) == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">continue</span>;<br>    <span class="hljs-comment">//panic(&quot;uvmunmap: walk&quot;);</span><br>  <span class="hljs-keyword">if</span>((*pte &amp; PTE_V) == <span class="hljs-number">0</span>)<br>    <span class="hljs-comment">//panic(&quot;uvmunmap: not mapped&quot;);</span><br>    <span class="hljs-keyword">continue</span>;<br>  <span class="hljs-keyword">if</span>(PTE_FLAGS(*pte) == PTE_V)<br>    panic(<span class="hljs-string">&quot;uvmunmap: not a leaf&quot;</span>);<br>  <span class="hljs-keyword">if</span>(do_free)&#123;<br>    uint64 pa = PTE2PA(*pte);<br>    kfree((<span class="hljs-keyword">void</span>*)pa);<br>  &#125;<br>  *pte = <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Lazytests-and-Usertests-moderate"><a href="#Lazytests-and-Usertests-moderate" class="headerlink" title="Lazytests and Usertests (moderate)"></a>Lazytests and Usertests (moderate)</h4><h5 id="ä»»åŠ¡-2"><a href="#ä»»åŠ¡-2" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>ä½¿å¾—å°†å†…æ ¸ä¿®æ”¹ä¸ºlazy allocåèƒ½å¤Ÿé€šè¿‡<code>lazytests</code>å’Œ<code>usertests</code></p><h5 id="è¿‡ç¨‹-2"><a href="#è¿‡ç¨‹-2" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><ol><li>ä¿®æ”¹<code>vm.c/uvmcopy</code></li></ol><p>ç”±äº<code>fork</code>ç³»ç»Ÿè°ƒç”¨éœ€è¦å¤åˆ¶çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´åˆ°å­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹çš„ä¸€äº›åœ°å€ç©ºé—´çš„ç‰©ç†é¡µå¹¶æ²¡æœ‰è¢«åˆ†é…ï¼Œå› æ­¤å¤åˆ¶æ—¶åº”è·³è¿‡ä¸å­˜åœ¨çš„ç‰©ç†é¡µï¼Œä¸è¿›è¡Œå¤åˆ¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>((pte = walk(old, i, <span class="hljs-number">0</span>)) == <span class="hljs-number">0</span>)<br>  <span class="hljs-keyword">continue</span>;<br>  <span class="hljs-comment">//panic(&quot;uvmcopy: pte should exist&quot;);</span><br><span class="hljs-keyword">if</span>((*pte &amp; PTE_V) == <span class="hljs-number">0</span>)<br>  <span class="hljs-keyword">continue</span>;<br>  <span class="hljs-comment">//panic(&quot;uvmcopy: page not present&quot;);</span><br>pa = PTE2PA(*pte);<br>flags = PTE_FLAGS(*pte);<br></code></pre></td></tr></table></figure><ol start="2"><li>å¤„ç†å½“è¿›ç¨‹è°ƒç”¨å¦‚<code>read</code>ã€<code>write</code>ç³»ç»Ÿè°ƒç”¨æ—¶ä¼ é€’åˆæ³•çš„è™šæ‹Ÿåœ°å€å‚æ•°ï¼Œä½†è¯¥åœ°å€å®é™…çš„ç‰©ç†é¡µæœªåˆ†é…çš„æƒ…å†µ</li></ol><p><code>read</code>ç³»ç»Ÿè°ƒç”¨éœ€è¦ä¼ é€’ä¸€ä¸ªç”¨æˆ·çš„è™šæ‹Ÿåœ°å€æŒ‡é’ˆï¼Œå†…æ ¸å°†æ–‡ä»¶æ•°æ®å¤åˆ¶åˆ°è¯¥ç”¨æˆ·æŒ‡é’ˆæŒ‡å‘çš„è™šæ‹Ÿåœ°å€å¤„ï¼Œè¯¥åœ°å€å¦‚æœæ˜¯å †å†…å­˜ç©ºé—´çš„åœ°å€ï¼Œå½“æ‰€å¯¹åº”çš„ç‰©ç†é¡µå¹¶æ²¡æœ‰åˆ†é…æ—¶ï¼Œä¼šåœ¨<code>read</code>ç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œä½†ä¸åŒäºç”¨æˆ·è¿›ç¨‹è®¿é—®æœªåˆ†é…å†…å­˜çš„åœ°å€æ—¶å‡ºç°çš„é¡µé”™è¯¯ï¼›è¯¥é”™è¯¯åº”åœ¨<code>read</code>ä¸­å¤„ç†ï¼Œæå‰åˆ¤æ–­è¿›ç¨‹ä¼ è¿›çš„ç”¨æˆ·æŒ‡é’ˆå‚æ•°æ‰€å¯¹åº”çš„ç‰©ç†é¡µæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ†é…ï¼›<code>write</code>ã€<code>pipe</code>ç³»ç»Ÿè°ƒç”¨ä¹Ÿæ˜¯ç±»ä¼¼çš„</p><p>å½“ç”¨æˆ·æŒ‡é’ˆå‚æ•°<code>p</code>ä¸åˆæ³•æ—¶ï¼Œåº”å¯¹<code>read</code>è¿”å›è¡¨ç¤ºé”™è¯¯çš„è¿”å›å€¼ï¼Œè€Œä¸æ˜¯æ€æ‰è¯¥è¿›ç¨‹ï¼Œå› æ­¤åº”ä¿®æ”¹ä¸Šè¿°çš„<code>vm.c/lazy_alloc</code>ä»£ç ä¸º<code>vm.c/lazy_wr_alloc</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Lazy alloc for write read and pipe</span><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">lazy_wr_alloc</span><span class="hljs-params">(uint64 va, struct proc *p)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span>(va &gt;= p-&gt;sz || va &lt; PGROUNDDOWN(p-&gt;trapframe-&gt;sp)) &#123;<br>    <span class="hljs-comment">//printf(&quot;lazy wr alloc error: va higher than sz\n&quot;);</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">char</span> *mem = kalloc();<br>  <span class="hljs-keyword">if</span>(mem == <span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-comment">//printf(&quot;lazy wr alloc error: no more memory\n&quot;);</span><br>    p-&gt;killed = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  <span class="hljs-built_in">memset</span>(mem, <span class="hljs-number">0</span>, PGSIZE);<br>  <span class="hljs-keyword">if</span>(mappages(p-&gt;pagetable, va, PGSIZE, (uint64)mem, PTE_W|PTE_R|PTE_U) != <span class="hljs-number">0</span>)&#123;<br>    kfree(mem);<br>    <span class="hljs-comment">//printf(&quot;lazy wr alloc error: map error\n&quot;);</span><br>    p-&gt;killed = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>sysfile.c/sys_read</code>ä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">uint64</span><br><span class="hljs-function"><span class="hljs-title">sys_read</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">f</span>;</span><br>  <span class="hljs-keyword">int</span> n;<br>  uint64 p;<br><br>  <span class="hljs-keyword">if</span>(argfd(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, &amp;f) &lt; <span class="hljs-number">0</span> || argint(<span class="hljs-number">2</span>, &amp;n) &lt; <span class="hljs-number">0</span> || argaddr(<span class="hljs-number">1</span>, &amp;p) &lt; <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">pro</span> =</span> myproc();<br>  <span class="hljs-keyword">for</span>(uint64 va = PGROUNDDOWN(p); va &lt; p + n; va += PGSIZE) &#123;<br>    <span class="hljs-keyword">if</span>(walkaddr(pro-&gt;pagetable, va) == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">if</span>(lazy_wr_alloc(va, pro) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> fileread(f, p, n);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>sysfile.c/sys_write</code>ä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">uint64</span><br><span class="hljs-function"><span class="hljs-title">sys_write</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">f</span>;</span><br>  <span class="hljs-keyword">int</span> n;<br>  uint64 p;<br><br>  <span class="hljs-keyword">if</span>(argfd(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, &amp;f) &lt; <span class="hljs-number">0</span> || argint(<span class="hljs-number">2</span>, &amp;n) &lt; <span class="hljs-number">0</span> || argaddr(<span class="hljs-number">1</span>, &amp;p) &lt; <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  <br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">pro</span> =</span> myproc();<br>  <span class="hljs-keyword">for</span>(uint64 va = PGROUNDDOWN(p); va &lt; p + n; va += PGSIZE) &#123;<br>    <span class="hljs-keyword">if</span>(walkaddr(pro-&gt;pagetable, va) == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">if</span>(lazy_wr_alloc(va, pro) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> filewrite(f, p, n);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>sysfile.c/sys_pipe</code>ä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(argaddr(<span class="hljs-number">0</span>, &amp;fdarray) &lt; <span class="hljs-number">0</span>)<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br><span class="hljs-keyword">for</span>(uint64 va = PGROUNDDOWN(fdarray); va &lt; PGROUNDUP(fdarray + <span class="hljs-number">2</span>*<span class="hljs-keyword">sizeof</span>(fd0)); va += PGSIZE) &#123;<br>  <span class="hljs-keyword">if</span>(walkaddr(p-&gt;pagetable, va) == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">if</span>(lazy_wr_alloc(va, p) &lt; <span class="hljs-number">0</span>)<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(pipealloc(&amp;rf, &amp;wf) &lt; <span class="hljs-number">0</span>)<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br></code></pre></td></tr></table></figure><h5 id="è¿è¡Œç»“æœ"><a href="#è¿è¡Œç»“æœ" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h5><p>lazytests:</p><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210410160218.png" alt="image-20210410160211604"></p><p>usertests:</p><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210410164834.png" alt="image-20210410164834879"></p><h4 id="å®éªŒæµ‹è¯•"><a href="#å®éªŒæµ‹è¯•" class="headerlink" title="å®éªŒæµ‹è¯•"></a>å®éªŒæµ‹è¯•</h4><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210410164038.png" alt="image-20210410164038207"></p><h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><p><a href="https://github.com/whileskies/xv6-labs-2020/tree/lazy">https://github.com/whileskies/xv6-labs-2020/tree/lazy</a></p>]]></content>
    
    
    <categories>
      
      <category>OS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6.S081-Lab4: traps</title>
    <link href="/2021/07/11/6-S081-Lab4-traps/"/>
    <url>/2021/07/11/6-S081-Lab4-traps/</url>
    
    <content type="html"><![CDATA[<h2 id="Lab4-traps"><a href="#Lab4-traps" class="headerlink" title="Lab4: traps"></a>Lab4: traps</h2><p>Lab4ä¸ºå‡½æ•°è°ƒç”¨ä»¥åŠé™·å…¥ç›¸å…³çš„å®éªŒ</p><h4 id="RISC-V-assembly-easy"><a href="#RISC-V-assembly-easy" class="headerlink" title="RISC-V assembly (easy)"></a>RISC-V assembly (easy)</h4><p>è¯¥éƒ¨åˆ†ä¸ºä¸€ç³»åˆ—RISC-Væ±‡ç¼–ç›¸å…³çš„é—®é¢˜ï¼Œé˜…è¯»<code>user/call.asm</code>å¯¹åº”çš„<code>call.asm</code>æ±‡ç¼–æ–‡ä»¶ï¼Œå›ç­”ä¸‹é¢é—®é¢˜ï¼š</p><ol><li>å“ªäº›å¯„å­˜å™¨åŒ…å«å‡½æ•°çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼Œå¯¹äº<code>main</code>è°ƒç”¨<code>printf</code>å‡½æ•°ï¼Œå“ªä¸ªå¯„å­˜å™¨å­˜å‚æ•°13ï¼Ÿ</li></ol><p>å¯¹äºRISC-Vï¼Œå‰8ä¸ªå‚æ•°ä¼šæ”¾ç½®åœ¨a0-a7å¯„å­˜å™¨ï¼Œa2æ”¾ç½®å‚æ•°13ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs assembly">void main(void) &#123;<br>  1c:1101                addisp,sp,-32<br>  1e:ec06                sdra,24(sp)<br>  20:e822                sds0,16(sp)<br>  22:1000                addis0,sp,32<br>  printf(&quot;%d %d\n&quot;, f(8)+1, 13);<br>  24:4635                lia2,13<br>  26:45b1                lia1,12<br>  28:00000517          auipca0,0x0<br>  2c:7f850513          addia0,a0,2040 # 820 &lt;malloc+0xea&gt;<br>  30:00000097          auipcra,0x0<br>  34:648080e7          jalr1608(ra) # 678 &lt;printf&gt;<br><br></code></pre></td></tr></table></figure><ol start="2"><li><code>main</code>æ±‡ç¼–ä¸­å“ªé‡Œè°ƒç”¨äº†å‡½æ•°<code>f</code>å’Œ<code>g</code>ï¼Ÿ</li></ol><p>ç”±ä¸Šè¿°ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œ<code>main</code>ä¸­ç›´æ¥å¾—åˆ°äº†12ï¼Œå¹¶æ”¾åˆ°äº†a1å¯„å­˜å™¨ï¼Œå¯è§ç¼–è¯‘å™¨è¿›è¡Œäº†ä¼˜åŒ–ï¼Œç›´æ¥å¾—åˆ°äº†ç»“æœ</p><ol start="3"><li><code>printf</code>çš„åœ°å€åœ¨å“ªï¼Ÿ</li></ol><p>ç”±æ±‡ç¼–æ–‡ä»¶å¯ä»¥çœ‹åˆ°<code>printf</code>çš„åœ°å€ä¸º0x630ï¼Œå½“åšå®Œalarmåï¼Œè¯¥æ±‡ç¼–æ–‡ä»¶ä¼šå‘ç”Ÿå˜åŒ–ï¼Œ<code>printf</code>çš„åœ°å€ä¹Ÿä¼šå˜åŒ–</p><ol start="4"><li>å½“è¦è¿›å…¥<code>main</code>ä¸­<code>printf</code>å‡½æ•°ï¼Œæ‰§è¡Œ<code>jalr</code>æŒ‡ä»¤åraå¯„å­˜å™¨çš„å€¼æ˜¯å¤šå°‘ï¼Ÿ</li></ol><p>raåº”ä¸ºå‡½æ•°è°ƒç”¨ä¸­æ–­ç‚¹å‡ºçš„åœ°å€ï¼Œä¹Ÿå³<code>jalr</code>ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œä¸º0x38</p><ol start="5"><li>è¿è¡Œä¸‹åˆ—ä»£ç ï¼š</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> i = <span class="hljs-number">0x00646c72</span>;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;H%x Wo%s&quot;</span>, <span class="hljs-number">57616</span>, &amp;i);<br></code></pre></td></tr></table></figure><p>è¾“å‡ºä¾èµ–äºRISC-Væ˜¯å°ç«¯ç³»ç»Ÿï¼Œå¦‚æœRISC-Væ˜¯å¤§ç«¯ï¼Œiåº”å¦‚ä½•è®¾ç½®å¾—åˆ°ç›¸åŒç»“æœï¼Œæ˜¯å¦éœ€è¦æ”¹å˜57616çš„å€¼ï¼Ÿ</p><p>å°ç«¯å³ä½å­—èŠ‚æ”¾ç½®åœ¨ä½åœ°å€ï¼Œè¾“å‡ºä¸ºï¼šâ€HE110 Worldâ€ï¼Œå¦‚æœä¸ºå¤§ç«¯iä¸º0x726c6400ï¼Œ57616ä¸éœ€è¦æ”¹å˜</p><ol start="6"><li>ä¸‹åˆ—ä»£ç ï¼š</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;x=%d y=%d&quot;</span>, <span class="hljs-number">3</span>);<br></code></pre></td></tr></table></figure><p><code>y=</code>å°†è¦è¾“å‡ºä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ</p><p>è¾“å‡ºç»“æœä¸ºx=3ï¼Œä½†yæ˜¯ä¸€ä¸ªä¸ç¡®å®šçš„å€¼ï¼Œå®é™…å¯èƒ½ä¸ºa2å¯„å­˜å™¨çš„å€¼</p><h4 id="Backtrace-moderate"><a href="#Backtrace-moderate" class="headerlink" title="Backtrace (moderate)"></a>Backtrace (moderate)</h4><h5 id="ä»»åŠ¡"><a href="#ä»»åŠ¡" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>åœ¨<code>kernel/printf.c</code>å®ç°<code>backtrace()</code>å‡½æ•°ï¼Œç”¨äºæ‰“å°å‡½æ•°è°ƒç”¨è¿‡ç¨‹ï¼Œåœ¨<code>sys_sleep</code>ä¸­æ’å…¥è¯¥å‡½æ•°ï¼Œä¹‹åè¿è¡Œæµ‹è¯•</p><h5 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><ol><li>å†…è”æ±‡ç¼–è¯»å–s0å¯„å­˜å™¨ï¼Œå³fpæ ˆæŒ‡é’ˆçš„å€¼</li></ol><p>ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œfp(s0)å¯„å­˜å™¨ç”¨äºä¿å­˜å½“å‰å‡½æ•°æ ˆå¸§çš„é¦–åœ°å€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> uint64</span><br><span class="hljs-function"><span class="hljs-title">r_fp</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  uint64 x;<br>  <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;mv %0, s0&quot;</span> : <span class="hljs-string">&quot;=r&quot;</span> (x) )</span></span>;<br>  <span class="hljs-keyword">return</span> x;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>æ ˆå¸§ç»“æ„</li></ol><p>å¦‚ä¸‹æ‰€ç¤ºï¼Œfpå¯„å­˜å™¨ä¸ºå½“å‰æ ˆå¸§çš„é¦–åœ°å€ï¼Œfp-8ä¸ºä¸Šçº§å‡½æ•°çš„è¿”å›åœ°å€ï¼Œfp-16ä¸ºä¸Šçº§æ ˆå¸§çš„é¦–åœ°å€ï¼Œä¸€ç›´æ²¿ç€ä¸Šçº§æ ˆå¸§çš„åœ°å€ï¼Œå¯ä»¥æ‰“å°å‡ºæ•´ä¸ªæ ˆçš„è°ƒç”¨è¿‡ç¨‹</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">Stack<br>                   .<br>                   .<br>      +-&gt;          .<br>      |<span class="hljs-string">   +-----------------+   </span>|<br>      |<span class="hljs-string">   </span>|<span class="hljs-string"> return address  </span>|<span class="hljs-string">   </span>|<br>      |<span class="hljs-string">   </span>|<span class="hljs-string">   previous fp ------+</span><br><span class="hljs-string">      </span>|<span class="hljs-string">   </span>|<span class="hljs-string"> saved registers </span>|<br>      |<span class="hljs-string">   </span>|<span class="hljs-string"> local variables </span>|<br>      |<span class="hljs-string">   </span>|<span class="hljs-string">       ...       </span>|<span class="hljs-string"> &lt;-+</span><br><span class="hljs-string">      </span>|<span class="hljs-string">   +-----------------+   </span>|<br>      |<span class="hljs-string">   </span>|<span class="hljs-string"> return address  </span>|<span class="hljs-string">   </span>|<br>      +------ previous fp   |<span class="hljs-string">   </span>|<br>          |<span class="hljs-string"> saved registers </span>|<span class="hljs-string">   </span>|<br>          |<span class="hljs-string"> local variables </span>|<span class="hljs-string">   </span>|<br>      +-&gt; |<span class="hljs-string">       ...       </span>|<span class="hljs-string">   </span>|<br>      |<span class="hljs-string">   +-----------------+   </span>|<br>      |<span class="hljs-string">   </span>|<span class="hljs-string"> return address  </span>|<span class="hljs-string">   </span>|<br>      |<span class="hljs-string">   </span>|<span class="hljs-string">   previous fp ------+</span><br><span class="hljs-string">      </span>|<span class="hljs-string">   </span>|<span class="hljs-string"> saved registers </span>|<br>      |<span class="hljs-string">   </span>|<span class="hljs-string"> local variables </span>|<br>      |<span class="hljs-string">   </span>|<span class="hljs-string">       ...       </span>|<span class="hljs-string"> &lt;-+</span><br><span class="hljs-string">      </span>|<span class="hljs-string">   +-----------------+   </span>|<br>      |<span class="hljs-string">   </span>|<span class="hljs-string"> return address  </span>|<span class="hljs-string">   </span>|<br>      +------ previous fp   |<span class="hljs-string">   </span>|<br>          |<span class="hljs-string"> saved registers </span>|<span class="hljs-string">   </span>|<br>          |<span class="hljs-string"> local variables </span>|<span class="hljs-string">   </span>|<br>  $fp --&gt; |<span class="hljs-string">       ...       </span>|<span class="hljs-string">   </span>|<br>          +-----------------+   |<span class="hljs-string"></span><br><span class="hljs-string">          </span>|<span class="hljs-string"> return address  </span>|<span class="hljs-string">   </span>|<br>          |<span class="hljs-string">   previous fp ------+</span><br><span class="hljs-string">          </span>|<span class="hljs-string"> saved registers </span>|<br>  $sp --&gt; |<span class="hljs-string"> local variables </span>|<br>          +-----------------+<br><br></code></pre></td></tr></table></figure><ol start="3"><li><code>backtrace</code>å‡½æ•°</li></ol><p>ä¸æ–­é€šè¿‡fp = fp-16è·å–æ ˆå¸§åœ°å€ï¼Œå¯¹äºæ¯ä¸ªæ ˆå¸§ï¼Œæ‰“å°ä¸Šçº§å‡½æ•°çš„è¿”å›åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">backtrace</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  uint64 cur_fp = r_fp();<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;backtrace:\n&quot;</span>);<br>  <span class="hljs-keyword">for</span> (uint64 fp = cur_fp; fp &lt; PGROUNDUP(cur_fp); fp = *((uint64 *)(fp - <span class="hljs-number">16</span>)) ) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>, *((uint64 *)(fp - <span class="hljs-number">8</span>)));<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Alarm-hard"><a href="#Alarm-hard" class="headerlink" title="Alarm (hard)"></a>Alarm (hard)</h4><h5 id="ä»»åŠ¡-1"><a href="#ä»»åŠ¡-1" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>è¯¥èŠ‚ä½ å°†ä¸ºxv6æ·»åŠ å¯¹äºè¿›ç¨‹ä½¿ç”¨CPUæ—¶é—´æ—¶èƒ½å¤Ÿå‘¨æœŸæ€§åœ°å‘å‡ºè­¦æŠ¥çš„åŠŸèƒ½ï¼Œè¿™å¯¹äºè®¡ç®—å¯†é›†å‹è¿›ç¨‹é™åˆ¶ä½¿ç”¨CPUæ—¶é—´æˆ–è€…è¿›ç¨‹å¸Œæœ›å‘¨æœŸæ€§åœ°æ‰§è¡ŒæŸä¸ªåŠ¨ä½œå¾ˆæœ‰ç”¨ï¼›æ›´è¿›ä¸€æ­¥ï¼Œä½ å°†å®ç°ä¸€ä¸ªåˆçº§å½¢å¼çš„ç”¨æˆ·æ€ä¸­æ–­/æ•…éšœå¤„ç†ç¨‹åºï¼Œå’Œå¤„ç†åº”ç”¨ä¸­çš„é¡µé”™è¯¯ç±»ä¼¼</p><p>é¦–å…ˆæ·»åŠ <code>sigalarm(interval, handler)</code>ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚æœç¨‹åºè°ƒç”¨<code>sigalarm(n, fn)</code>ï¼Œåˆ™ç¨‹åºæ¯æ¶ˆè€—nä¸ªticksï¼Œå†…æ ¸è°ƒç”¨ç¨‹åºçš„<code>fn</code>å‡½æ•°ï¼Œå½“<code>fn</code>è¿”å›ï¼Œç¨‹åºåº”è¯¥åœ¨ä¹‹å‰ä¸­æ–­çš„åœ°æ–¹æ¢å¤æ‰§è¡Œï¼›ä¸€ä¸ªtickæ˜¯xv6çš„ä¸€ä¸ªè®¡æ—¶å•å…ƒï¼Œç”±ç¡¬ä»¶æ—¶é’Ÿç”Ÿæˆä¸­æ–­ï¼›å¦‚æœä¸€ä¸ªåº”ç”¨è°ƒç”¨<code>sigalarm(0, 0)</code>ï¼Œå†…æ ¸åº”åœæ­¢å‘¨æœŸæ€§åœ°æ‰§è¡Œalarmè°ƒç”¨</p><h5 id="è¿‡ç¨‹-1"><a href="#è¿‡ç¨‹-1" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><ol><li>æ·»åŠ <code>sys_sigalarm</code>ã€<code>sys_sigreturn</code>ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨å®šä¹‰</li></ol><p>æŒ‰ä¹‹å‰labæ·»åŠ ç³»ç»Ÿè°ƒç”¨çš„æ–¹å¼å³å¯</p><ol start="2"><li>åœ¨<code>proc.h/struct proc</code>æ·»åŠ alarmç›¸å…³çš„æˆå‘˜å˜é‡</li></ol><p>å¦‚ä¸‹æ‰€ç¤ºï¼Œ<code>alarm_ticks</code>ä¸ºalarmçš„å‘¨æœŸï¼Œ<code>alarm_handler_addr</code>ä¸ºalarmå¤„ç†å‡½æ•°çš„åœ°å€ï¼Œè¯¥åœ°å€ä¸ºç”¨æˆ·è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ï¼Œè¿™ä¸¤ä¸ªç”±<code>sys_sigalarm</code>ç³»ç»Ÿè°ƒç”¨å‚æ•°è®¾ç½®ï¼›<code>ticks</code>ä¸ºå½“å‰è¿›ç¨‹æ¶ˆè€—çš„CPUæ—¶é—´ï¼Œ<code>last_ticks</code>ä¸ºä¸Šä¸€æ¬¡æ‰§è¡Œalarmå¤„ç†å‡½æ•°çš„å¼€å§‹CPUæ—¶é—´ï¼Œ<code>alarm_regs</code>ä¸ºæ‰§è¡Œå¤„ç†å‡½æ•°æ—¶ä¿å­˜ä¸éœ€è¦æ¢å¤çš„å¯„å­˜å™¨ç»„å€¼ï¼Œ<code>alarm_running</code>ç”¨æ¥æ ‡è®°æ˜¯å¦è¯¥è¿›ç¨‹æ­£åœ¨æ‰§è¡Œå¤„ç†å‡½æ•°ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">int</span> alarm_ticks;                   <span class="hljs-comment">// lab alarm</span><br>uint64 alarm_handler_addr;         <span class="hljs-comment">// lab alarm</span><br>uint64 ticks;                      <span class="hljs-comment">// lab alarm</span><br>uint64 last_ticks;                 <span class="hljs-comment">// lab alarm</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alarm_regs</span> <span class="hljs-title">regs</span>;</span>            <span class="hljs-comment">// lab alarm</span><br><span class="hljs-keyword">int</span> alarm_running;                 <span class="hljs-comment">// lab alarm</span><br></code></pre></td></tr></table></figure><ol start="3"><li>åˆå§‹åŒ–<code>proc</code>ç»“æ„ä½“alarmç›¸å…³å˜é‡</li></ol><p>åœ¨<code>proc.c/allocproc</code>å‡½æ•°ä¸­å¯¹ä¸Šè¿°å®šä¹‰çš„ç›¸å…³å˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆå§‹ticksä¸º0</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Init ticks for lab alarm</span><br>p-&gt;ticks = <span class="hljs-number">0</span>;<br>p-&gt;last_ticks = <span class="hljs-number">0</span>;<br>p-&gt;alarm_running = <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><ol start="4"><li>æ·»åŠ <code>sys_sigalarm</code>ç³»ç»Ÿè°ƒç”¨å®ç°</li></ol><p><code>sys_sigalarm</code>å¯¹è¿›ç¨‹<code>proc</code>ç»“æ„ä½“çš„<code>alarm_ticks</code>ã€<code>alarm_handler_addr</code>å˜é‡è¿›è¡Œè®¾ç½®ï¼ŒåŒæ—¶è®¾ç½®<code>last_ticks</code>ä¸ºå½“å‰<code>ticks</code>ï¼Œä¹Ÿå³ä»å½“å‰å¼€å§‹è®¡æ—¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">uint64 </span><br><span class="hljs-function"><span class="hljs-title">sys_sigalarm</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> ticks;<br>  uint64 handler_addr;<br><br>  <span class="hljs-keyword">if</span> (argint(<span class="hljs-number">0</span>, &amp;ticks) &lt; <span class="hljs-number">0</span> || argaddr(<span class="hljs-number">1</span>, &amp;handler_addr) &lt; <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br>  p-&gt;alarm_ticks = ticks;<br>  p-&gt;alarm_handler_addr = handler_addr;<br>  p-&gt;last_ticks = p-&gt;ticks;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="5"><li>ä¿å­˜ä¸æ¢å¤ä¸Šä¸‹æ–‡</li></ol><p>å½“è¿›ç¨‹ä»å½“å‰è¿è¡Œåœ°æ–¹åˆ‡æ¢åˆ°å¤„ç†å‡½æ•°å…¥å£åœ°å€æ—¶ï¼Œåº”ä¿å­˜åˆ‡æ¢æ—¶çš„CPUå¯„å­˜å™¨å€¼ï¼Œè¿™é‡Œåœ¨<code>proc.h</code>å®šä¹‰<code>struct alarm_regs</code>ç»“æ„ä½“ï¼Œå…¶éœ€è¦ä¿å­˜çš„å¯„å­˜å™¨åŸºæœ¬å’Œ<code>trapframe</code>ä¸€è‡´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">alarm_regs</span></span><br><span class="hljs-class">&#123;</span><br>  uint64 epc;<br>  uint64 ra;<br>  uint64 sp;<br>  .....<br>  uint64 s10;<br>  uint64 t5;<br>  uint64 t6;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å½“æ‰§è¡Œ<code>sys_sigalarm</code>ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸åï¼Œå½“å‰è¿›ç¨‹ç”¨æˆ·æ€çš„ä¸Šä¸‹æ–‡ï¼Œä¹Ÿå³æ‰§è¡ŒecallæŒ‡ä»¤æ—¶çš„çŠ¶æ€ï¼Œä¿å­˜åœ¨è¿›ç¨‹ç»“æ„ä½“çš„<code>trapframe</code>ä¸­ï¼Œç”±äº<code>sys_sigalarm</code>ç³»ç»Ÿè°ƒç”¨è¿”å›åå¼ºåˆ¶ä½¿å¾—è¯¥è¿›ç¨‹è·³è½¬åˆ°äº†å¤„ç†å‡½æ•°å»æ‰§è¡Œï¼Œæ‰§è¡Œå®Œæˆååœ¨é€šè¿‡<code>sys_sigreturn</code>ç³»ç»Ÿè°ƒç”¨æ¢å¤ï¼Œåœ¨è¿™ä¸ªå¤„ç†å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­<code>trapframe</code>å·²ç»å‘ç”Ÿäº†å¾ˆå¤§å˜åŒ–ï¼Œå› æ­¤éœ€è¦ä¿è¯<code>sys_sigalarm</code>è¿›å…¥æ—¶çš„<code>trapframe</code>å’Œ<code>sys_sigreturn</code>è¿”å›æ—¶çš„<code>trapframe</code>ä¸€è‡´ï¼Œå³å¯æ¢å¤åˆ°æ‰§è¡Œå¤„ç†å‡½æ•°ä¹‹å‰çš„ä½ç½®ç»§ç»­æ‰§è¡Œ</p><p>åœ¨<code>trap.c</code>ä¸­å®šä¹‰ä¿å­˜ä¸æ¢å¤ä¸Šä¸‹æ–‡å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">save_regs</span><span class="hljs-params">(struct proc *p)</span></span><br><span class="hljs-function"></span>&#123;<br>  p-&gt;regs.epc = p-&gt;trapframe-&gt;epc;<br>  p-&gt;regs.ra = p-&gt;trapframe-&gt;ra;<br>  p-&gt;regs.sp = p-&gt;trapframe-&gt;sp;<br>  .........<br>  p-&gt;regs.t3 = p-&gt;trapframe-&gt;t3;<br>  p-&gt;regs.t4 = p-&gt;trapframe-&gt;t4;<br>  p-&gt;regs.t5 = p-&gt;trapframe-&gt;t5;<br>  p-&gt;regs.t6 = p-&gt;trapframe-&gt;t6;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">restore_regs</span><span class="hljs-params">(struct proc *p)</span></span><br><span class="hljs-function"></span>&#123;<br>  p-&gt;trapframe-&gt;epc = p-&gt;regs.epc;<br>  p-&gt;trapframe-&gt;ra = p-&gt;regs.ra;<br>  p-&gt;trapframe-&gt;sp = p-&gt;regs.sp;<br>  p-&gt;trapframe-&gt;gp = p-&gt;regs.gp;<br>  .......<br>  p-&gt;trapframe-&gt;t5 = p-&gt;regs.t5;<br>  p-&gt;trapframe-&gt;t6 = p-&gt;regs.t6;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="6"><li>å¤„ç†æ—¶é’Ÿä¸­æ–­</li></ol><p>æ¯å½“è¿›ç¨‹å› ä¸ºæ—¶é’Ÿä¸­æ–­é™·å…¥åï¼Œè¿›ç¨‹çš„CPUæ—¶é—´<code>ticks</code>å¢åŠ ï¼Œå½“alarmå¤„ç†ç¨‹åºæœªåœ¨è¿è¡Œï¼Œå¹¶ä¸”è®¾ç½®äº†alarmå‘¨æœŸæ—¶é—´ï¼Œåˆ™å½“åˆ°æœŸåå°±å¼€å§‹æ‰§è¡Œå¤„ç†å‡½æ•°</p><p>é¦–å…ˆ<code>p-&gt;last_ticks = p-&gt;ticks</code>è®¾ç½®æœ€åè°ƒç”¨å¤„ç†å‡½æ•°çš„å¼€å§‹æ—¶é—´ä¸ºå½“å‰<code>ticks</code></p><p><code>save_regs(p)</code>ä¿å­˜äº†å°†è¦è°ƒç”¨å¤„ç†å‡½æ•°ä¹‹å‰çš„CPUå¯„å­˜å™¨çŠ¶æ€</p><p><code>p-&gt;trapframe-&gt;epc = p-&gt;alarm_handler_addr</code>å°†é™·å…¥åçš„è¿”å›åœ°å€è®¾ç½®ä¸ºå¤„ç†å‡½æ•°çš„åœ°å€ï¼Œå½“<code>trampoline.S/userret</code>æœ€åçš„<code>sret</code>æŒ‡ä»¤æ‰§è¡Œåï¼Œå³å°†PCè®¾ç½®ä¸ºäº†å¤„ç†å‡½æ•°åœ°å€ï¼Œä¹Ÿå³æ‰§è¡Œè¯¥å¤„ç†å‡½æ•°</p><p><code>p-&gt;alarm_running = 1</code>è¡¨ç¤ºè¯¥è¿›ç¨‹çš„å¤„ç†å‡½æ•°æ­£åœ¨æ‰§è¡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// give up the CPU if this is a timer interrupt.</span><br><span class="hljs-comment">// lab alarm</span><br><span class="hljs-keyword">if</span>(which_dev == <span class="hljs-number">2</span>) &#123;<br>  p-&gt;ticks++;<br>  <span class="hljs-keyword">if</span> (p-&gt;alarm_ticks != <span class="hljs-number">0</span> &amp;&amp; p-&gt;alarm_running == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">if</span> (p-&gt;last_ticks + p-&gt;alarm_ticks &lt;= p-&gt;ticks) &#123;<br>      p-&gt;last_ticks = p-&gt;ticks;<br><br>      save_regs(p);<br>      p-&gt;trapframe-&gt;epc = p-&gt;alarm_handler_addr;<br>      <br>      p-&gt;alarm_running = <span class="hljs-number">1</span>;<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><ol start="7"><li>æ·»åŠ <code>sys_sigreturn</code>ç³»ç»Ÿè°ƒç”¨å®ç°</li></ol><p>åœ¨<code>sysproc.c</code>ä¸­æ·»åŠ <code>sys_sigreturn</code>å®ç°ï¼Œä¸»è¦ä½œç”¨æ˜¯ç”¨æˆ·çš„alarmå¤„ç†å‡½æ•°æ‰§è¡Œåï¼Œæ¢å¤åˆ°å¤„ç†å‡½æ•°æ‰§è¡Œå‰çš„çŠ¶æ€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">uint64 </span><br><span class="hljs-function"><span class="hljs-title">sys_sigreturn</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br>  restore_regs(p);<br>  p-&gt;alarm_running = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="è¿è¡Œç»“æœ"><a href="#è¿è¡Œç»“æœ" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h5><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210402142321.png" alt="image-20210402142321233"></p><h4 id="å®éªŒæµ‹è¯•"><a href="#å®éªŒæµ‹è¯•" class="headerlink" title="å®éªŒæµ‹è¯•"></a>å®éªŒæµ‹è¯•</h4><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210402142613.png" alt="image-20210402142613027"></p><h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><p><a href="https://github.com/whileskies/xv6-labs-2020/tree/traps">https://github.com/whileskies/xv6-labs-2020/tree/traps</a></p>]]></content>
    
    
    <categories>
      
      <category>OS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6.S081-Lab3: page tables</title>
    <link href="/2021/07/11/6-S081-Lab3-page-tables/"/>
    <url>/2021/07/11/6-S081-Lab3-page-tables/</url>
    
    <content type="html"><![CDATA[<h2 id="Lab3-page-tables"><a href="#Lab3-page-tables" class="headerlink" title="Lab3: page tables"></a>Lab3: page tables</h2><p>Lab3ä¸º3ä¸ªé¡µè¡¨ç›¸å…³å®éªŒï¼Œç”¨äºç†è§£osçš„é¡µè¡¨æœºåˆ¶</p><h4 id="Print-a-page-table-easy"><a href="#Print-a-page-table-easy" class="headerlink" title="Print a page table (easy)"></a>Print a page table (easy)</h4><h5 id="ä»»åŠ¡"><a href="#ä»»åŠ¡" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>æŒ‰å±‚æ¬¡è¾“å‡ºå¤šçº§é¡µè¡¨çš„é¡µè¡¨é¡¹ï¼Œå®šä¹‰å‡½æ•°<code>vmprint()</code>ï¼Œå‚æ•°ä¸ºlevel-2çº§é¡µè¡¨åœ°å€<code>pagetable_t</code>ï¼Œå¹¶è¾“å‡ºpidä¸º1çš„è¿›ç¨‹çš„ç”¨æˆ·é¡µè¡¨</p><p>å¯ä»¥å‚ç…§<code>freewalk</code>è¿›è¡Œé€’å½’éå†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Print page table</span><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">vmprint_level</span><span class="hljs-params">(<span class="hljs-keyword">pagetable_t</span> pagetable, <span class="hljs-keyword">int</span> level)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (level &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<br>  <span class="hljs-keyword">if</span> (level == <span class="hljs-number">2</span>)<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;page table %p\n&quot;</span>, pagetable);<br>  <br>  level = level - <span class="hljs-number">1</span>;<br>  <br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">512</span>; i++) &#123;<br>    <span class="hljs-keyword">pte_t</span> pte = pagetable[i];<br>    <span class="hljs-keyword">if</span> (pte &amp; PTE_V) &#123;<br>      <span class="hljs-keyword">if</span> (level == <span class="hljs-number">1</span>)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;..&quot;</span>);<br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (level == <span class="hljs-number">0</span>)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;.. ..&quot;</span>);<br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (level == <span class="hljs-number">-1</span>)<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;.. .. ..&quot;</span>);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d: pte %p pa %p\n&quot;</span>, i, pte, PTE2PA(pte));<br>      uint64 child = PTE2PA(pte);<br>      vmprint_level((<span class="hljs-keyword">pagetable_t</span>)child, level);<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">vmprint</span><span class="hljs-params">(<span class="hljs-keyword">pagetable_t</span> pagetable)</span></span><br><span class="hljs-function"></span>&#123;<br>  vmprint_level(pagetable, <span class="hljs-number">2</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="è¿è¡Œç»“æœ"><a href="#è¿è¡Œç»“æœ" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h5><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210324150317.png" alt="image-20210324150310221"></p><h4 id="A-kernel-page-table-per-process-hard"><a href="#A-kernel-page-table-per-process-hard" class="headerlink" title="A kernel page table per process (hard)"></a>A kernel page table per process (hard)</h4><h5 id="ä»»åŠ¡-1"><a href="#ä»»åŠ¡-1" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>å®ç°æ¯ä¸ªè¿›ç¨‹ä¸€ä¸ªå†…æ ¸é¡µè¡¨</p><p>xv6å½“ä½äºå†…æ ¸æ€æ—¶ä½¿ç”¨çš„æ˜¯å†…æ ¸é¡µè¡¨ï¼Œxv6æœ‰ä¸€ä¸ªå†…æ ¸é¡µè¡¨ç”¨äºå¯¹osè™šæ‹Ÿåœ°å€è¿›è¡Œæ˜ å°„ï¼Œè¯¥é¡µè¡¨å¯¹ç‰©ç†å†…å­˜è¿›è¡Œä¸€ä¸€æ˜ å°„ï¼Œä¹Ÿå³å†…æ ¸è™šæ‹Ÿåœ°å€xæ˜ å°„ä¸ºç‰©ç†åœ°å€xï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210324151158.png" alt="image-20210324151158499" style="zoom:50%;" /><p>åŒæ—¶xv6å¯¹äºæ¯ä¸ªè¿›ç¨‹ä¹Ÿæœ‰ä¸ªç”¨æˆ·é¡µè¡¨ï¼Œç”¨äºæ˜ å°„ç”¨æˆ·è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ä»0å¼€å§‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210324151523.png" alt="image-20210324151523096" style="zoom:50%;" /><p>ç„¶è€Œå†…æ ¸é¡µè¡¨ä¸å«æœ‰è¿›ç¨‹ç”¨æˆ·åœ°å€ç©ºé—´çš„æ˜ å°„ï¼ˆå¦‚ä»£ç æ®µã€æ•°æ®æ®µã€å †æ®µã€æ ˆæ®µï¼‰ï¼Œosåœ¨å†…æ ¸æ€æ‰§è¡Œæ—¶å¯¹äºè¿™äº›ç”¨æˆ·åœ°å€æ˜¯ä¸åˆæ³•çš„ï¼Œå› æ­¤ï¼Œå½“å†…æ ¸åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­éœ€è¦ä½¿ç”¨ä½œä¸ºå‚æ•°çš„ç”¨æˆ·æŒ‡é’ˆè¿›è¡Œè¿”å›æ•°æ®æ—¶ï¼Œå†…æ ¸å¿…é¡»å…ˆè¦å°†ç”¨æˆ·æŒ‡é’ˆæ ¹æ®ç”¨æˆ·é¡µè¡¨è½¬æ¢ä¸ºç‰©ç†åœ°å€ã€‚æœ¬èŠ‚ä»¥åŠä¸‹ä¸€èŠ‚å®éªŒç›®æ ‡æ˜¯å…è®¸å†…æ ¸å»ç›´æ¥è§£å¼•ç”¨ç”¨æˆ·æŒ‡é’ˆæ‰€æŒ‡çš„åœ°å€ï¼Œè€Œä¸å†å…ˆé€šè¿‡ç”¨æˆ·ç”¨æˆ·é¡µè¡¨è½¬æ¢</p><p>æœ¬èŠ‚ä»»åŠ¡æ˜¯ä¿®æ”¹å†…æ ¸ï¼Œä½¿å¾—æ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªå†…æ ¸é¡µè¡¨çš„å‰¯æœ¬ï¼Œå½“åœ¨å†…æ ¸æ‰§è¡Œæ—¶ï¼Œä½¿ç”¨è¯¥å†…æ ¸é¡µè¡¨å‰¯æœ¬ï¼Œè€Œä¸æ˜¯åŸæœ¬çš„å†…æ ¸é¡µè¡¨</p><h5 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><ol><li>åœ¨è¿›ç¨‹æ•°æ®ç»“æ„ä¸­å¢åŠ å†…æ ¸é¡µè¡¨åŸŸï¼Œä½äº<code>proc.h</code></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> &#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">spinlock</span> <span class="hljs-title">lock</span>;</span><br><br>  <span class="hljs-comment">// p-&gt;lock must be held when using these:</span><br>  <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">procstate</span> <span class="hljs-title">state</span>;</span>        <span class="hljs-comment">// Process state</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">parent</span>;</span>         <span class="hljs-comment">// Parent process</span><br>  <span class="hljs-keyword">void</span> *chan;                  <span class="hljs-comment">// If non-zero, sleeping on chan</span><br>  <span class="hljs-keyword">int</span> killed;                  <span class="hljs-comment">// If non-zero, have been killed</span><br>  <span class="hljs-keyword">int</span> xstate;                  <span class="hljs-comment">// Exit status to be returned to parent&#x27;s wait</span><br>  <span class="hljs-keyword">int</span> pid;                     <span class="hljs-comment">// Process ID</span><br><br>  <span class="hljs-comment">// these are private to the process, so p-&gt;lock need not be held.</span><br>  uint64 kstack;               <span class="hljs-comment">// Virtual address of kernel stack</span><br>  uint64 sz;                   <span class="hljs-comment">// Size of process memory (bytes)</span><br>  <span class="hljs-keyword">pagetable_t</span> pagetable;       <span class="hljs-comment">// User page table</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">trapframe</span> *<span class="hljs-title">trapframe</span>;</span> <span class="hljs-comment">// data page for trampoline.S</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">context</span> <span class="hljs-title">context</span>;</span>      <span class="hljs-comment">// swtch() here to run process</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">ofile</span>[<span class="hljs-title">NOFILE</span>];</span>  <span class="hljs-comment">// Open files</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">cwd</span>;</span>           <span class="hljs-comment">// Current directory</span><br>  <span class="hljs-keyword">char</span> name[<span class="hljs-number">16</span>];               <span class="hljs-comment">// Process name (debugging)</span><br><br>  <span class="hljs-keyword">pagetable_t</span> kernel_pagetable; <span class="hljs-comment">// lab3 user kernel pagetable</span><br>&#125;;<br></code></pre></td></tr></table></figure><ol start="2"><li>å‚è€ƒ<code>kvminit</code>å®šä¹‰<code>user_kvminit</code>åˆå§‹åŒ–è¿›ç¨‹å†…æ ¸é¡µè¡¨</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Lab3: A kernel page table per process.</span><br><span class="hljs-function"><span class="hljs-keyword">pagetable_t</span></span><br><span class="hljs-function"><span class="hljs-title">user_kvminit</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">pagetable_t</span> user_kernel_pt = (<span class="hljs-keyword">pagetable_t</span>) kalloc();<br>  <span class="hljs-keyword">if</span> (user_kernel_pt == <span class="hljs-number">0</span>) <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">memset</span>(user_kernel_pt, <span class="hljs-number">0</span>, PGSIZE);<br>  <br><br>  <span class="hljs-comment">// uart registers</span><br>  mappages(user_kernel_pt, UART0, PGSIZE, UART0, PTE_R | PTE_W);<br><br>  <span class="hljs-comment">// virtio mmio disk interface</span><br>  mappages(user_kernel_pt, VIRTIO0, PGSIZE, VIRTIO0, PTE_R | PTE_W);<br><br>  <span class="hljs-comment">// CLINT</span><br>  <span class="hljs-comment">// mappages(user_kernel_pt, CLINT, 0x10000, CLINT, PTE_R | PTE_W);</span><br><br>  <span class="hljs-comment">// PLIC</span><br>  mappages(user_kernel_pt, PLIC, <span class="hljs-number">0x400000</span>, PLIC, PTE_R | PTE_W);<br><br>  <span class="hljs-comment">// map kernel text executable and read-only.</span><br>  mappages(user_kernel_pt, KERNBASE, (uint64)etext-KERNBASE, KERNBASE, PTE_R | PTE_X);<br><br>  <span class="hljs-comment">// map kernel data and the physical RAM we&#x27;ll make use of.</span><br>  mappages(user_kernel_pt, (uint64)etext, PHYSTOP-(uint64)etext, (uint64)etext, PTE_R | PTE_W);<br><br>  <span class="hljs-comment">// map the trampoline for trap entry/exit to</span><br>  <span class="hljs-comment">// the highest virtual address in the kernel.</span><br>  mappages(user_kernel_pt, TRAMPOLINE, PGSIZE, (uint64)trampoline, PTE_R | PTE_X);<br><br>  <span class="hljs-keyword">return</span> user_kernel_pt;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>åˆå§‹åŒ–è¿›ç¨‹å†…æ ¸é¡µè¡¨</li></ol><p>åœ¨<code>proc.c/allocproc</code>å‡½æ•°ä¸­å½“åˆ†é…ä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œåˆå§‹åŒ–è¿›ç¨‹å†…æ ¸é¡µè¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// An empty user page table.</span><br>p-&gt;pagetable = proc_pagetable(p);<br><span class="hljs-keyword">if</span>(p-&gt;pagetable == <span class="hljs-number">0</span>)&#123;<br>  freeproc(p);<br>  release(&amp;p-&gt;lock);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// Init kernel page table per process.</span><br>p-&gt;kernel_pagetable = user_kvminit();<br><span class="hljs-keyword">if</span> (p-&gt;kernel_pagetable == <span class="hljs-number">0</span>) &#123;<br>  freeproc(p);<br>  release(&amp;p-&gt;lock);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>æ¯ä¸ªè¿›ç¨‹å†…æ ¸é¡µè¡¨æ˜ å°„è¿›ç¨‹çš„å†…æ ¸æ ˆ</li></ol><p>æ¯ä¸ªè¿›ç¨‹æœ‰ä¸¤ä¸ªæ ˆï¼Œä¸€ä¸ªæ˜¯ç”¨æˆ·æ ˆï¼Œå½“è¿›ç¨‹åœ¨ç”¨æˆ·æ€æ‰§è¡Œæ—¶ä½¿ç”¨è¯¥æ ˆï¼Œå½“è¯¥è¿›ç¨‹é™·å…¥åï¼Œä½¿ç”¨è¯¥è¿›ç¨‹çš„å†…æ ¸æ ˆï¼Œåœ¨ä¹‹å‰åªæœ‰ä¸€ä¸ªå†…æ ¸é¡µè¡¨æ—¶ï¼Œ<code>proc.c/procinit</code>å‡½æ•°ä¸­åˆ†é…è¿›ç¨‹å†…æ ¸æ ˆç‰©ç†ç©ºé—´ï¼Œå†…æ ¸é¡µè¡¨å¯¹è¿›ç¨‹å†…æ ¸æ ˆè¿›è¡Œæ˜ å°„ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Allocate a page for the process&#x27;s kernel stack.</span><br><span class="hljs-comment">// Map it high in memory, followed by an invalid</span><br><span class="hljs-comment">// guard page.</span><br><span class="hljs-keyword">char</span> *pa = kalloc();<br><span class="hljs-keyword">if</span>(pa == <span class="hljs-number">0</span>)<br>  panic(<span class="hljs-string">&quot;kalloc&quot;</span>);<br>uint64 va = KSTACK((<span class="hljs-keyword">int</span>) (p - proc));<br>kvmmap(va, (uint64)pa, PGSIZE, PTE_R | PTE_W);<br>p-&gt;kstack = va;<br></code></pre></td></tr></table></figure><p>å½“æ¯ä¸ªè¿›ç¨‹ä¸€ä¸ªå†…æ ¸é¡µè¡¨æ—¶ï¼Œè¿›ç¨‹é™·å…¥åä½¿ç”¨çš„æ˜¯è¯¥è¿›ç¨‹çš„å†…æ ¸é¡µè¡¨ï¼Œè¿è¡Œçš„æ ˆä¸ºè¯¥è¿›ç¨‹çš„å†…æ ¸æ ˆï¼Œå› æ­¤è¿›ç¨‹å†…æ ¸é¡µè¡¨åº”å¯¹è¿›ç¨‹å†…æ ¸æ ˆè¿›è¡Œæ˜ å°„ï¼Œå°†<code>proc.c/procinit</code>çš„ä¸Šè¿°ä»£ç ç§»åŠ¨åˆ°<code>/proc.c/allocproc</code>ä¸­å»ï¼Œå¹¶ä¸”è¢«æ˜ å°„çš„é¡µè¡¨æ”¹ä¸ºè¿›ç¨‹å†…æ ¸é¡µè¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Allocate a page for the process&#x27;s kernel stack.</span><br><span class="hljs-comment">// Map it high in memory, followed by an invalid</span><br><span class="hljs-comment">// guard page.</span><br><span class="hljs-keyword">char</span> *pa = kalloc();<br><span class="hljs-keyword">if</span>(pa == <span class="hljs-number">0</span>)<br>  panic(<span class="hljs-string">&quot;kalloc&quot;</span>);<br>uint64 va = KSTACK((<span class="hljs-keyword">int</span>) (p - proc));<br>mappages(p-&gt;kernel_pagetable, va, PGSIZE, (uint64)pa, PTE_R | PTE_W);<br>p-&gt;kstack = va;<br></code></pre></td></tr></table></figure><ol start="5"><li>ä¿®æ”¹<code>proc.c/scheduler</code></li></ol><p>ä½¿å¾—åˆ‡æ¢è¿›ç¨‹æ—¶åº”ç”¨è¯¥å†…æ ¸é¡µè¡¨ï¼Œå½“è¿›ç¨‹é€šè¿‡<code>switch</code>åˆ‡æ¢å›å»æ—¶ï¼Œè¯¥è¿‡ç¨‹ä¸ºé™·å…¥çš„è¿”å›è¿‡ç¨‹ï¼Œåœ¨<code>trap.c/usertrapret</code>ä¸­ï¼Œæœ‰ä¿å­˜å½“å‰å¯„å­˜å™¨é¡µè¡¨çš„æ“ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// set up trapframe values that uservec will need when</span><br><span class="hljs-comment">// the process next re-enters the kernel.</span><br>p-&gt;trapframe-&gt;kernel_satp = r_satp();         <span class="hljs-comment">// kernel page table</span><br>p-&gt;trapframe-&gt;kernel_sp = p-&gt;kstack + PGSIZE; <span class="hljs-comment">// process&#x27;s kernel stack</span><br>p-&gt;trapframe-&gt;kernel_trap = (uint64)usertrap;<br>p-&gt;trapframe-&gt;kernel_hartid = r_tp();         <span class="hljs-comment">// hartid for cpuid(</span><br></code></pre></td></tr></table></figure><p>è‹¥åœ¨<code>switch</code>ä¹‹å‰å°†å¯„å­˜å™¨é¡µè¡¨ä»å†…æ ¸é¡µè¡¨åˆ‡æ¢ä¸ºè¿›ç¨‹å†…æ ¸é¡µè¡¨ï¼Œåˆ™å½“è¿›ç¨‹è¿”å›ç”¨æˆ·æ€å¹¶å†æ¬¡é™·å…¥åå°±ä¼šä½¿ç”¨è¿›ç¨‹å†…æ ¸é¡µè¡¨äº†ï¼Œä»£ç ä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">p-&gt;state = RUNNING;<br>c-&gt;proc = p;<br><br>w_satp(MAKE_SATP(p-&gt;kernel_pagetable));<br>sfence_vma();<br><br>swtch(&amp;c-&gt;context, &amp;p-&gt;context);<br></code></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰è¿›ç¨‹éœ€è¦è°ƒåº¦æ—¶ï¼Œä»ç„¶ä½¿ç”¨å†…æ ¸é¡µè¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(found == <span class="hljs-number">0</span>) &#123;<br>  w_satp(MAKE_SATP(kernel_pagetable));<br>  sfence_vma();<br><br>  intr_on();<br>  <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span><span class="hljs-params">(<span class="hljs-string">&quot;wfi&quot;</span>)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="6"><li>é‡Šæ”¾è¿›ç¨‹</li></ol><p>å½“éœ€è¦é‡Šæ”¾è¿›ç¨‹æ—¶ï¼ŒåŒæ—¶ä¹Ÿåº”é‡Šæ”¾è¯¥è¿›ç¨‹çš„å†…æ ¸æ ˆï¼Œè¿›ç¨‹å†…æ ¸é¡µè¡¨ï¼Œä½†ä¸åº”è¯¥é‡Šæ”¾è¿›ç¨‹å†…æ ¸é¡µè¡¨æ‰€æ˜ å°„çš„ç‰©ç†åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (p-&gt;kstack) &#123;<br>  <span class="hljs-keyword">pte_t</span> *pte = walk(p-&gt;kernel_pagetable, p-&gt;kstack, <span class="hljs-number">0</span>);<br>  uint64 pa = (uint64)PTE2PA(*pte);<br>  kfree((<span class="hljs-keyword">void</span> *)pa);  <br>&#125;<br><br><span class="hljs-keyword">if</span> (p-&gt;kernel_pagetable)<br>  free_pro_kernel_pagetable(p-&gt;kernel_pagetable);<br>p-&gt;kernel_pagetable = <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><ol start="7"><li>é‡Šæ”¾è¿›ç¨‹å†…æ ¸é¡µè¡¨</li></ol><p>é€’å½’é‡Šæ”¾è¿›ç¨‹å†…æ ¸é¡µè¡¨ï¼Œå½“ä¸é‡Šæ”¾é¡µè¡¨æ‰€æ˜ å°„çš„ç‰©ç†é¡µ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Free process kernel pagetable for lab3</span><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">free_pro_kernel_pagetable</span><span class="hljs-params">(<span class="hljs-keyword">pagetable_t</span> pagetable)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">512</span>; i++) &#123;<br>    <span class="hljs-keyword">pte_t</span> pte = pagetable[i];<br><span class="hljs-keyword">if</span> ((pte &amp; PTE_V) &amp;&amp; (pte &amp; (PTE_R|PTE_W|PTE_X)) == <span class="hljs-number">0</span>) &#123;<br>      uint64 child = PTE2PA(pte);<br>      free_pro_kernel_pagetable((<span class="hljs-keyword">pagetable_t</span>)child);<br>      pagetable[i] = <span class="hljs-number">0</span>;<br>&#125;<br>  &#125;<br>  kfree((<span class="hljs-keyword">void</span>*)pagetable);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="8"><li>ä¿®æ”¹bug</li></ol><p>å°†<code>vm.c/kvmpa</code>ä¸­çš„<code>pte = walk(kernel_pagetable, va, 0);</code>ä¿®æ”¹ä¸ºå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// pte = walk(kernel_pagetable, va, 0);</span><br><span class="hljs-comment">// process kernel pagetable has the map on the process kernel stack</span><br>pte = walk(myproc()-&gt;kernel_pagetable, va, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span>(pte == <span class="hljs-number">0</span>)<br>  panic(<span class="hljs-string">&quot;kvmpa&quot;</span>)<br></code></pre></td></tr></table></figure><ol start="9"><li>å…¶ä»–é—®é¢˜</li></ol><p>åœ¨ä½¿ç”¨<code>usertests</code>ç¨‹åºè¿›è¡Œæµ‹è¯•æ—¶ï¼Œä¼šé‡åˆ°æœ‰æ—¶èƒ½å…¨é€šè¿‡ï¼Œæœ‰æ—¶å‡ºç°panicï¼Œå¯ä»¥åœ¨<code>switch</code>ä¹‹åå†åˆ‡æ¢å›å†…æ ¸é¡µè¡¨ï¼Œå¦‚ä¸‹å›¾ï¼Œè°ƒåº¦å™¨ä½¿ç”¨çš„æ˜¯å†…æ ¸æ ˆï¼Œå…¶ä»–è¿›ç¨‹é™·å…¥æ—¶ä½¿ç”¨çš„æ˜¯è¿›ç¨‹å†…æ ¸æ ˆï¼Œå†…æ ¸é¡µè¡¨å’Œè¿›ç¨‹å†…æ ¸é¡µè¡¨æ˜ å°„ä¸å®Œå…¨ä¸€è‡´</p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210324162457.png" alt="image-20210324162457924" style="zoom:67%;" /><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">w_satp(MAKE_SATP(p-&gt;kernel_pagetable));<br>sfence_vma();<br><br>swtch(&amp;c-&gt;context, &amp;p-&gt;context);<br><br>kvminithart();<br><br>c-&gt;proc = <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><h5 id="è¿è¡Œç»“æœ-1"><a href="#è¿è¡Œç»“æœ-1" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h5><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210324162943.png" alt="image-20210324162943188"></p><h4 id="Simplify-copyin-copyinstr-hard"><a href="#Simplify-copyin-copyinstr-hard" class="headerlink" title="Simplify copyin/copyinstr (hard)"></a>Simplify copyin/copyinstr (hard)</h4><h5 id="ä»»åŠ¡-2"><a href="#ä»»åŠ¡-2" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>å†…æ ¸çš„<code>copyin</code>å‡½æ•°è¯»å–ç”¨æˆ·åœ°å€æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ï¼Œå› æ­¤éœ€ç”¨é€šè¿‡è¿›ç¨‹çš„ç”¨æˆ·é¡µè¡¨è½¬æ¢ä¸ºç‰©ç†åœ°å€æ¥è®¿é—®ã€‚å®éªŒè¯¥éƒ¨åˆ†çš„ä»»åŠ¡æ˜¯ç»™æ¯ä¸ªè¿›ç¨‹çš„å†…æ ¸é¡µè¡¨æ·»åŠ è¯¥è¿›ç¨‹è™šæ‹Ÿåœ°å€çš„æ˜ å°„ï¼Œä»¥å…è®¸<code>copyin</code>å¯ä»¥ç›´æ¥è§£å¼•ç”¨ç”¨æˆ·æŒ‡é’ˆ</p><h5 id="è¿‡ç¨‹-1"><a href="#è¿‡ç¨‹-1" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><p>ä¸»è¦æ€è·¯æ˜¯åœ¨å¯¹è¿›ç¨‹ç”¨æˆ·é¡µè¡¨è¿›è¡Œæ˜ å°„çš„åŒæ—¶ï¼Œå°†ç”¨æˆ·è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ç”¨æˆ·å†…æ ¸é¡µè¡¨</p><ol><li>æ›¿æ¢<code>copyin</code>ä¸<code>copyinstr</code>å®ç°</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Copy from user to kernel.</span><br><span class="hljs-comment">// Copy len bytes to dst from virtual address srcva in a given page table.</span><br><span class="hljs-comment">// Return 0 on success, -1 on error.</span><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">copyin</span><span class="hljs-params">(<span class="hljs-keyword">pagetable_t</span> pagetable, <span class="hljs-keyword">char</span> *dst, uint64 srcva, uint64 len)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">return</span> copyin_new(pagetable, dst, srcva, len);<br>&#125;<br><br><span class="hljs-comment">// Copy a null-terminated string from user to kernel.</span><br><span class="hljs-comment">// Copy bytes to dst from virtual address srcva in a given page table,</span><br><span class="hljs-comment">// until a &#x27;\0&#x27;, or max.</span><br><span class="hljs-comment">// Return 0 on success, -1 on error.</span><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">copyinstr</span><span class="hljs-params">(<span class="hljs-keyword">pagetable_t</span> pagetable, <span class="hljs-keyword">char</span> *dst, uint64 srcva, uint64 max)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">return</span> copyinstr_new(pagetable, dst, srcva, max);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>ä¿®æ”¹<code>vm.c/uvmcopy</code>ï¼Œå¯¹ç”¨æˆ·é¡µè¡¨æ˜ å°„æ—¶ï¼ŒåŒæ—¶æ˜ å°„ç”¨æˆ·å†…æ ¸é¡µè¡¨</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">uvmcopy</span><span class="hljs-params">(<span class="hljs-keyword">pagetable_t</span> old, <span class="hljs-keyword">pagetable_t</span> <span class="hljs-keyword">new</span>, <span class="hljs-keyword">pagetable_t</span> kernelpt, uint64 sz)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">pte_t</span> *pte;<br>  uint64 pa, i;<br>  uint flags;<br>  <span class="hljs-keyword">char</span> *mem;<br><br>  <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; sz; i += PGSIZE)&#123;<br>    <span class="hljs-keyword">if</span>((pte = walk(old, i, <span class="hljs-number">0</span>)) == <span class="hljs-number">0</span>)<br>      panic(<span class="hljs-string">&quot;uvmcopy: pte should exist&quot;</span>);<br>    <span class="hljs-keyword">if</span>((*pte &amp; PTE_V) == <span class="hljs-number">0</span>)<br>      panic(<span class="hljs-string">&quot;uvmcopy: page not present&quot;</span>);<br>    pa = PTE2PA(*pte);<br>    flags = PTE_FLAGS(*pte);<br>    <span class="hljs-keyword">if</span>((mem = kalloc()) == <span class="hljs-number">0</span>)<br>      <span class="hljs-keyword">goto</span> err;<br>    memmove(mem, (<span class="hljs-keyword">char</span>*)pa, PGSIZE);<br>    <span class="hljs-keyword">if</span>(mappages(<span class="hljs-keyword">new</span>, i, PGSIZE, (uint64)mem, flags) != <span class="hljs-number">0</span> ||<br>      mappages(kernelpt, i, PGSIZE, (uint64)mem, flags &amp; ~PTE_U) != <span class="hljs-number">0</span>)&#123;<br>      kfree(mem);<br>      <span class="hljs-keyword">goto</span> err;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br> err:<br>  uvmunmap(<span class="hljs-keyword">new</span>, <span class="hljs-number">0</span>, i / PGSIZE, <span class="hljs-number">1</span>);<br>  uvmunmap(kernelpt, <span class="hljs-number">0</span>, i / PGSIZE, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>ä¿®æ”¹<code>vm.c/uvmalloc</code>ï¼Œå¯¹ç”¨æˆ·é¡µè¡¨æ˜ å°„æ—¶ï¼ŒåŒæ—¶æ˜ å°„ç”¨æˆ·å†…æ ¸é¡µè¡¨</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">uint64</span><br><span class="hljs-function"><span class="hljs-title">uvmalloc</span><span class="hljs-params">(<span class="hljs-keyword">pagetable_t</span> pagetable, <span class="hljs-keyword">pagetable_t</span> kernelpt, uint64 oldsz, uint64 newsz)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">char</span> *mem;<br>  uint64 a;<br><br>  <span class="hljs-keyword">if</span>(newsz &lt; oldsz)<br>    <span class="hljs-keyword">return</span> oldsz;<br><br>  oldsz = PGROUNDUP(oldsz);<br>  <span class="hljs-keyword">for</span>(a = oldsz; a &lt; newsz; a += PGSIZE)&#123;<br>    mem = kalloc();<br>    <span class="hljs-keyword">if</span>(mem == <span class="hljs-number">0</span>)&#123;<br>      uvmdealloc(pagetable, a, oldsz);<br>      uvmdealloc_nofree(kernelpt, a, oldsz);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-built_in">memset</span>(mem, <span class="hljs-number">0</span>, PGSIZE);<br>    <span class="hljs-keyword">if</span>(mappages(pagetable, a, PGSIZE, (uint64)mem, PTE_W|PTE_X|PTE_R|PTE_U) != <span class="hljs-number">0</span> ||<br>       mappages(kernelpt, a, PGSIZE, (uint64)mem, PTE_W|PTE_X|PTE_R)) &#123;<br>      kfree(mem);<br>      uvmdealloc(pagetable, a, oldsz);<br>      uvmdealloc_nofree(kernelpt, a, oldsz);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> newsz;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>ä¿®æ”¹<code>vm.c/uvminit</code></li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">uvminit</span><span class="hljs-params">(<span class="hljs-keyword">pagetable_t</span> pagetable, <span class="hljs-keyword">pagetable_t</span> kernelpt, uchar *src, uint sz)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">char</span> *mem;<br><br>  <span class="hljs-keyword">if</span>(sz &gt;= PGSIZE)<br>    panic(<span class="hljs-string">&quot;inituvm: more than a page&quot;</span>);<br>  mem = kalloc();<br>  <span class="hljs-built_in">memset</span>(mem, <span class="hljs-number">0</span>, PGSIZE);<br>  mappages(pagetable, <span class="hljs-number">0</span>, PGSIZE, (uint64)mem, PTE_W|PTE_R|PTE_X|PTE_U);<br>  mappages(kernelpt, <span class="hljs-number">0</span>, PGSIZE, (uint64)mem, PTE_W|PTE_R|PTE_X);<br>  memmove(mem, src, sz);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="5"><li>ä¿®æ”¹<code>proc.c/fork</code></li></ol><p>forkå¤åˆ¶çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´åˆ°å­è¿›ç¨‹ï¼Œå¤åˆ¶ç”¨æˆ·é¡µè¡¨åŒæ—¶ï¼Œå°†å…¶æ˜ å°„åˆ°å­è¿›ç¨‹å†…æ ¸é¡µè¡¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(uvmcopy(p-&gt;pagetable, np-&gt;pagetable, np-&gt;kernel_pagetable, p-&gt;sz) &lt; <span class="hljs-number">0</span>)&#123;<br>    freeproc(np);<br>    release(&amp;np-&gt;lock);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="6"><li>ä¿®æ”¹<code>proc.c/exec</code></li></ol><p>åˆ›å»ºè¿›ç¨‹æ—¶éœ€è¦å¯¹ç”¨æˆ·è™šæ‹Ÿåœ°å€è¿›è¡Œæ˜ å°„ï¼Œåº”åŒæ—¶æ˜ å°„åˆ°è¿›ç¨‹å†…æ ¸é¡µè¡¨</p><p>å› ä¸ºæ­¤æ—¶æ­£ä½¿ç”¨ç”¨æˆ·å†…æ ¸é¡µè¡¨ï¼Œé‡Šæ”¾æ—§çš„ç”¨æˆ·å†…æ ¸é¡µè¡¨ä¹‹å‰ï¼Œåº”é‡æ–°è®¾ç½®é¡µè¡¨å¯„å­˜å™¨ä¸ºæ–°çš„ç”¨æˆ·å†…æ ¸é¡µè¡¨ï¼ŒåŒæ—¶åˆ·æ–°TLB</p><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210330094716.png" alt="image-20210330094709357"></p><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210330094738.png" alt="image-20210330094737962"></p><ol start="7"><li>ä¿®æ”¹<code>sysproc.c/sys_sbrk</code></li></ol><p>é˜²æ­¢åœ¨ç”¨æˆ·å†…æ ¸é¡µè¡¨ä¸­çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€è¶…è¿‡PLICé™åˆ¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">uint64</span><br><span class="hljs-function"><span class="hljs-title">sys_sbrk</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> addr;<br>  <span class="hljs-keyword">int</span> n;<br><br>  <span class="hljs-keyword">if</span>(argint(<span class="hljs-number">0</span>, &amp;n) &lt; <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  addr = myproc()-&gt;sz;<br>  <span class="hljs-keyword">if</span> (PGROUNDUP(addr + n) &gt;= PLIC) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span>(growproc(n) &lt; <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  <span class="hljs-keyword">return</span> addr;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="8"><li>å¤åˆ¶å¹¶ä¿®æ”¹<code>vm.c/walkaddr</code>å‡½æ•°ä¸º<code>vm.c/kernelpt_walkaddr</code></li></ol><p>ç”±äº<code>walkaddr</code>å‡½æ•°åªèƒ½è½¬æ¢ç”¨æˆ·é¡µè¡¨çš„è™šæ‹Ÿåœ°å€ï¼Œå› æ­¤å¤åˆ¶ä¸€ä»½å¯ä»¥è½¬æ¢å†…æ ¸é¡µè¡¨çš„è™šæ‹Ÿåœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Look up a virtual address, return the physical address,</span><br><span class="hljs-comment">// or 0 if not mapped.</span><br><span class="hljs-comment">// Can be used to look up kernel page.</span><br><span class="hljs-function">uint64</span><br><span class="hljs-function"><span class="hljs-title">kernelpt_walkaddr</span><span class="hljs-params">(<span class="hljs-keyword">pagetable_t</span> pagetable, uint64 va)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">pte_t</span> *pte;<br>  uint64 pa;<br><br>  <span class="hljs-keyword">if</span>(va &gt;= MAXVA)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>  pte = walk(pagetable, va, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span>(pte == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span>((*pte &amp; PTE_V) == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  pa = PTE2PA(*pte);<br>  <span class="hljs-keyword">return</span> pa;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="9"><li>å¤åˆ¶å¹¶ä¿®æ”¹<code>vm.c/uvmdealloc</code>å‡½æ•°ä¸º<code>vm.c/uvmdealloc_nofree</code></li></ol><p>ç”±äº<code>uvmdealloc</code>å‡½æ•°ç”¨äºå–æ¶ˆç”¨æˆ·é¡µè¡¨çš„æ˜ å°„ï¼Œå¹¶åˆ é™¤ç‰©ç†é¡µï¼Œä½†æ˜¯ç”¨æˆ·å†…æ ¸é¡µè¡¨å–æ¶ˆæ˜ å°„æ—¶ä¸èƒ½åˆ é™¤ç‰©ç†é¡µï¼Œå› æ­¤ä¿®æ”¹æ­¤å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">uint64</span><br><span class="hljs-function"><span class="hljs-title">uvmdealloc_nofree</span><span class="hljs-params">(<span class="hljs-keyword">pagetable_t</span> pagetable, uint64 oldsz, uint64 newsz)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span>(newsz &gt;= oldsz)<br>    <span class="hljs-keyword">return</span> oldsz;<br><br>  <span class="hljs-keyword">if</span>(PGROUNDUP(newsz) &lt; PGROUNDUP(oldsz))&#123;<br>    <span class="hljs-keyword">int</span> npages = (PGROUNDUP(oldsz) - PGROUNDUP(newsz)) / PGSIZE;<br>    uvmunmap(pagetable, PGROUNDUP(newsz), npages, <span class="hljs-number">0</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> newsz;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å®éªŒæµ‹è¯•"><a href="#å®éªŒæµ‹è¯•" class="headerlink" title="å®éªŒæµ‹è¯•"></a>å®éªŒæµ‹è¯•</h4><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210330100558.png" alt="image-20210330100558882"></p><h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><p><a href="https://github.com/whileskies/xv6-labs-2020/tree/pgtbl">https://github.com/whileskies/xv6-labs-2020/tree/pgtbl</a></p>]]></content>
    
    
    <categories>
      
      <category>OS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6.S081-Lab2: system calls</title>
    <link href="/2021/07/11/6-S081-Lab2-system-calls/"/>
    <url>/2021/07/11/6-S081-Lab2-system-calls/</url>
    
    <content type="html"><![CDATA[<h2 id="Lab2-system-calls"><a href="#Lab2-system-calls" class="headerlink" title="Lab2: system calls"></a>Lab2: system calls</h2><p>Lab2ä¸ºxv6æ·»åŠ ä¸€äº›ç³»ç»Ÿè°ƒç”¨ï¼Œä»¥ä¾¿äº†è§£ç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹</p><h4 id="System-call-tracing-moderate"><a href="#System-call-tracing-moderate" class="headerlink" title="System call tracing (moderate)"></a>System call tracing (moderate)</h4><h5 id="ä»»åŠ¡"><a href="#ä»»åŠ¡" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>æ·»åŠ ä¸€ä¸ª<code>trace</code>ç³»ç»Ÿè°ƒç”¨ï¼Œå‚æ•°ä¸ºç³»ç»Ÿè°ƒç”¨å·æ©ç ï¼Œç”¨äºè¿½è¸ªç³»ç»Ÿè°ƒç”¨çš„è·¯å¾„ä»¥åŠè¿”å›å€¼</p><h5 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><ol><li>é¦–å…ˆä¸º<code>proc.h</code>ä¸­çš„<code>proc</code>ç»“æ„ä½“æ·»åŠ ä¸€ä¸ªè·Ÿè¸ªæ©ç å­—æ®µï¼š</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// these are private to the process, so p-&gt;lock need not be held.</span><br>  uint64 kstack;               <span class="hljs-comment">// Virtual address of kernel stack</span><br>  uint64 sz;                   <span class="hljs-comment">// Size of process memory (bytes)</span><br>  <span class="hljs-keyword">pagetable_t</span> pagetable;       <span class="hljs-comment">// User page table</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">trapframe</span> *<span class="hljs-title">trapframe</span>;</span> <span class="hljs-comment">// data page for trampoline.S</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">context</span> <span class="hljs-title">context</span>;</span>      <span class="hljs-comment">// swtch() here to run process</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">ofile</span>[<span class="hljs-title">NOFILE</span>];</span>  <span class="hljs-comment">// Open files</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">cwd</span>;</span>           <span class="hljs-comment">// Current directory</span><br>  <span class="hljs-keyword">char</span> name[<span class="hljs-number">16</span>];               <span class="hljs-comment">// Process name (debugging)</span><br>  <span class="hljs-keyword">int</span> trace_mask;              <span class="hljs-comment">// trace syscall mas</span><br></code></pre></td></tr></table></figure><ol start="2"><li>ä¸ºç»™ç³»ç»Ÿè°ƒç”¨æ·»åŠ ç³»ç»Ÿè°ƒç”¨å·ï¼Œå¦‚<code>syscall.h</code>ã€<code>syscall.c</code>æ–‡ä»¶ä¸­ï¼š</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SYS_trace  22</span><br><br>[SYS_mkdir]   sys_mkdir,<br>[SYS_close]   sys_close,<br>[SYS_trace]   sys_trace,<br></code></pre></td></tr></table></figure><ol start="3"><li>åœ¨å†…æ ¸ç³»ç»Ÿè°ƒç”¨å‡ºå£æ‹¦æˆªç³»ç»Ÿè°ƒç”¨åç§°ä»¥åŠè¿”å›å€¼ï¼Œéœ€è¦ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„å°†ç³»ç»Ÿè°ƒç”¨å·è½¬ä¸ºç³»ç»Ÿè°ƒç”¨åç§°ï¼š</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *syscall_name[] = &#123;<br>        <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;fork&quot;</span>, <span class="hljs-string">&quot;exit&quot;</span>, <span class="hljs-string">&quot;wait&quot;</span>, <span class="hljs-string">&quot;pipe&quot;</span>, <span class="hljs-string">&quot;read&quot;</span>, <span class="hljs-string">&quot;kill&quot;</span>, <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-string">&quot;fstat&quot;</span>, <span class="hljs-string">&quot;chdir&quot;</span>, <span class="hljs-string">&quot;dup&quot;</span>,<br>        <span class="hljs-string">&quot;getpid&quot;</span>, <span class="hljs-string">&quot;sbrk&quot;</span>, <span class="hljs-string">&quot;sleep&quot;</span>, <span class="hljs-string">&quot;uptime&quot;</span>, <span class="hljs-string">&quot;open&quot;</span>, <span class="hljs-string">&quot;write&quot;</span>, <span class="hljs-string">&quot;mknod&quot;</span>, <span class="hljs-string">&quot;unlink&quot;</span>, <span class="hljs-string">&quot;link&quot;</span>, <span class="hljs-string">&quot;mkdir&quot;</span>,<br>        <span class="hljs-string">&quot;close&quot;</span>, <span class="hljs-string">&quot;trace&quot;</span><br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">syscall</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> num;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br><br>  num = p-&gt;trapframe-&gt;a7;<br>  <span class="hljs-keyword">if</span>(num &gt; <span class="hljs-number">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;<br>    p-&gt;trapframe-&gt;a0 = syscalls[num]();<br><br>    <span class="hljs-keyword">if</span> (p-&gt;trace_mask &amp; (<span class="hljs-number">1</span> &lt;&lt; num)) &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d: syscall %s -&gt; %d\n&quot;</span>, p-&gt;pid, syscall_name[num], p-&gt;trapframe-&gt;a0);<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d %s: unknown sys call %d\n&quot;</span>,<br>            p-&gt;pid, p-&gt;name, num);<br>    p-&gt;trapframe-&gt;a0 = <span class="hljs-number">-1</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>åœ¨<code>sysproc.c/sys_trace</code>è®¾ç½®è¿›ç¨‹çš„æ©ç ï¼š</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">uint64</span><br><span class="hljs-function"><span class="hljs-title">sys_trace</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> mask;<br><br>  <span class="hljs-keyword">if</span> (argint(<span class="hljs-number">0</span>, &amp;mask) &lt; <span class="hljs-number">0</span>)<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">pro</span> =</span> myproc();<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;trace pid: %d\n&quot;</span>, pro-&gt;pid);<br>  pro-&gt;trace_mask = mask;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125; <br></code></pre></td></tr></table></figure><ol start="5"><li>è¿›ç¨‹æ¸…é™¤æ—¶ä¹Ÿåº”æ¸…é™¤ç›¸åº”æ©ç  <code>proc.c/freeproc</code>ï¼š</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">p-&gt;chan = <span class="hljs-number">0</span>;<br>p-&gt;killed = <span class="hljs-number">0</span>;<br>p-&gt;xstate = <span class="hljs-number">0</span>;<br>p-&gt;state = UNUSED;<br><br><span class="hljs-comment">// trace</span><br>p-&gt;trace_mask = <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><ol start="6"><li>forkæ—¶å­è¿›ç¨‹ä¹Ÿå¤åˆ¶åˆ°è¯¥æ©ç  <code>proc.c/fork</code>ï¼š</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">pid = np-&gt;pid;<br><br>np-&gt;state = RUNNABLE;<br><br><span class="hljs-comment">// trace</span><br>np-&gt;trace_mask = p-&gt;trace_mask;<br><br>release(&amp;np-&gt;lock)<br></code></pre></td></tr></table></figure><h5 id="è¿è¡Œç»“æœ"><a href="#è¿è¡Œç»“æœ" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h5><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210322140342.png" alt="image-20210322140342934"></p><h4 id="Sysinfo-moderate"><a href="#Sysinfo-moderate" class="headerlink" title="Sysinfo (moderate)"></a>Sysinfo (moderate)</h4><h5 id="ä»»åŠ¡-1"><a href="#ä»»åŠ¡-1" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>å®ç°sysinfoç³»ç»Ÿè°ƒç”¨ç”¨äºè·å–å½“å‰çš„ç©ºé—²å†…å­˜å­—èŠ‚æ•°ä»¥åŠçŠ¶æ€ä¸º<code>UNUSED</code>çš„è¿›ç¨‹æ•°</p><h5 id="è¿‡ç¨‹-1"><a href="#è¿‡ç¨‹-1" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><ol><li>è·å–ç©ºé—²å†…å­˜å­—èŠ‚æ•°</li></ol><p>å†…å­˜ä»¥é¡µä¸ºå•ä½è¿›è¡Œåˆ†é…å’Œé‡Šæ”¾ï¼Œæ¯ä¸ªç©ºé—²å†…å­˜å°†å…¶ä½œä¸º<code>struct run</code>ç»“æ„ä½“ï¼Œæœ€ä½çš„ä»¥<code>struct run</code>ç»“æ„ä½“æŒ‡é’ˆå¤§å°çš„å­—èŠ‚ä¸ºnextåŸŸï¼ŒæŒ‡å‘ä¸‹ä¸€ç©ºé—²å†…å­˜é¡µçš„åœ°å€</p><p>å®ç°æ—¶éå†ç©ºé—²é¡µåˆ—è¡¨å³å¯ï¼Œå½“runæŒ‡é’ˆä¸ºNULLæ—¶åœæ­¢</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Get the number of bytes of free memory</span><br><span class="hljs-function">uint64</span><br><span class="hljs-function"><span class="hljs-title">get_free_memory</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">run</span> *<span class="hljs-title">r</span>;</span><br>  uint64 pages = <span class="hljs-number">0</span>;<br><br>  acquire(&amp;kmem.lock);<br>  r = kmem.freelist;<br>  <span class="hljs-keyword">while</span> (r) &#123;<br>    pages++;<br>    r = r-&gt;next;   <br>  &#125;<br>  release(&amp;kmem.lock);<br><br>  <span class="hljs-keyword">return</span> pages * PGSIZE;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>è·å–UNUSEDè¿›ç¨‹æ•°ç›®</li></ol><p>éå†æ‰€æœ‰çš„procç»“æ„ï¼Œç»Ÿè®¡<code>UNUSED</code>çŠ¶æ€çš„æ•°ç›®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Get the num of proccesses</span><br><span class="hljs-function">uint64</span><br><span class="hljs-function"><span class="hljs-title">get_proccesses_num</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span>;</span><br>  uint64 num = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">for</span>(p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;<br>    <span class="hljs-keyword">if</span>(p-&gt;state != UNUSED) <br>      num++;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> num;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>å®ç°sysinfoç³»ç»Ÿè°ƒç”¨</li></ol><p>å‚è€ƒ<code>sys_fstat</code>ç­‰å‡½æ•°å‚æ•°çš„ä¼ é€’ä»¥åŠæŒ‡é’ˆç±»å‹æ•°æ®å¤åˆ¶çš„æ–¹å¼ï¼Œå°†å†…æ ¸çš„æ•°æ®å¤åˆ¶åˆ°å‚æ•°æŒ‡é’ˆæ‰€æŒ‡å‘çš„è¯¥è¿›ç¨‹ç”¨æˆ·æ€å†…å­˜åŒºåŸŸï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">uint64</span><br><span class="hljs-function"><span class="hljs-title">sys_sysinfo</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  uint64 param;<br>  <span class="hljs-keyword">if</span>(argaddr(<span class="hljs-number">0</span>, &amp;param) &lt; <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  <br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sysinfo</span> <span class="hljs-title">info</span>;</span><br>  info.freemem = get_free_memory();<br>  info.nproc = get_proccesses_num();<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br>  <span class="hljs-keyword">if</span> (copyout(p-&gt;pagetable, param, (<span class="hljs-keyword">char</span> *)&amp;info, <span class="hljs-keyword">sizeof</span>(info)) &lt; <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å®éªŒæµ‹è¯•"><a href="#å®éªŒæµ‹è¯•" class="headerlink" title="å®éªŒæµ‹è¯•"></a>å®éªŒæµ‹è¯•</h4><p>å½“åœ¨win10ä¸Šä½¿ç”¨<code>git clone</code>å¹¶å®Œæˆå®éªŒåï¼Œä½¿ç”¨ubuntuè™šæ‹Ÿæœºè¿è¡Œæµ‹è¯•ï¼Œè¯»å–READMEæ–‡ä»¶æ—¶å’Œè¦æ±‚çš„ä¸ä¸€è‡´ï¼Œè‹¥åœ¨ubuntuä¸Š<code>git clone</code>ï¼Œåˆ™å¯ä»¥é€šè¿‡æµ‹è¯•ï¼Œæ¨æµ‹æ˜¯ä¸åŒosæ¢è¡Œçš„ç¬¦å·ä¸åŒï¼Œgitè¿›è¡Œäº†è½¬æ¢ï¼Œä¸‹å›¾ä¸ºåœ¨ubuntuä¸Š<code>git clone</code>å¹¶å¤åˆ¶READMEæ–‡ä»¶åˆ°é¡¹ç›®åçš„è¿è¡Œç»“æœ</p><p>æ­¤å¤–æ¯ä¸ªæµ‹è¯•pythonè„šæœ¬ç¬¬ä¸€è¡Œ<code>#!/usr/bin/env python</code>æ¢è¡Œç¬¦åœ¨winä¸‹ä¹Ÿåº”åˆ‡æ¢ä¸ºLFæ ¼å¼ï¼ˆåŸæœ¬ä¸ºCRLFï¼‰æ‰å¯åœ¨ubuntuè™šæ‹Ÿæœºä¸Šæ­£å¸¸æµ‹è¯•</p><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210322142413.png" alt="image-20210322142413089"></p><h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><p><a href="https://github.com/whileskies/xv6-labs-2020/tree/syscall">https://github.com/whileskies/xv6-labs-2020/tree/syscall</a></p>]]></content>
    
    
    <categories>
      
      <category>OS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6.S081-Lab1: Xv6 and Unix utilities</title>
    <link href="/2021/07/11/6-S081-Lab1-Xv6-and-Unix-utilities/"/>
    <url>/2021/07/11/6-S081-Lab1-Xv6-and-Unix-utilities/</url>
    
    <content type="html"><![CDATA[<h2 id="Lab1-Xv6-and-Unix-utilities"><a href="#Lab1-Xv6-and-Unix-utilities" class="headerlink" title="Lab1: Xv6 and Unix utilities"></a>Lab1: Xv6 and Unix utilities</h2><p>Lab1ä¸»è¦æ˜¯äº†è§£å¹¶è¿è¡ŒRiscVç‰ˆæœ¬çš„XV6ï¼Œå¹¶ä¸ºå…¶æ·»åŠ ä¸€äº›ç”¨æˆ·æ€ç¨‹åº</p><h4 id="Boot-xv6-easy"><a href="#Boot-xv6-easy" class="headerlink" title="Boot xv6 (easy)"></a>Boot xv6 (easy)</h4><p>ä½¿ç”¨<code>make qemu</code>è¿è¡Œxv6ï¼Œå¹¶è¿è¡Œ<code>ls</code>ç­‰ç¨‹åº</p><h4 id="sleep-easy"><a href="#sleep-easy" class="headerlink" title="sleep (easy)"></a>sleep (easy)</h4><h5 id="ä»»åŠ¡"><a href="#ä»»åŠ¡" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>è°ƒç”¨å†…æ ¸sleepç³»ç»Ÿè°ƒç”¨å®ŒæˆåŠŸèƒ½</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;kernel/types.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;user.h&quot;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span> </span>&#123;<br>  <span class="hljs-keyword">int</span> time;<br><br>  <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>) &#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;Usage: sleep time\n\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  time = atoi(argv[<span class="hljs-number">1</span>]);<br>  sleep(time);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨Makefileçš„<code>UPROGS</code>ä¸­æ·»åŠ <code>$U/_sleep\</code> </p><h4 id="pingpong-easy"><a href="#pingpong-easy" class="headerlink" title="pingpong (easy)"></a>pingpong (easy)</h4><h5 id="ä»»åŠ¡-1"><a href="#ä»»åŠ¡-1" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>åˆ›å»ºä¸€å¯¹çˆ¶å­è¿›ç¨‹ï¼Œè¯¥å¯¹è¿›ç¨‹ä½¿ç”¨ç®¡é“é€šä¿¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;kernel/types.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;kernel/stat.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;user/user.h&quot;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">int</span> p2c[<span class="hljs-number">2</span>], c2p[<span class="hljs-number">2</span>];<br>  <span class="hljs-keyword">int</span> child_id;<br>  <span class="hljs-keyword">char</span> *ping = <span class="hljs-string">&quot;ping&quot;</span>;<br>  <span class="hljs-keyword">char</span> *pong = <span class="hljs-string">&quot;pong&quot;</span>;<br>  <span class="hljs-keyword">char</span> buf[<span class="hljs-number">512</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br><br>  pipe(p2c);<br>  pipe(c2p);<br><br>  child_id = fork();<br>  <span class="hljs-keyword">if</span> (child_id != <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">//parent</span><br>    close(p2c[<span class="hljs-number">0</span>]);<br>    close(c2p[<span class="hljs-number">1</span>]);<br><br>    write(p2c[<span class="hljs-number">1</span>], ping, <span class="hljs-built_in">strlen</span>(ping));<br><br>    <span class="hljs-comment">//wait((int *)0);</span><br>    read(c2p[<span class="hljs-number">0</span>], buf, <span class="hljs-keyword">sizeof</span>(buf));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d: received %s\n&quot;</span>, getpid(), buf);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">//child</span><br>    close(p2c[<span class="hljs-number">1</span>]);<br>    close(c2p[<span class="hljs-number">0</span>]);<br><br>    read(p2c[<span class="hljs-number">0</span>], buf, <span class="hljs-keyword">sizeof</span>(buf));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d: received %s\n&quot;</span>, getpid(), buf);<br><br>    write(c2p[<span class="hljs-number">1</span>], pong, <span class="hljs-built_in">strlen</span>(pong));<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="primes-moderate-hard"><a href="#primes-moderate-hard" class="headerlink" title="primes (moderate)/(hard)"></a>primes (moderate)/(hard)</h4><h5 id="ä»»åŠ¡-2"><a href="#ä»»åŠ¡-2" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>ä½¿ç”¨<code>pipe</code>ã€<code>fork</code>ç»„æˆä¸€ç®¡é“è¿‡æ»¤å™¨ï¼Œç¬¬ä¸€ä¸ªè¿›ç¨‹è¾“å‡º2ï¼Œå¹¶è¿‡æ»¤2-35ä¸­2çš„å€æ•°çš„æ•°ï¼Œç¬¬äºŒä¸ªè¿›ç¨‹è¾“å‡º3å¹¶è¿‡æ»¤3çš„å€æ•°çš„æ•°â€¦</p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210321224328.png" alt="image-20210321224322050" style="zoom: 80%;" /><h5 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><p>é¦–å…ˆmainå‡½æ•°åˆå§‹ç®¡é“ï¼Œå°†2-35å†™å…¥ç®¡é“ï¼Œå¹¶å…³é—­å†™ç®¡é“ï¼Œè°ƒç”¨filterå‡½æ•°å¤„ç†ï¼Œfilterå‡½æ•°ç”¨äºé€’å½’å¤„ç†è¯¥é—®é¢˜ï¼Œå‚æ•°ä¸ºä¸Šä¸€å±‚ç®¡é“æ•°ç»„ï¼Œä»ç®¡é“è¯»ç«¯è¯»å…¥ä¸Šä¸€å±‚çš„æ•°å­—ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°ç®¡é“ï¼Œå¯¹æ•°å­—è¿‡æ»¤åä¼ å…¥ä¸‹ä¸€å±‚ï¼Œä¸‹ä¸€å±‚å³ä¸ºé€šè¿‡forkåˆ›å»ºçš„å­è¿›ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;kernel/types.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;kernel/stat.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;user/user.h&quot;</span></span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">filter</span><span class="hljs-params">(<span class="hljs-keyword">int</span> lpipe[])</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> rpipe[<span class="hljs-number">2</span>];<br>  pipe(rpipe);<br><br>  <span class="hljs-keyword">int</span> primes[<span class="hljs-number">50</span>];<br>  <span class="hljs-keyword">int</span> cnt = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">char</span> buf[<span class="hljs-number">1</span>];<br><br>  <span class="hljs-keyword">while</span> ((read(lpipe[<span class="hljs-number">0</span>], buf, <span class="hljs-keyword">sizeof</span>(buf))) != <span class="hljs-number">0</span>) &#123;<br>    primes[cnt++] = buf[<span class="hljs-number">0</span>];<br>  &#125;<br>  close(lpipe[<span class="hljs-number">0</span>]);<br><br>  <span class="hljs-keyword">if</span> (cnt == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<br>  <span class="hljs-keyword">int</span> first = primes[<span class="hljs-number">0</span>];<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;prime %d\n&quot;</span>, first);<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; cnt; i++) &#123;<br>    <span class="hljs-keyword">if</span> (primes[i] % first != <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">char</span> p = primes[i];<br>      write(rpipe[<span class="hljs-number">1</span>], &amp;p, <span class="hljs-number">1</span>);<br>    &#125;<br>  &#125;<br>  close(rpipe[<span class="hljs-number">1</span>]);<br><br>  <span class="hljs-keyword">int</span> pid = fork();<br>  <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">//child</span><br>    filter(rpipe);<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> lpipe[<span class="hljs-number">2</span>];<br><br>  pipe(lpipe);<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">2</span>; i &lt;= <span class="hljs-number">35</span>; i++) &#123;<br>    <span class="hljs-keyword">char</span> p = i;<br>    write(lpipe[<span class="hljs-number">1</span>], &amp;p, <span class="hljs-number">1</span>);<br>  &#125;<br>  close(lpipe[<span class="hljs-number">1</span>]);<br><br>  filter(lpipe);<br><br>  wait((<span class="hljs-keyword">int</span> *) <span class="hljs-number">0</span>);<br><br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="è¿è¡Œç»“æœ"><a href="#è¿è¡Œç»“æœ" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h5><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210321225353.png" alt="image-20210321225351704"></p><h4 id="find-moderate"><a href="#find-moderate" class="headerlink" title="find (moderate)"></a>find (moderate)</h4><h5 id="ä»»åŠ¡-3"><a href="#ä»»åŠ¡-3" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>åœ¨ä¸€ä¸ªç›®å½•æ ‘ä¸­æœç´¢ç‰¹å®šåç§°çš„æ‰€æœ‰æ–‡ä»¶</p><h5 id="è¿‡ç¨‹-1"><a href="#è¿‡ç¨‹-1" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><p>é€’å½’æœç´¢ç›®å½•ä¸­çš„æŒ‡å®šæ–‡ä»¶å³å¯ï¼Œå¢åŠ äº†<code>.</code>ã€<code>*</code>çš„é€šé…ç¬¦åŠŸèƒ½ï¼Œæ­£åˆ™åŒ¹é…ä»£ç å‚è€ƒè‡ª<a href="https://leetcode-cn.com/problems/wildcard-matching/">LeetCode 44é¢˜</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;kernel/types.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;kernel/stat.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;user/user.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;kernel/fs.h&quot;</span></span><br><br><span class="hljs-comment">// int</span><br><span class="hljs-comment">// match(char *filename, char *name) &#123;</span><br><span class="hljs-comment">//   return strcmp(filename, name) == 0;</span><br><span class="hljs-comment">// &#125;</span><br><br><span class="hljs-comment">// &#x27;.&#x27; Matches any single character.â€‹â€‹â€‹â€‹</span><br><span class="hljs-comment">// &#x27;*&#x27; Matches zero or more of the preceding element.</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">match</span><span class="hljs-params">(<span class="hljs-keyword">char</span>* s, <span class="hljs-keyword">char</span>* p)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (!*p) <span class="hljs-keyword">return</span> !*s;<br>  <span class="hljs-keyword">if</span> (*(p + <span class="hljs-number">1</span>) != <span class="hljs-string">&#x27;*&#x27;</span>) <br>    <span class="hljs-keyword">return</span> *s == *p || (*p == <span class="hljs-string">&#x27;.&#x27;</span> &amp;&amp; *s != <span class="hljs-string">&#x27;\0&#x27;</span>) ? match(s + <span class="hljs-number">1</span>, p + <span class="hljs-number">1</span>) : <span class="hljs-number">0</span>; <br>  <span class="hljs-keyword">else</span> <br>    <span class="hljs-keyword">return</span> *s == *p || (*p == <span class="hljs-string">&#x27;.&#x27;</span> &amp;&amp; *s != <span class="hljs-string">&#x27;\0&#x27;</span>) ? match(s, p + <span class="hljs-number">2</span>) || match(s + <span class="hljs-number">1</span>, p) : match(s, p + <span class="hljs-number">2</span>);<br>    <span class="hljs-comment">//return (*s == *p || (*p == &#x27;.&#x27; &amp;&amp; *s != &#x27;\0&#x27;)) &amp;&amp; match(s + 1, p) || match(s, p + 2);</span><br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">catdir</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *predix, <span class="hljs-keyword">char</span> *name, <span class="hljs-keyword">char</span> *buf)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-built_in">memcpy</span>(buf, predix, <span class="hljs-built_in">strlen</span>(predix));<br>  <span class="hljs-keyword">char</span> *p = buf + <span class="hljs-built_in">strlen</span>(predix);<br>  *p++ = <span class="hljs-string">&#x27;/&#x27;</span>;<br>  <span class="hljs-built_in">memcpy</span>(p, name, <span class="hljs-built_in">strlen</span>(name));<br>  p += <span class="hljs-built_in">strlen</span>(name);<br>  *p++ = <span class="hljs-number">0</span>;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">find</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">char</span> *dir, <span class="hljs-keyword">char</span> *name)</span> </span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirent</span> <span class="hljs-title">de</span>;</span><br>  <br>  <span class="hljs-keyword">while</span>(read(fd, &amp;de, <span class="hljs-keyword">sizeof</span>(de)) == <span class="hljs-keyword">sizeof</span>(de)) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(de.name, <span class="hljs-string">&quot;.&quot;</span>) == <span class="hljs-number">0</span> || <span class="hljs-built_in">strcmp</span>(de.name, <span class="hljs-string">&quot;..&quot;</span>) == <span class="hljs-number">0</span>)<br>      <span class="hljs-keyword">continue</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br>    <span class="hljs-keyword">char</span> path[<span class="hljs-number">512</span>];<br>    catdir(dir, de.name, path);<br>  <br>    <span class="hljs-keyword">if</span>(de.inum == <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">continue</span>;<br>    <span class="hljs-keyword">if</span>(stat(path, &amp;st) &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;find: cannot stat %s\n&quot;</span>, path);<br>        <span class="hljs-keyword">continue</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (st.type == T_FILE &amp;&amp; match(de.name, name)) &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, path);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (st.type == T_DIR) &#123;<br>      <span class="hljs-keyword">int</span> subfd;<br>      <span class="hljs-keyword">if</span>((subfd = open(path, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;find: cannot open %s\n&quot;</span>, path);<br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br>      find(subfd, path, name);<br>    &#125;<br><br>  &#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">3</span>) &#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;Usage: find dir name\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">char</span> dir[DIRSIZ + <span class="hljs-number">1</span>];<br>  <span class="hljs-keyword">char</span> name[DIRSIZ + <span class="hljs-number">1</span>];<br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">1</span>]) &gt; DIRSIZ || <span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">2</span>]) &gt; DIRSIZ) &#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;dir or name too long...\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-built_in">memcpy</span>(dir, argv[<span class="hljs-number">1</span>], <span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">1</span>]));<br>  <span class="hljs-built_in">memcpy</span>(name, argv[<span class="hljs-number">2</span>], <span class="hljs-built_in">strlen</span>(argv[<span class="hljs-number">2</span>]));<br><br>  <span class="hljs-keyword">int</span> fd;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br><br>  <span class="hljs-keyword">if</span>((fd = open(dir, <span class="hljs-number">0</span>)) &lt; <span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;find: cannot open %s\n&quot;</span>, dir);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(fstat(fd, &amp;st) &lt; <span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;find: cannot stat %s\n&quot;</span>, dir);<br>    close(fd);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (st.type != T_DIR) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s is not a dir\n&quot;</span>, dir);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    find(fd, dir, name);<br>  &#125;<br>  <br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="è¿è¡Œç»“æœ-1"><a href="#è¿è¡Œç»“æœ-1" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h5><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210322091153.png" alt="image-20210322091152189"></p><h4 id="xargs-moderate"><a href="#xargs-moderate" class="headerlink" title="xargs (moderate)"></a>xargs (moderate)</h4><h5 id="ä»»åŠ¡-4"><a href="#ä»»åŠ¡-4" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>ç¼–å†™ä¸€ç®€å•ç‰ˆæœ¬çš„UNIX xargsç¨‹åºï¼Œè¯¥ç¨‹åºä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–å¤šè¡Œå¹¶å°†æ¯ä¸€è¡Œä½œä¸ºä¸€æŒ‡å®šç¨‹åºçš„å‚æ•°</p><h5 id="è¿‡ç¨‹-2"><a href="#è¿‡ç¨‹-2" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h5><p>xargsä»æ ‡å‡†è¾“å…¥ä¸­è¯»å¤šè¡Œï¼Œå¤šè¡ŒæŒ‰ç…§<code>\n</code>åˆ†éš”ï¼Œä½¿ç”¨<code>exec</code>ç³»ç»Ÿè°ƒç”¨åˆ›å»ºå­è¿›ç¨‹æ‰§è¡ŒæŒ‡å®šç¨‹åºï¼Œå¹¶å°†æ ‡å‡†è¾“å…¥è¯»çš„å‚æ•°å’Œè¯¥ç¨‹åºåŸæœ¬çš„å‚æ•°ä¸€å¹¶ä½œä¸ºè¯¥ç¨‹åºå‚æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;kernel/types.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;user/user.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;kernel/fcntl.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;kernel/param.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX_ARG_LEN 512</span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">copy_argv</span><span class="hljs-params">(<span class="hljs-keyword">char</span> **ori_argv, <span class="hljs-keyword">int</span> ori_argc, <span class="hljs-keyword">char</span> *new_argv, <span class="hljs-keyword">char</span> **argv)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> k = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; ori_argc; i++) &#123;<br>    argv[k] = <span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">strlen</span>(ori_argv[i]) + <span class="hljs-number">1</span>);<br>    <span class="hljs-built_in">memcpy</span>(argv[k++], ori_argv[i], <span class="hljs-built_in">strlen</span>(ori_argv[i]) + <span class="hljs-number">1</span>);<br>  &#125;<br>  argv[k] = <span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">strlen</span>(new_argv) + <span class="hljs-number">1</span>);<br>  <span class="hljs-built_in">memcpy</span>(argv[k++], new_argv, <span class="hljs-built_in">strlen</span>(new_argv) + <span class="hljs-number">1</span>);<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-keyword">char</span> **s, <span class="hljs-keyword">int</span> n)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, s[i]);<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> </span><br><span class="hljs-function"><span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">if</span> (argc &lt;= <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;Usage: xargx command [arg ...]\n&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">char</span> param[MAX_ARG_LEN];<br>  <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">char</span> ch;<br>  <span class="hljs-keyword">int</span> ignore = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span> (read(<span class="hljs-number">0</span>, &amp;ch, <span class="hljs-number">1</span>) &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">&#x27;\n&#x27;</span>) &#123;<br>      <span class="hljs-keyword">if</span> (ignore) &#123;<br>        i = <span class="hljs-number">0</span>;<br>        ignore = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br>      param[i] = <span class="hljs-number">0</span>;<br>      i = <span class="hljs-number">0</span>;<br><br>      <span class="hljs-keyword">int</span> pid = fork();<br>      <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">//child</span><br>        <span class="hljs-keyword">int</span> cmd_argc = argc;<br>        <br>        <span class="hljs-keyword">char</span> *cmd_argv[MAXARG];<br><br>        copy_argv(argv + <span class="hljs-number">1</span>, argc - <span class="hljs-number">1</span>, param, cmd_argv);<br>        cmd_argv[cmd_argc] = <span class="hljs-number">0</span>;<br>        <br>        exec(cmd_argv[<span class="hljs-number">0</span>], cmd_argv);<br><br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        wait((<span class="hljs-keyword">int</span> *)<span class="hljs-number">0</span>);<br>      &#125;<br>      <br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <br>      <span class="hljs-keyword">if</span> (!ignore &amp;&amp; i &gt;= MAX_ARG_LEN - <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;xargs: too long arguments...\n&quot;</span>);<br>        ignore = <span class="hljs-number">1</span>;<br>      &#125;<br><br>      <span class="hljs-keyword">if</span> (!ignore) &#123;<br>        param[i++] = ch;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="è¿è¡Œç»“æœ-2"><a href="#è¿è¡Œç»“æœ-2" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h5><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210322092735.png" alt="image-20210322092734417"></p><h4 id="å®éªŒæµ‹è¯•"><a href="#å®éªŒæµ‹è¯•" class="headerlink" title="å®éªŒæµ‹è¯•"></a>å®éªŒæµ‹è¯•</h4><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210322093022.png" alt="image-20210322093022342"></p><h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><p><a href="https://github.com/whileskies/xv6-labs-2020/tree/util">https://github.com/whileskies/xv6-labs-2020/tree/util</a></p>]]></content>
    
    
    <categories>
      
      <category>OS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>

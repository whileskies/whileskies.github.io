<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>lab10-mmap</title>
    <link href="/2021/07/08/lab10-mmap/"/>
    <url>/2021/07/08/lab10-mmap/</url>
    
    <content type="html"><![CDATA[<p>Lab10éœ€è¦ä¸ºxv6å®ç°ç®€æ˜“ç‰ˆçš„mmapå’Œmunmapç³»ç»Ÿè°ƒç”¨ï¼Œmmapå…è®¸å¯¹è¿›ç¨‹çš„åœ°å€ç©ºé—´è¿›è¡Œè¯¦ç»†æ§åˆ¶ï¼Œå¯ä»¥ç”¨æ¥è¿›ç¨‹é—´å…±äº«å†…å­˜ã€å°†æ–‡ä»¶æ˜ å°„åˆ°åœ°å€ç©ºé—´ç­‰ï¼Œæœ¬labä»…ä»…å®ç°å†…å­˜æ˜ å°„æ–‡ä»¶ã€‚</p><h4 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h4><h5 id="ä»»åŠ¡"><a href="#ä»»åŠ¡" class="headerlink" title="ä»»åŠ¡"></a>ä»»åŠ¡</h5><p>mmapçš„æ¥å£æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">mmap</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *addr, <span class="hljs-keyword">size_t</span> length, <span class="hljs-keyword">int</span> prot, <span class="hljs-keyword">int</span> flags, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">off_t</span> offset)</span></span><br></code></pre></td></tr></table></figure><p>åœ¨æœ¬labä¸­å‡è®¾addræ€»æ˜¯0ï¼Œç”±å†…æ ¸å†³å®šæ‰€æ˜ å°„æ–‡ä»¶çš„è™šæ‹Ÿåœ°å€ï¼Œå½“è¿”å›0xffffffffffffffff ä»£è¡¨å¤±è´¥ï¼›lengthæ˜¯æ˜ å°„çš„å­—èŠ‚æ•°ï¼Œå¯èƒ½å’Œæ–‡ä»¶å¤§å°ä¸ä¸€è‡´ï¼›protè¡¨ç¤ºè¢«æ˜ å°„çš„å†…å­˜æ˜¯å¦å¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œï¼Œå¯ä»¥å‡è®¾protæ˜¯å¯è¯»ã€å¯å†™æˆ–å¯è¯»å¯å†™çš„ï¼›flagsè¦ä¹ˆæ˜¯MAP_SHAREDï¼Œè¡¨ç¤ºå¯¹äºæ‰€æ˜ å°„å†…å­˜çš„ä¿®æ”¹åº”è¯¥å†™å›æ–‡ä»¶ï¼Œè¦ä¹ˆæ˜¯MAP_PRIVATEï¼Œè¡¨ç¤ºä¸ä¼šå†™å›æ–‡ä»¶ï¼Œä¸ç”¨è€ƒè™‘å…¶ä»–çš„bitsï¼›fdæ˜¯è¢«æ˜ å°„æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼›offsetæ˜¯æ–‡ä»¶çš„åç§»ï¼Œå¯ä»¥å‡å®šæ€»ä¸º0ï¼ˆæ˜ å°„æ–‡ä»¶æ—¶æ€»æ˜¯ä»æ–‡ä»¶å¼€å§‹æ˜ å°„ï¼‰ã€‚</p><p>å¦‚æœå¤šä¸ªè¿›ç¨‹æ˜ å°„åŒä¸€MAP_SHAREDæ–‡ä»¶ï¼Œå¯ä»¥ä¸ç”¨å®ç°å…±äº«åŒä¸€ç‰©ç†é¡µã€‚</p><p>munmapçš„æ¥å£æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">munmap</span><span class="hljs-params">(uint64 addr, <span class="hljs-keyword">int</span> length)</span></span><br></code></pre></td></tr></table></figure><p>munmapåº”è¯¥ç§»é™¤åœ¨å‚æ•°æŒ‡å®šèŒƒå›´çš„mmapæ˜ å°„ï¼Œå¦‚æœè¿›ç¨‹ä¿®æ”¹äº†æ˜ å°„çš„å†…å­˜ï¼Œå¹¶ä¸”æ˜¯MAP_SHAREDçš„ï¼Œä¿®æ”¹åº”è¯¥é¦–å…ˆå†™å›æ–‡ä»¶ï¼›å¯ä»¥å‡å®šmunmapå–æ¶ˆæ˜ å°„çš„èŒƒå›´è¦ä¹ˆèµ·å§‹äºæ˜ å°„åŒºåŸŸçš„å¼€å§‹ï¼Œè¦ä¹ˆç»“æŸä¸æ˜ å°„åŒºåŸŸçš„ç»“å°¾ï¼Œè¦ä¹ˆæ•´ä¸ªåŒºåŸŸï¼Œä¹Ÿå³ä¸ä¼šæ˜¯æ•´ä¸ªæ˜ å°„åŒºåŸŸä¸­æ‰“ä¸€ä¸ªå­”ï¼Œå°†å‰©ä½™çš„æ˜ å°„åŒºåŸŸåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ã€‚</p><h5 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h5><ol><li>å®šä¹‰VMA</li></ol><p>ä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¤šæ¬¡è°ƒç”¨mmapæ˜ å°„å¤šä¸ªæ–‡ä»¶ï¼Œå› æ­¤è¿›ç¨‹åº”è®°å½•æ¯ä¸€æ¬¡æ‰€æ˜ å°„çš„è™šæ‹Ÿåœ°å€åŒºåŸŸï¼Œå®šä¹‰vmaä»£è¡¨è¿›ç¨‹è™šæ‹Ÿåœ°å€æ˜ å°„çš„ä¸€ä¸ªåŒºåŸŸï¼Œå­—æ®µåŒ…æ‹¬æ˜¯å¦è¢«ä½¿ç”¨ã€åŒºåŸŸçš„èµ·å§‹åœ°å€ã€ç»“æŸåœ°å€ã€æ–‡ä»¶æè¿°ç¬¦ã€æƒé™ç­‰ã€‚</p><p>æ¯ä¸ªè¿›ç¨‹åŒ…å«å¤šä¸ªVMAï¼Œæœ€å¤§ä¸º16ä¸ªï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// param.h</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NVMA         16    <span class="hljs-comment">// maximum number of vma</span></span><br><br><span class="hljs-comment">// proc.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> &#123;</span><br>  <span class="hljs-keyword">int</span> used;<br>  uint64 addr;<br>  <span class="hljs-keyword">int</span> length;<br>  <span class="hljs-keyword">int</span> permissions;<br>  <span class="hljs-keyword">int</span> flags;<br>  <span class="hljs-keyword">int</span> offset;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">f</span>;</span><br>  uint64 start;<br>  uint64 end;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> &#123;</span><br>  <span class="hljs-comment">// çœç•¥</span><br>  <span class="hljs-keyword">char</span> name[<span class="hljs-number">16</span>];               <span class="hljs-comment">// Process name (debugging)</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> <span class="hljs-title">vmas</span>[<span class="hljs-title">NVMA</span>];</span>       <span class="hljs-comment">// Virtual Memory Area</span><br>&#125;;<br></code></pre></td></tr></table></figure><ol start="2"><li>å®ç°mmap</li></ol><p><code>mmap()</code>å®ç°ä¸ºä¸€ç³»ç»Ÿè°ƒç”¨ï¼Œé¦–å…ˆè¯»å–ç³»ç»Ÿè°ƒç”¨å‚æ•°ï¼Œå¦‚æœè¯¥mmapæ˜¯MAP_SHAREDçš„ï¼Œä½†æ˜¯æ˜ å°„å†…å­˜æ ‡å¿—ä¸ºä¸å¯å†™çš„ï¼Œåˆ™è¿”å›é”™è¯¯ã€‚</p><p>ä»VMAæ•°ç»„ä¸­å¯»æ‰¾ä¸€æœªä½¿ç”¨çš„VMAï¼Œä¹‹åç¡®å®šæ˜ å°„çš„èµ·å§‹åœ°å€ï¼Œèµ·å§‹åœ°å€ä¸ºå·²ä½¿ç”¨çš„VMAä¸­æœ€å¤§ç»“æŸåœ°å€ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸ºVMA_BASEï¼ˆ4GBå¼€å§‹ï¼‰ï¼Œä¹‹åè®¾ç½®VMAå³å¯ï¼Œè¿™é‡Œæ˜ å°„çš„åŒºåŸŸåœ°å€èŒƒå›´ä¸º[start, end)ï¼Œå·¦é—­å³å¼€ã€‚</p><p>ç”±äºmmapè°ƒç”¨ä½¿ç”¨äº†æ–‡ä»¶ï¼Œå› æ­¤åº”è¯¥ä¸ºè¯¥æ–‡ä»¶çš„å¼•ç”¨è®¡æ•°+1ï¼Œé˜²æ­¢è¯¥æ–‡ä»¶å˜é‡è¢«å›æ”¶ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// sysfile.c</span><br><span class="hljs-function">uint64</span><br><span class="hljs-function"><span class="hljs-title">sys_mmap</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">int</span> i;<br>  uint64 addr;<br>  <span class="hljs-keyword">int</span> prot, flags, length, offset;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">f</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> *<span class="hljs-title">a</span> =</span> <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">if</span>(argaddr(<span class="hljs-number">0</span>, &amp;addr) || argint(<span class="hljs-number">1</span>, &amp;length) || argint(<span class="hljs-number">2</span>, &amp;prot) ||<br>    argint(<span class="hljs-number">3</span>, &amp;flags) || argfd(<span class="hljs-number">4</span>, <span class="hljs-number">0</span>, &amp;f) &lt; <span class="hljs-number">0</span> || argint(<span class="hljs-number">5</span>, &amp;offset) &lt; <span class="hljs-number">0</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  <br>  <span class="hljs-keyword">if</span>((flags &amp; MAP_SHARED) &amp;&amp; !f-&gt;writable &amp;&amp; (prot &amp; PROT_WRITE))<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; NVMA; i++)&#123;<br>    <span class="hljs-keyword">if</span>(!p-&gt;vmas[i].used)&#123;<br>      a = &amp;p-&gt;vmas[i];<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(a == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  uint64 maxend = VMA_BASE;<br>  <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; NVMA; i++)&#123;<br>    <span class="hljs-keyword">if</span>(p-&gt;vmas[i].used &amp;&amp; p-&gt;vmas[i].end &gt; maxend)<br>      maxend = p-&gt;vmas[i].end;<br>  &#125;<br>  <br>  a-&gt;used = <span class="hljs-number">1</span>;<br>  a-&gt;start = maxend;<br>  a-&gt;end = PGROUNDUP(a-&gt;start + length);<br>  a-&gt;addr = a-&gt;start;<br>  a-&gt;length = a-&gt;end - a-&gt;start;<br>  a-&gt;f = f;<br>  a-&gt;offset = offset;<br>  a-&gt;permissions = prot;<br>  a-&gt;flags = flags;<br><br>  filedup(f);<br><br>  <span class="hljs-keyword">return</span> a-&gt;start;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>å®ç°mmapç¼ºé¡µä¸­æ–­å¤„ç†</li></ol><p>ä¸Šé¢çš„mmapç³»ç»Ÿè°ƒç”¨åªæ˜¯ä¸ºè¿›ç¨‹æ ‡è®°äº†æ˜ å°„åŒºåŸŸï¼Œå®é™…ä¸Šå¹¶æœªæ˜ å°„ç‰©ç†å†…å­˜ï¼Œè¿™é‡Œä»ç„¶æ˜¯lazyåˆ†é…çš„æ€æƒ³ï¼Œç­‰åˆ°è¿›ç¨‹å®é™…è®¿é—®æ˜ å°„åŒºåŸŸæ—¶ï¼Œäº§ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œå†ä¸ºæ‰€ç¼ºçš„è™šæ‹Ÿé¡µåˆ†é…ç‰©ç†å†…å­˜ï¼Œé€šè¿‡é¡µè¡¨å»ºç«‹æ˜ å°„ï¼Œå¹¶è¯»å–æ–‡ä»¶åˆ°ç‰©ç†å†…å­˜ï¼Œä¸­æ–­è¿”å›åè¿›ç¨‹å†æ¬¡è®¿é—®è¯¥åœ°å€å¯æ­£å¸¸è®¿é—®è¯¥æ–‡ä»¶çš„æ˜ å°„ã€‚</p><p>è¯»å–æ–‡ä»¶æ—¶çš„åç§»åº”ä¸ºè¯¥æ–‡ä»¶åœ¨vmaä¸­èµ·å§‹åç§» + è¯¥é¡µä¸vmaèµ·å§‹é¡µçš„åç§»ã€‚</p><p>ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vm.c</span><br><span class="hljs-comment">// Mmap pages does not exist, page fault will occur.</span><br><span class="hljs-comment">// Alloc a physical page and read the file to it.</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> </span><br><span class="hljs-function"><span class="hljs-title">mmap_pgfault</span><span class="hljs-params">(uint64 stval, struct proc *p)</span></span><br><span class="hljs-function"></span>&#123;<br>  stval = PGROUNDDOWN(stval);<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> *<span class="hljs-title">a</span> =</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// Which vma?</span><br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NVMA; i++)&#123;<br>    <span class="hljs-keyword">if</span>(p-&gt;vmas[i].used &amp;&amp; stval &gt;= p-&gt;vmas[i].start &amp;&amp; stval &lt; p-&gt;vmas[i].end)&#123;<br>      a = &amp;p-&gt;vmas[i];<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(a == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-keyword">char</span> *pa = kalloc();<br>  <span class="hljs-keyword">if</span>(pa == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  <span class="hljs-built_in">memset</span>(pa, <span class="hljs-number">0</span>, PGSIZE);<br><br>  <span class="hljs-keyword">int</span> perm = PTE_U;<br>  <span class="hljs-keyword">if</span>(a-&gt;permissions &amp; PROT_READ)<br>    perm |= PTE_R;<br>  <span class="hljs-keyword">if</span>(a-&gt;permissions &amp; PROT_WRITE)<br>    perm |= PTE_W;<br>  <span class="hljs-keyword">if</span>(mappages(p-&gt;pagetable, PGROUNDDOWN(stval), PGSIZE, (uint64)pa, perm) != <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  <br>  uint64 off = stval - a-&gt;start + a-&gt;offset;<br>  ilock(a-&gt;f-&gt;ip);<br>  <span class="hljs-keyword">if</span>(readi(a-&gt;f-&gt;ip, <span class="hljs-number">0</span>, (uint64)pa, off, PGSIZE) &lt;= <span class="hljs-number">0</span>)&#123;<br>    iunlock(a-&gt;f-&gt;ip);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br>  iunlock(a-&gt;f-&gt;ip);<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// trap.c</span><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (r_scause() == <span class="hljs-number">13</span> || r_scause() == <span class="hljs-number">15</span>) &#123;<br>    uint64 stval = r_stval();<br>    <span class="hljs-keyword">if</span>(mmap_pgfault(stval, p) != <span class="hljs-number">0</span>)&#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;usertrap(): unexpected scause %p pid=%d\n&quot;</span>, r_scause(), p-&gt;pid);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;            sepc=%p stval=%p\n&quot;</span>, r_sepc(), r_stval());<br>      p-&gt;killed = <span class="hljs-number">1</span>;<br>    &#125;<br><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>((which_dev = devintr()) != <span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-comment">// ok</span><br>  &#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>å®ç°munmap</li></ol><p><code>munmap()</code>å–æ¶ˆæ˜ å°„åŒºåŸŸçš„ä¸€éƒ¨åˆ†ï¼Œé¦–å…ˆè¦æ‰¾åˆ°æ‰€å±çš„vmaï¼Œå–æ¶ˆçš„æ˜ å°„åŒºåŸŸåˆ†ä¸ºä¸‰ç§æƒ…å†µï¼šå–æ¶ˆvmaèµ·å§‹åœ°å€çš„ä¸€æ®µæ˜ å°„ã€å–æ¶ˆä»¥vmaç»“æŸåœ°å€ç»“æŸçš„ä¸€æ®µæ˜ å°„ã€å–æ¶ˆæ•´ä¸ªvmaæ˜ å°„ï¼Œæ ¹æ®ä¸‰ç§æƒ…å†µå¾—å‡ºæ‰€å–æ¶ˆæ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€ï¼ˆunstartï¼‰ä¸é•¿åº¦ï¼ˆunlenï¼‰ï¼Œå¹¶æ›´æ–°å–æ¶ˆä¸€æ®µåŒºåŸŸåçš„vmaã€‚</p><p>å–æ¶ˆæ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€éœ€è¦æŒ‰é¡µå¯¹å…¶ï¼Œé•¿åº¦ä¹Ÿéœ€è¦æ˜¯é¡µå¤§å°çš„æ•´æ•°å€ã€‚</p><p>å¦‚æœè¯¥vmaçš„æ ‡å¿—ä¸ºMAP_SHAREDæ—¶ï¼Œåº”è¯¥æŠŠæ‰€å–æ¶ˆçš„åŒºåŸŸçš„ä¿®æ”¹å†™å›åˆ°æ–‡ä»¶ä¸­å»ï¼Œè¿™é‡Œä¸ºäº†ç®€å•ä¸è€ƒè™‘é¡µè¡¨ä¸­çš„dirtyä½ï¼Œç›´æ¥å†™å›æ–‡ä»¶ï¼›å¦‚æœå–æ¶ˆæ˜ å°„çš„é¡µè¿˜æ²¡ç”¨é€šè¿‡<code>mmap_pgfault()</code>æ˜ å°„ç‰©ç†é¡µï¼Œä¹Ÿå°±ä»£è¡¨ç€æ²¡æœ‰è®¿é—®ä¿®æ”¹ï¼Œåˆ™ä¸ç”¨å†™å›ã€‚</p><p>å¦‚æœå–æ¶ˆäº†vmaæ•´æ®µåŒºåŸŸçš„æ˜ å°„ï¼Œä»£è¡¨ç€è¯¥æ–‡ä»¶æ˜ å°„çš„å–æ¶ˆï¼Œåº”è¯¥å‡å°‘è¯¥æ–‡ä»¶çš„å¼•ç”¨è®¡æ•°ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vm.c</span><br><span class="hljs-comment">// Whether the virtual address is mapped.</span><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">vm_exists</span><span class="hljs-params">(<span class="hljs-keyword">pagetable_t</span> pagetable, uint64 va)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">pte_t</span> *pte;<br>  <span class="hljs-keyword">return</span> (pte = walk(pagetable, va, <span class="hljs-number">0</span>)) != <span class="hljs-number">0</span> &amp;&amp; (*pte &amp; PTE_V) != <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">//Find the VMA for the address range and unmap the specified pages.</span><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">munmap</span><span class="hljs-params">(uint64 addr, <span class="hljs-keyword">int</span> length)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc</span> *<span class="hljs-title">p</span> =</span> myproc();<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vma</span> *<span class="hljs-title">a</span> =</span> <span class="hljs-number">0</span>;<br>  addr = PGROUNDDOWN(addr);<br><br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NVMA; i++)&#123;<br>    <span class="hljs-keyword">if</span>(p-&gt;vmas[i].used &amp;&amp; addr &gt;= p-&gt;vmas[i].start &amp;&amp; addr &lt; p-&gt;vmas[i].end)&#123;<br>      a = &amp;p-&gt;vmas[i];<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (a == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  uint64 unstart, unlen;<br>  uint64 start = a-&gt;start, offset = a-&gt;offset, orilen = a-&gt;length;<br><br>  <span class="hljs-keyword">if</span>(addr == a-&gt;start)&#123;<br>    <span class="hljs-comment">// Unmap at the start</span><br>    unstart = addr;<br>    unlen = PGROUNDUP(length) &lt; a-&gt;length ? PGROUNDUP(length) : a-&gt;length;<br><br>    a-&gt;start = unstart + unlen; <br>    a-&gt;length = a-&gt;end - a-&gt;start;<br>    a-&gt;offset = a-&gt;offset + unlen;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(addr + length &gt;= a-&gt;end)&#123;<br>    <span class="hljs-comment">// Unmap at the end</span><br>    unstart = addr;<br>    unlen = a-&gt;end - unstart;<br><br>    a-&gt;end = unstart;<br>    a-&gt;length = a-&gt;end - a-&gt;start;<br>  &#125; <span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-comment">// Unmap the whole region</span><br>    unstart = a-&gt;start;<br>    unlen = a-&gt;end - a-&gt;start;<br>  &#125;<br>  <br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; unlen / PGSIZE; i++)&#123;<br>    uint64 va = unstart + i * PGSIZE;<br>    <span class="hljs-comment">// May not be alloced due to lazy alloc through page fault.</span><br>    <span class="hljs-keyword">if</span>(vm_exists(p-&gt;pagetable, va))&#123;<br>      <span class="hljs-keyword">if</span>(a-&gt;flags &amp; MAP_SHARED)&#123;<br>        munmap_writeback(va, PGSIZE, start, offset, a);<br>      &#125;<br><br>      uvmunmap(p-&gt;pagetable, va, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span>(unlen == orilen)&#123;<br>    fileclose(a-&gt;f);<br>    a-&gt;used = <span class="hljs-number">0</span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// sysfile.c</span><br><span class="hljs-function">uint64</span><br><span class="hljs-function"><span class="hljs-title">sys_munmap</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>  uint64 addr;<br>  <span class="hljs-keyword">int</span> length;<br><br>  <span class="hljs-keyword">if</span>(argaddr(<span class="hljs-number">0</span>, &amp;addr) || argint(<span class="hljs-number">1</span>, &amp;length))<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  <br>  <span class="hljs-keyword">return</span> munmap(addr, length);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="5"><li>å®ç°munmap_writeback</li></ol><p><code>munmap_writeback()</code>ç”¨äºå–æ¶ˆæ˜ å°„æ—¶å°†æ˜ å°„é¡µæ•°æ®å†™å›æ–‡ä»¶ï¼Œå†™å›æ—¶åº”æ³¨æ„å†™æ–‡ä»¶çš„èµ·å§‹åç§»ï¼Œä¸è¯»æ–‡ä»¶ç±»ä¼¼ï¼Œå†™åç§»ä¸ºè¯¥æ–‡ä»¶åœ¨vmaä¸­èµ·å§‹åç§» + è¯¥é¡µä¸vmaèµ·å§‹é¡µçš„åç§»ï¼Œæ­¤å¤–è¯¥æ–‡ä»¶å‰©ä½™å¤§å°ä¸è¶³ä¸€é¡µå¤§å°ï¼Œåº”è¯¥æŒ‰ç…§å®é™…å‰©ä½™å¤§å°æ¥å†™ã€‚</p><p>å†™æ–‡ä»¶æ—¶å’Œ<code>filewrite()</code>ç±»ä¼¼ï¼Œå°†å†™æ“ä½œæ‰“åŒ…ä¸ºå¤šæ¬¡æ—¥å¿—äº‹åŠ¡æ¥å†™ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// vm.c</span><br><span class="hljs-comment">// If an unmapped page has been modified and the file is mapped MAP_SHARED, </span><br><span class="hljs-comment">// write the page back to the file. </span><br><span class="hljs-function"><span class="hljs-keyword">int</span></span><br><span class="hljs-function"><span class="hljs-title">munmap_writeback</span><span class="hljs-params">(uint64 unstart, uint64 unlen, uint64 start, uint64 offset, struct vma *a)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">f</span> =</span> a-&gt;f;<br>  uint off = unstart - start + offset;<br>  uint size;<br><br>  ilock(f-&gt;ip);<br>  size = f-&gt;ip-&gt;size;<br>  iunlock(f-&gt;ip);<br><br>  <span class="hljs-keyword">if</span>(off &gt;= size) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  uint n = unlen &lt; size - off ? unlen : size - off;<br><br>  <span class="hljs-keyword">int</span> r, ret = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">int</span> max = ((MAXOPBLOCKS<span class="hljs-number">-1</span><span class="hljs-number">-1</span><span class="hljs-number">-2</span>) / <span class="hljs-number">2</span>) * BSIZE;<br>  <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span>(i &lt; n)&#123;<br>    <span class="hljs-keyword">int</span> n1 = n - i;<br>    <span class="hljs-keyword">if</span>(n1 &gt; max)<br>      n1 = max;<br><br>    begin_op();<br>    ilock(f-&gt;ip);<br>    r = writei(f-&gt;ip, <span class="hljs-number">1</span>, unstart, off + i, n1);<br>    iunlock(f-&gt;ip);<br>    end_op();<br><br>    <span class="hljs-keyword">if</span>(r != n1)&#123;<br>      <span class="hljs-comment">// error from writei</span><br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    i += r;<br>  &#125;<br>  ret = (i == n ? n : <span class="hljs-number">-1</span>);<br><br>  <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="6"><li>ä¿®æ”¹exit</li></ol><p>è¿›ç¨‹é€€å‡ºæ—¶åº”è¯¥å–æ¶ˆæ‰€æœ‰çš„mmapæ˜ å°„ï¼Œç›´æ¥è°ƒç”¨<code>munmap()</code>å‡½æ•°å–æ¶ˆæ¯ä¸€ä¸ªä½¿ç”¨ä¸­çš„vmaçš„æ˜ å°„å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// proc.c/exit</span><br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NVMA; i++)&#123;<br>    <span class="hljs-keyword">if</span>(p-&gt;vmas[i].used)&#123;<br>      munmap(p-&gt;vmas[i].start, p-&gt;vmas[i].length);<br>      p-&gt;vmas[i].used = <span class="hljs-number">0</span>;<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><ol start="7"><li>ä¿®æ”¹fork</li></ol><p>å½“è°ƒç”¨<code>fork()</code>æ—¶ï¼Œå­è¿›ç¨‹ä¹Ÿéœ€è¦å¤åˆ¶çˆ¶è¿›ç¨‹çš„æ˜ å°„ï¼Œç›´æ¥å¤åˆ¶çˆ¶è¿›ç¨‹çš„vmaå³å¯ï¼Œä¸è¿‡éœ€è¦ä¸ºæ–‡ä»¶çš„å¼•ç”¨è®¡æ•°+1ï¼Œè¿™é‡Œå®ç°æ—¶ä¸è€ƒè™‘çˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹å…±äº«ç›¸åŒçš„ç‰©ç†é¡µï¼Œå¦‚æœå…±äº«çš„è¯ï¼Œå®ç°å’ŒCOW forkç±»ä¼¼ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// proc.c</span><br><span class="hljs-comment">// Copy vmas of parent proc for mmap</span><br><span class="hljs-comment">// Need to increase file reference count</span><br><span class="hljs-function"><span class="hljs-keyword">void</span></span><br><span class="hljs-function"><span class="hljs-title">fork_mmap</span><span class="hljs-params">(struct proc *np, struct proc *p)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; NVMA; i++)&#123;<br>    <span class="hljs-keyword">if</span>(p-&gt;vmas[i].used)&#123;<br>      np-&gt;vmas[i] = p-&gt;vmas[i];<br>      filedup(np-&gt;vmas[i].f);<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// proc.c/fork</span><br>safestrcpy(np-&gt;name, p-&gt;name, <span class="hljs-keyword">sizeof</span>(p-&gt;name));<br><br>fork_mmap(np, p);<br><br>pid = np-&gt;pid;<br></code></pre></td></tr></table></figure><h4 id="å®éªŒæµ‹è¯•"><a href="#å®éªŒæµ‹è¯•" class="headerlink" title="å®éªŒæµ‹è¯•"></a>å®éªŒæµ‹è¯•</h4><p><img src="https://whileskies-pic.oss-cn-beijing.aliyuncs.com/20210708130511.png" alt="image-20210708130504265"></p><h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><p><a href="https://github.com/whileskies/xv6-labs-2020/tree/mmap">https://github.com/whileskies/xv6-labs-2020/tree/mmap</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>os</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2021/07/08/hello-world/"/>
    <url>/2021/07/08/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Hello world</title>
    <link href="/2021/07/08/Hello-world-0/"/>
    <url>/2021/07/08/Hello-world-0/</url>
    
    <content type="html"><![CDATA[<p>æµ‹è¯•ç½‘ç«™</p><p>hhhhh</p><p>ğŸ˜ğŸ˜ğŸ˜</p><p>ğŸ˜€ğŸ˜€ğŸ˜€</p><p>hexo clientæµ‹è¯•</p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
